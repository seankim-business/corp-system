// Prisma Schema for Kyndof Corp System
// Multi-tenant SaaS with Google Workspace integration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE MULTI-TENANT TABLES
// ============================================================================

/// Organizations (Tenants)
/// Each organization represents a separate company/workspace
model Organization {
  id        String   @id @default(uuid()) @db.Uuid
  slug      String   @unique @db.VarChar(50) // Subdomain: kyndof, clientco
  name      String   @db.VarChar(255)
  logoUrl   String?  @map("logo_url") @db.Text
  settings  Json     @default("{}") @db.JsonB
  monthlyBudgetCents     Int?     @map("monthly_budget_cents")
  currentMonthSpendCents Int      @default(0) @map("current_month_spend_cents")
  budgetResetAt          DateTime? @map("budget_reset_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  workspaceDomains       WorkspaceDomain[]
  memberships            Membership[]
  agents                 Agent[]
  teams                  Team[]
  projects               Project[]
  tasks                  Task[]
  goals                  Goal[]
  valueStreams           ValueStream[]
  kpis                   KPI[]
  workflows              Workflow[]
  notionConnections      NotionConnection[]
  mcpConnections         MCPConnection[]
  slackIntegrations      SlackIntegration[]
  orchestratorExecutions OrchestratorExecution[]
  featureFlagOverrides   FeatureFlagOverride[]
  featureFlagAuditLogs   FeatureFlagAuditLog[]

  @@map("organizations")
}

/// Users (Global identity)
/// One user can belong to multiple organizations
model User {
  id            String   @id @default(uuid()) @db.Uuid
  email         String   @unique @db.VarChar(255)
  passwordHash  String?  @map("password_hash") @db.VarChar(255) // NULL for Google-only users
  googleId      String?  @unique @map("google_id") @db.VarChar(255) // Google OAuth sub
  displayName   String?  @map("display_name") @db.VarChar(255)
  avatarUrl     String?  @map("avatar_url") @db.Text
  emailVerified Boolean  @default(false) @map("email_verified")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  memberships            Membership[]
  sessions               Session[]
  orchestratorExecutions OrchestratorExecution[]
  featureFlagAuditLogs   FeatureFlagAuditLog[]

  @@index([email])
  @@index([googleId])
  @@map("users")
}

/// Memberships (User ↔ Organization relationship)
/// Defines user's role and permissions within an organization
model Membership {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  role           String    @db.VarChar(50) // owner, admin, member
  permissions    Json      @default("{}") @db.JsonB
  invitedBy      String?   @map("invited_by") @db.Uuid
  invitedAt      DateTime  @default(now()) @map("invited_at") @db.Timestamptz(6)
  joinedAt       DateTime? @map("joined_at") @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Daily briefing preferences
  dailyBriefingEnabled  Boolean @default(false) @map("daily_briefing_enabled")
  dailyBriefingTime     String  @default("09:00") @map("daily_briefing_time") @db.VarChar(5)
  dailyBriefingTimezone String  @default("UTC") @map("daily_briefing_timezone") @db.VarChar(50)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("memberships")
}

/// Workspace Domains (Google Workspace domains)
/// Links Google Workspace domains to organizations
model WorkspaceDomain {
  id                String    @id @default(uuid()) @db.Uuid
  organizationId    String    @map("organization_id") @db.Uuid
  domain            String    @unique @db.VarChar(255) // nubabel.com, client-company.com
  verified          Boolean   @default(false)
  verificationToken String?   @map("verification_token") @db.VarChar(255)
  verifiedAt        DateTime? @map("verified_at") @db.Timestamptz(6)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, domain])
  @@index([organizationId])
  @@index([domain])
  @@map("workspace_domains")
}

/// Sessions (Enhanced for Orchestrator + JWT)
/// Tracks both authentication sessions AND orchestrator conversation sessions
model Session {
  id             String   @id @db.VarChar(255) // Can be UUID or ses_xxx format
  userId         String   @map("user_id") @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  tokenHash      String?  @unique @map("token_hash") @db.VarChar(255) // NULL for orchestrator sessions
  source         String?  @db.VarChar(50) // slack, web, terminal, api (for orchestrator)
  state          Json     @default("{}") @db.JsonB // Orchestrator state
  history        Json     @default("[]") @db.JsonB // Conversation history
  metadata       Json     @default("{}") @db.JsonB // Additional data
  expiresAt      DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  lastUsedAt     DateTime @default(now()) @map("last_used_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Session hijacking prevention
  ipAddress String? @map("ip_address") @db.VarChar(45)
  userAgent String? @map("user_agent") @db.Text

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@index([source])
  @@map("sessions")
}

// ============================================================================
// AGENT HIERARCHY TABLES (Dynamic Team Management)
// ============================================================================

/// Agents (AI Agents - both permanent and temporary)
model Agent {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  name           String    @db.VarChar(100) // designer-bokyung, pm-killin-it-girl
  type           String    @db.VarChar(50) // permanent, temporary, contractor
  role           String    @db.Text // "K-POP 무대 의상 디자이너"
  managerId      String?   @map("manager_id") @db.Uuid // Reports to which agent
  teamId         String?   @map("team_id") @db.Uuid
  skills         String[]  @db.VarChar(100) // [fashion-design, clo3d, adobe-suite]
  sessionId      String?   @map("session_id") @db.VarChar(255) // Persistent session for continuity
  hiredAt        DateTime  @default(now()) @map("hired_at") @db.Timestamptz(6)
  contractEnd    DateTime? @map("contract_end") @db.Timestamptz(6) // NULL for permanent
  projectId      String?   @map("project_id") @db.Uuid // For project-based agents
  status         String    @default("active") @db.VarChar(50) // active, inactive, archived
  metadata       Json      @default("{}") @db.JsonB
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  manager      Agent?       @relation("AgentHierarchy", fields: [managerId], references: [id])
  subordinates Agent[]      @relation("AgentHierarchy")
  team         Team?        @relation(fields: [teamId], references: [id])

  @@index([organizationId])
  @@index([managerId])
  @@index([teamId])
  @@index([type])
  @@index([status])
  @@map("agents")
}

/// Teams (Groups of agents)
model Team {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String   @db.VarChar(255)
  leaderId       String?  @map("leader_id") @db.Uuid // Team leader
  type           String   @db.VarChar(50) // permanent, temporary, taskforce
  maxMembers     Int?     @map("max_members")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agents       Agent[]

  @@index([organizationId])
  @@map("teams")
}

// ============================================================================
// BUSINESS DATA TABLES (Tenant-scoped)
// ============================================================================

/// Projects
model Project {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  name           String    @db.VarChar(255)
  status         String    @db.VarChar(50)
  ownerId        String?   @map("owner_id") @db.Uuid
  startDate      DateTime? @map("start_date") @db.Date
  dueDate        DateTime? @map("due_date") @db.Date
  progress       Int       @default(0)
  budget         Decimal?  @db.Decimal(15, 2)
  description    String?   @db.Text
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tasks        Task[]

  @@index([organizationId, id])
  @@index([organizationId, createdAt(sort: Desc)])
  @@map("projects")
}

/// Tasks (RABSIC-enabled)
model Task {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @map("organization_id") @db.Uuid
  projectId       String?   @map("project_id") @db.Uuid
  name            String    @db.VarChar(500)
  status          String    @db.VarChar(50) // 1_ToDo, 2_InProgress, 5_Done
  dueDate         DateTime? @map("due_date") @db.Date
  urgencyScore    Int?      @default(0) @map("urgency_score")
  importanceScore Int?      @default(0) @map("importance_score")
  eisenhowerQuad  String?   @map("eisenhower_quadrant") @db.VarChar(50)

  // RABSIC fields
  responsible String[] @db.Uuid
  accountable String[] @db.Uuid // Must be exactly 1
  backup      String[] @db.Uuid
  support     String[] @db.Uuid
  informed    String[] @db.Uuid
  consulted   String[] @db.Uuid

  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project?     @relation(fields: [projectId], references: [id])

  @@index([organizationId, id])
  @@index([organizationId, status])
  @@index([organizationId, dueDate])
  @@map("tasks")
}

/// Goals (Hierarchical)
model Goal {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @map("organization_id") @db.Uuid
  title           String    @db.VarChar(500)
  status          String    @db.VarChar(50)
  ownerPositionId String?   @map("owner_position_id") @db.Uuid
  dueDate         DateTime? @map("due_date") @db.Date
  progress        Int       @default(0)
  parentGoalId    String?   @map("parent_goal_id") @db.Uuid
  description     String?   @db.Text
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parentGoal   Goal?        @relation("GoalHierarchy", fields: [parentGoalId], references: [id])
  subGoals     Goal[]       @relation("GoalHierarchy")

  @@index([organizationId, id])
  @@index([parentGoalId])
  @@map("goals")
}

/// Value Streams (Business processes)
model ValueStream {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String   @db.VarChar(500)
  functions      String   @db.VarChar(100) // MD, Fashion Design, Marketing, CS, Sales
  type           String   @db.VarChar(50)
  input          String?  @db.Text
  output         String?  @db.Text
  parentId       String?  @map("parent_id") @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parent       ValueStream?  @relation("ValueStreamHierarchy", fields: [parentId], references: [id])
  subStreams   ValueStream[] @relation("ValueStreamHierarchy")

  @@index([organizationId, id])
  @@index([parentId])
  @@map("value_streams")
}

/// KPIs (Key Performance Indicators)
model KPI {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @map("organization_id") @db.Uuid
  name            String    @db.VarChar(255)
  status          String    @db.VarChar(50)
  ownerRoleId     String?   @map("owner_role_id") @db.Uuid
  target          String?   @db.VarChar(255)
  currentValue    Decimal?  @map("current_value") @db.Decimal(15, 2)
  unit            String?   @db.VarChar(50)
  updateFrequency String?   @map("update_frequency") @db.VarChar(50)
  dataSource      String?   @map("data_source") @db.Text
  upToDate        Boolean   @default(true) @map("up_to_date")
  lastUpdated     DateTime? @map("last_updated") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, id])
  @@map("kpis")
}

// ============================================================================
// WORKFLOW AUTOMATION TABLES (Phase 2 Week 3-4)
// ============================================================================

/// Workflows (Automation definitions)
model Workflow {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String   @db.VarChar(255)
  description    String?  @db.Text
  config         Json     @default("{}") @db.JsonB
  enabled        Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // SOP (Standard Operating Procedure) fields
  sopEnabled Boolean @default(false) @map("sop_enabled")
  sopSteps   Json?   @map("sop_steps") @db.JsonB // Array of step definitions

  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  executions   WorkflowExecution[]

  @@index([organizationId])
  @@index([organizationId, enabled])
  @@map("workflows")
}

/// Workflow Executions (Execution history)
model WorkflowExecution {
  id           String    @id @default(uuid()) @db.Uuid
  workflowId   String    @map("workflow_id") @db.Uuid
  status       String    @db.VarChar(50)
  inputData    Json?     @map("input_data") @db.JsonB
  outputData   Json?     @map("output_data") @db.JsonB
  errorMessage String?   @map("error_message") @db.Text
  startedAt    DateTime? @map("started_at") @db.Timestamptz(6)
  completedAt  DateTime? @map("completed_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("workflow_executions")
}

/// Orchestrator Executions (Conversation / delegation history)
/// Separate from WorkflowExecution to avoid mixing automation runs with orchestration.
model OrchestratorExecution {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  userId         String @map("user_id") @db.Uuid
  sessionId      String @map("session_id") @db.VarChar(255)

  category String   @db.VarChar(100)
  skills   String[] @default([]) @db.VarChar(100)
  status   String   @db.VarChar(50)
  duration Int      @default(0)

  inputData    Json?   @map("input_data") @db.JsonB
  outputData   Json?   @map("output_data") @db.JsonB
  errorMessage String? @map("error_message") @db.Text
  metadata     Json?   @default("{}") @db.JsonB

  // SOP execution tracking
  currentStep Int?  @map("current_step")
  stepResults Json? @map("step_results") @db.JsonB

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([sessionId])
  @@index([status])
  @@map("orchestrator_executions")
}

// ============================================================================
// MCP INTEGRATION TABLES (Phase 2 Week 9-12)
// ============================================================================

/// Generic MCP Connections (Organization-level integrations)
/// Supports: Notion, Linear, Jira, Asana, Airtable, etc.
model MCPConnection {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  provider       String    @db.VarChar(100) // notion, linear, jira, asana, airtable, etc.
  namespace      String    @db.VarChar(100) // MCP namespace/scope identifier
  name           String    @db.VarChar(255) // User-friendly name
  config         Json      @db.JsonB // Provider-specific config (API keys, tokens, etc.)
  refreshToken   String?   @map("refresh_token") @db.Text // OAuth refresh token (encrypted)
  expiresAt      DateTime? @map("expires_at") @db.Timestamptz(6) // Token expiration timestamp
  enabled        Boolean   @default(true)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([provider])
  @@index([namespace])
  @@map("mcp_connections")
}

/// Legacy Notion Connections (Backward compatibility)
model NotionConnection {
  id                String   @id @default(uuid()) @db.Uuid
  organizationId    String   @map("organization_id") @db.Uuid
  apiKey            String   @map("api_key") @db.VarChar(255)
  defaultDatabaseId String?  @map("default_database_id") @db.VarChar(255)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId])
  @@index([organizationId])
  @@map("notion_connections")
}

// ============================================================================
// SLACK INTEGRATION TABLES (Phase 2 Week 9-12 - Multi-Tenant)
// ============================================================================

/// Slack Integrations (Per-organization Slack workspaces)
/// Replaces hardcoded SLACK_BOT_TOKEN environment variable
model SlackIntegration {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  workspaceId    String @unique @map("workspace_id") @db.VarChar(50) // Slack Team ID (T01234ABCD)
  workspaceName  String @map("workspace_name") @db.VarChar(255) // Friendly name

  // OAuth tokens (encrypted in application layer before storage)
  botToken String  @map("bot_token") @db.Text // xoxb-... (encrypted)
  appToken String? @map("app_token") @db.Text // xapp-... (encrypted, for Socket Mode)

  // Security
  signingSecret String @map("signing_secret") @db.Text // Webhook verification (encrypted)

  // OAuth metadata
  botUserId String?  @map("bot_user_id") @db.VarChar(50) // U01234ABCD
  scopes    String[] @default([]) @db.VarChar(100) // [app_mentions:read, chat:write, ...]

  // Installation metadata
  installedBy String?  @map("installed_by") @db.Uuid // Which user authorized
  installedAt DateTime @default(now()) @map("installed_at") @db.Timestamptz(6)

  // Status
  enabled         Boolean   @default(true)
  lastHealthCheck DateTime? @map("last_health_check") @db.Timestamptz(6)
  healthStatus    String    @default("unknown") @map("health_status") @db.VarChar(50) // healthy, degraded, offline, unknown

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, workspaceId])
  @@index([organizationId])
  @@index([workspaceId])
  @@index([enabled])
  @@map("slack_integrations")
}

// ==========================================================================
// FEATURE FLAGS (Safe release / rollout)
// ==========================================================================

model FeatureFlag {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique @db.VarChar(100) // e.g. "new_dashboard"
  name        String   @db.VarChar(255)
  description String?  @db.Text
  enabled     Boolean  @default(false) // Global kill switch
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  rules     FeatureFlagRule[]
  overrides FeatureFlagOverride[]
  auditLogs FeatureFlagAuditLog[]

  @@index([key])
  @@map("feature_flags")
}

model FeatureFlagRule {
  id            String @id @default(uuid()) @db.Uuid
  featureFlagId String @map("feature_flag_id") @db.Uuid

  type            String   @db.VarChar(50) // ALLOWLIST | BLOCKLIST | PERCENTAGE
  organizationIds String[] @default([]) @map("organization_ids") @db.Uuid
  percentage      Int      @default(0)
  priority        Int      @default(100)
  enabled         Boolean  @default(true)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  featureFlag FeatureFlag @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)

  @@index([featureFlagId, priority])
  @@index([type])
  @@map("feature_flag_rules")
}

model FeatureFlagOverride {
  id             String @id @default(uuid()) @db.Uuid
  featureFlagId  String @map("feature_flag_id") @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  enabled   Boolean
  reason    String?   @db.Text
  expiresAt DateTime? @map("expires_at") @db.Timestamptz(6)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  featureFlag  FeatureFlag  @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([featureFlagId, organizationId])
  @@index([organizationId])
  @@index([expiresAt])
  @@map("feature_flag_overrides")
}

model FeatureFlagAuditLog {
  id            String @id @default(uuid()) @db.Uuid
  featureFlagId String @map("feature_flag_id") @db.Uuid

  action String @db.VarChar(50) // CREATED | UPDATED | RULE_SET | OVERRIDE_SET | EVALUATED

  organizationId String? @map("organization_id") @db.Uuid
  userId         String? @map("user_id") @db.Uuid
  metadata       Json?   @db.JsonB

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  featureFlag  FeatureFlag   @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([featureFlagId, createdAt(sort: Desc)])
  @@index([organizationId, createdAt(sort: Desc)])
  @@index([action, createdAt(sort: Desc)])
  @@map("feature_flag_audit_logs")
}

// ============================================================================
// AUDIT LOG TABLE (System-wide action tracking)
// ============================================================================

/// AuditLog (Tracks all user/system actions)
model AuditLog {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  action       String  @db.VarChar(100) // user.login, workflow.execute, etc.
  userId       String? @map("user_id") @db.Uuid
  resourceType String? @map("resource_type") @db.VarChar(100)
  resourceId   String? @map("resource_id") @db.VarChar(255)
  details      Json?   @db.JsonB
  ipAddress    String? @map("ip_address") @db.VarChar(45)
  userAgent    String? @map("user_agent") @db.Text
  success      Boolean @default(true)
  errorMessage String? @map("error_message") @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([action, createdAt(sort: Desc)])
  @@index([resourceType, resourceId])
  @@map("audit_logs")
}

// ============================================================================
// APPROVAL WORKFLOW TABLES
// ============================================================================

/// Approvals (Budget, deployment, content approvals)
model Approval {
  id                 String    @id @default(uuid()) @db.Uuid
  organizationId     String    @map("organization_id") @db.Uuid
  requesterId        String    @map("requester_id") @db.Uuid
  approverId         String    @map("approver_id") @db.Uuid
  fallbackApproverId String?   @map("fallback_approver_id") @db.Uuid
  type               String    @db.VarChar(50) // budget, deployment, content
  title              String    @db.VarChar(500)
  description        String    @db.Text
  context            Json?     @db.JsonB
  status             String    @default("pending") @db.VarChar(50) // pending, approved, rejected, expired
  responseNote       String?   @map("response_note") @db.Text
  slackMessageTs     String?   @map("slack_message_ts") @db.VarChar(50)
  slackChannelId     String?   @map("slack_channel_id") @db.VarChar(50)
  expiresAt          DateTime  @map("expires_at") @db.Timestamptz(6)
  respondedAt        DateTime? @map("responded_at") @db.Timestamptz(6)
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId, status])
  @@index([approverId, status])
  @@index([requesterId])
  @@index([expiresAt])
  @@map("approvals")
}

// ============================================================================
// PERMISSION DELEGATION TABLES
// ============================================================================

/// Delegations (Permission transfers between users)
model Delegation {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  delegatorId    String    @map("delegator_id") @db.Uuid
  delegateeId    String    @map("delegatee_id") @db.Uuid
  permissions    String[]  @db.VarChar(100)
  scope          Json?     @db.JsonB
  validFrom      DateTime  @map("valid_from") @db.Timestamptz(6)
  validUntil     DateTime  @map("valid_until") @db.Timestamptz(6)
  reason         String    @db.Text
  revokedAt      DateTime? @map("revoked_at") @db.Timestamptz(6)
  revokedBy      String?   @map("revoked_by") @db.Uuid
  revokedReason  String?   @map("revoked_reason") @db.Text
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId, delegateeId])
  @@index([organizationId, delegatorId])
  @@index([delegateeId, validUntil])
  @@index([validUntil])
  @@map("delegations")
}

/// Agent Permission Overrides (Custom permissions for specific agents)
model AgentPermissionOverride {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  agentId        String   @map("agent_id") @db.Uuid
  readPatterns   String[] @default([]) @map("read_patterns") @db.VarChar(255)
  writePatterns  String[] @default([]) @map("write_patterns") @db.VarChar(255)
  tools          String[] @default([]) @db.VarChar(255)
  restricted     String[] @default([]) @db.VarChar(255)
  approvalRules  Json?    @map("approval_rules") @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([organizationId, agentId])
  @@index([organizationId])
  @@index([agentId])
  @@map("agent_permission_overrides")
}

// ============================================================================
// OKR (OBJECTIVES AND KEY RESULTS) TABLES
// ============================================================================

/// Objectives (OKR Objectives)
model Objective {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  title          String   @db.VarChar(500)
  description    String?  @db.Text
  quarter        String   @db.VarChar(10) // e.g., "2026-Q1"
  ownerId        String   @map("owner_id") @db.Uuid
  status         String   @default("on_track") @db.VarChar(50) // on_track, at_risk, behind
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  keyResults KeyResult[]

  @@index([organizationId, quarter])
  @@index([ownerId])
  @@map("objectives")
}

/// Key Results (OKR Key Results)
model KeyResult {
  id          String   @id @default(uuid()) @db.Uuid
  objectiveId String   @map("objective_id") @db.Uuid
  title       String   @db.VarChar(500)
  target      Float
  current     Float    @default(0)
  unit        String   @db.VarChar(50) // percentage, count, currency, etc.
  ownerId     String?  @map("owner_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  objective Objective @relation(fields: [objectiveId], references: [id], onDelete: Cascade)

  @@index([objectiveId])
  @@index([ownerId])
  @@map("key_results")
}

// ============================================================================
// ORGANIZATION CHANGE MANAGEMENT TABLES
// ============================================================================

/// Organization Changes (Track organizational changes and responses)
model OrganizationChange {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  title          String   @db.VarChar(500)
  description    String   @db.Text
  type           String   @db.VarChar(50) // new_agent, process_modification, integration_update, role_change
  status         String   @default("pending") @db.VarChar(50) // pending, in_progress, completed, cancelled
  impactLevel    String   @default("low") @map("impact_level") @db.VarChar(20) // low, medium, high
  requestedBy    String   @map("requested_by") @db.Uuid
  impactAnalysis String?  @map("impact_analysis") @db.Text
  prUrl          String?  @map("pr_url") @db.Text
  metadata       Json?    @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId, status])
  @@index([requestedBy])
  @@index([type])
  @@index([impactLevel])
  @@map("organization_changes")
}

// ============================================================================
// GOOGLE DRIVE INTEGRATION TABLES
// ============================================================================

/// Drive Connections (Google Drive OAuth connections)
model DriveConnection {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @unique @map("organization_id") @db.Uuid
  accessToken     String    @map("access_token") @db.Text // Encrypted
  refreshToken    String?   @map("refresh_token") @db.Text // Encrypted
  expiresAt       DateTime? @map("expires_at") @db.Timestamptz(6)
  defaultFolderId String?   @map("default_folder_id") @db.VarChar(255)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId])
  @@map("drive_connections")
}

/// Google Calendar Connections (Google Calendar OAuth connections)
model GoogleCalendarConnection {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @unique @map("organization_id") @db.Uuid
  accessToken    String    @map("access_token") @db.Text // Encrypted
  refreshToken   String?   @map("refresh_token") @db.Text // Encrypted
  expiresAt      DateTime? @map("expires_at") @db.Timestamptz(6)
  calendarId     String?   @map("calendar_id") @db.VarChar(255) // Primary calendar ID (usually email)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId])
  @@map("google_calendar_connections")
}

// ============================================================================
// SECURITY TABLES
// ============================================================================

/// Session Hijacking Attempts (Security monitoring)
model SessionHijackingAttempt {
  id             String   @id @default(uuid()) @db.Uuid
  sessionId      String   @map("session_id") @db.VarChar(255)
  userId         String   @map("user_id") @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  type           String   @db.VarChar(50) // ip_change, user_agent_change, suspicious_activity
  mismatchType   String?  @map("mismatch_type") @db.VarChar(50) // ip_mismatch, user_agent_mismatch, both
  originalIp     String?  @map("original_ip") @db.VarChar(45)
  attemptedIp    String?  @map("attempted_ip") @db.VarChar(45)
  originalAgent  String?  @map("original_agent") @db.Text
  attemptedAgent String?  @map("attempted_agent") @db.Text
  blocked        Boolean  @default(true)
  metadata       Json?    @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([sessionId])
  @@index([userId, createdAt(sort: Desc)])
  @@index([organizationId, createdAt(sort: Desc)])
  @@map("session_hijacking_attempts")
}
