// Prisma Schema for Kyndof Corp System
// Multi-tenant SaaS with Google Workspace integration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// SKILL & MCP ECOSYSTEM ENUMS
// ============================================================================

enum ExtensionType {
  extension
  skill
  mcp_server
}

// ============================================================================
// CORE MULTI-TENANT TABLES
// ============================================================================

/// Organizations (Tenants)
/// Each organization represents a separate company/workspace
model Organization {
  id                     String    @id @default(uuid()) @db.Uuid
  slug                   String    @unique @db.VarChar(50) // Subdomain: kyndof, clientco
  name                   String    @db.VarChar(255)
  logoUrl                String?   @map("logo_url") @db.Text
  settings               Json      @default("{}") @db.JsonB
  monthlyBudgetCents     Int?      @map("monthly_budget_cents")
  currentMonthSpendCents Int       @default(0) @map("current_month_spend_cents")
  budgetResetAt          DateTime? @map("budget_reset_at") @db.Timestamptz(6)
  createdAt              DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Marketplace Hub settings - temporarily removed until migration applied
  // installationMode String @default("recommend") @map("installation_mode") @db.VarChar(20) // recommend, auto, manual

  // Relations
  workspaceDomains             WorkspaceDomain[]
  memberships                  Membership[]
  agents                       Agent[]
  teams                        Team[]
  projects                     Project[]
  tasks                        Task[]
  goals                        Goal[]
  valueStreams                 ValueStream[]
  kpis                         KPI[]
  workflows                    Workflow[]
  notionConnections            NotionConnection[]
  mcpConnections               MCPConnection[]
  claudeAccounts               ClaudeAccount[]
  claudeMaxAccounts            ClaudeMaxAccount[]
  slackIntegrations            SlackIntegration[]
  orchestratorExecutions       OrchestratorExecution[]
  agentActivities              AgentActivity[]
  featureFlagOverrides         FeatureFlagOverride[]
  featureFlagAuditLogs         FeatureFlagAuditLog[]
  marketplaceExtensions        MarketplaceExtension[]
  extensionInstallations       ExtensionInstallation[]
  extensionPermissions         ExtensionPermission[]
  skillLearningPatterns        SkillLearningPattern[]
  agentSkillAssignments        AgentSkillAssignment[]
  extensionUsageLogs           ExtensionUsageLog[]
  slackWorkspaces              SlackWorkspace[]
  externalCredentials          ExternalMarketplaceCredential[]
  installationQueue            InstallationQueue[]
  marketplaceSettings          OrganizationMarketplaceSettings?
  n8nInstances                 N8nInstance[]
  n8nWorkflows                 N8nWorkflow[]
  n8nCredentials               N8nCredential[]
  knowledgeNodes               KnowledgeNode[]
  knowledgeEdges               KnowledgeEdge[]
  knowledgeClusters            KnowledgeCluster[]
  entityMemories               EntityMemory[]
  memories                     Memory[]
  feedbackCaptures             FeedbackCapture[]
  // Identity linking relations (ADD THESE)
  externalIdentities           ExternalIdentity[]
  identityLinkSuggestions      IdentityLinkSuggestion[]
  identityLinkAudits           IdentityLinkAudit[]
  identitySettings             IdentitySettings?
  // AR (Agent Resource) Management relations
  agentDepartments             AgentDepartment[]
  agentPositions               AgentPosition[]
  agentAssignments             AgentAssignment[]
  arCostEntries                ARCostEntry[]
  arApprovalRequests           ARApprovalRequest[]
  arApprovalRules              ARApprovalRule[]
  agentDailyReports            AgentDailyReport[]
  goalAlignmentRecords         GoalAlignmentRecord[]
  workloadRebalancing          WorkloadRebalancing[]
  humanAvailability            HumanAvailability[]
  agentCapacity                AgentCapacity[]
  arMeetings                   ARMeeting[]
  arLeaveRequests              ARLeaveRequest[]
  arTeamConfigurations         ARTeamConfiguration[]
  arTeamRecommendations        ARTeamRecommendation[]
  arMetaAgents                 ARMetaAgent[]
  arDepartmentLogs             ARDepartmentLog[]
  humanPositions               HumanPosition[]
  humanAssignments             HumanAssignment[]
  templateEffectivenessRecords TemplateEffectivenessRecord[]
  templateABTests              TemplateABTest[]
  // Mega App relations
  valueStreamArtifacts         ValueStreamArtifact[]
  megaAppModules               MegaAppModule[]
  megaAppRoles                 MegaAppRole[]
  modulePermissions            ModulePermission[]
  featureRequests              FeatureRequest[]
  megaAppTeams                 MegaAppTeam[]
  agentScalingRules            AgentScalingRule[]
  // Resource Registry relations
  resourceProviderConnections  ResourceProviderConnection[]
  resourceMappings             ResourceMapping[]
  resourceLinkedRecords        ResourceLinkedRecord[]
  resourceSyncLogs             ResourceSyncLog[]
  resourceTypeSchemas          ResourceTypeSchema[]
  codeOperations               CodeOperation[]

  @@map("organizations")
}

/// Users (Global identity)
/// One user can belong to multiple organizations
model User {
  id            String   @id @default(uuid()) @db.Uuid
  email         String   @unique @db.VarChar(255)
  passwordHash  String?  @map("password_hash") @db.VarChar(255) // NULL for Google-only users
  googleId      String?  @unique @map("google_id") @db.VarChar(255) // Google OAuth sub
  displayName   String?  @map("display_name") @db.VarChar(255)
  avatarUrl     String?  @map("avatar_url") @db.Text
  emailVerified Boolean  @default(false) @map("email_verified")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  memberships                 Membership[]
  sessions                    Session[]
  orchestratorExecutions      OrchestratorExecution[]
  featureFlagAuditLogs        FeatureFlagAuditLog[]
  slackUsers                  SlackUser[]
  feedbackCaptures            FeedbackCapture[]
  // Identity linking relations (ADD THESE)
  externalIdentities          ExternalIdentity[]       @relation("ExternalIdentities")
  linkedIdentities            ExternalIdentity[]       @relation("IdentityLinkedBy")
  suggestedIdentityLinks      IdentityLinkSuggestion[] @relation("SuggestedIdentityLinks")
  reviewedIdentitySuggestions IdentityLinkSuggestion[] @relation("IdentitySuggestionReviewer")
  identityAuditActions        IdentityLinkAudit[]      @relation("IdentityAuditPerformer")
  // AR (Agent Resource) Management relations
  humanAssignments            HumanAssignment[]
  // Mega App relations
  modulePermissions           ModulePermission[]
  codeOperations              CodeOperation[]

  @@index([email])
  @@index([googleId])
  @@map("users")
}

/// Memberships (User ↔ Organization relationship)
/// Defines user's role and permissions within an organization
model Membership {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  role           String    @db.VarChar(50) // owner, admin, member
  permissions    Json      @default("{}") @db.JsonB
  invitedBy      String?   @map("invited_by") @db.Uuid
  invitedAt      DateTime  @default(now()) @map("invited_at") @db.Timestamptz(6)
  joinedAt       DateTime? @map("joined_at") @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Daily briefing preferences
  dailyBriefingEnabled  Boolean @default(false) @map("daily_briefing_enabled")
  dailyBriefingTime     String  @default("09:00") @map("daily_briefing_time") @db.VarChar(5)
  dailyBriefingTimezone String  @default("UTC") @map("daily_briefing_timezone") @db.VarChar(50)

  // Mega App role assignment
  megaAppRoleId String? @map("mega_app_role_id") @db.Uuid

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  megaAppRole  MegaAppRole? @relation(fields: [megaAppRoleId], references: [id])

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("memberships")
}

/// Workspace Domains (Google Workspace domains)
/// Links Google Workspace domains to organizations
model WorkspaceDomain {
  id                String    @id @default(uuid()) @db.Uuid
  organizationId    String    @map("organization_id") @db.Uuid
  domain            String    @unique @db.VarChar(255) // nubabel.com, client-company.com
  verified          Boolean   @default(false)
  verificationToken String?   @map("verification_token") @db.VarChar(255)
  verifiedAt        DateTime? @map("verified_at") @db.Timestamptz(6)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, domain])
  @@index([organizationId])
  @@index([domain])
  @@map("workspace_domains")
}

/// Sessions (Enhanced for Orchestrator + JWT)
/// Tracks both authentication sessions AND orchestrator conversation sessions
model Session {
  id             String   @id @db.VarChar(255) // Can be UUID or ses_xxx format
  userId         String   @map("user_id") @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  tokenHash      String?  @unique @map("token_hash") @db.VarChar(255) // NULL for orchestrator sessions
  source         String?  @db.VarChar(50) // slack, web, terminal, api (for orchestrator)
  state          Json     @default("{}") @db.JsonB // Orchestrator state
  history        Json     @default("[]") @db.JsonB // Conversation history
  metadata       Json     @default("{}") @db.JsonB // Additional data
  expiresAt      DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  lastUsedAt     DateTime @default(now()) @map("last_used_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Session hijacking prevention
  ipAddress String? @map("ip_address") @db.VarChar(45)
  userAgent String? @map("user_agent") @db.Text

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([organizationId, expiresAt])
  @@index([tokenHash])
  @@index([expiresAt])
  @@index([source])
  @@map("sessions")
}

// ============================================================================
// AGENT HIERARCHY TABLES (Dynamic Team Management)
// ============================================================================

/// Agents (AI Agents - both permanent and temporary)
model Agent {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  name           String    @db.VarChar(100) // designer-bokyung, pm-killin-it-girl
  type           String    @db.VarChar(50) // permanent, temporary, contractor
  role           String    @db.Text // "K-POP 무대 의상 디자이너"
  managerId      String?   @map("manager_id") @db.Uuid // Reports to which agent
  teamId         String?   @map("team_id") @db.Uuid
  skills         String[]  @db.VarChar(100) // [fashion-design, clo3d, adobe-suite]
  sessionId      String?   @map("session_id") @db.VarChar(255) // Persistent session for continuity
  hiredAt        DateTime  @default(now()) @map("hired_at") @db.Timestamptz(6)
  contractEnd    DateTime? @map("contract_end") @db.Timestamptz(6) // NULL for permanent
  projectId      String?   @map("project_id") @db.Uuid // For project-based agents
  status         String    @default("active") @db.VarChar(50) // active, inactive, archived
  metadata       Json      @default("{}") @db.JsonB
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // NEW: Orchestration configuration fields
  displayName     String?   @map("display_name") @db.VarChar(255)
  avatar          String?   @db.Text
  position        String?   @db.VarChar(100)
  department      String?   @db.VarChar(100)
  permissionLevel String    @default("member") @map("permission_level") @db.VarChar(50)
  claudeMdContent String?   @map("claude_md_content") @db.Text
  mcpConfigJson   Json?     @map("mcp_config_json") @db.JsonB
  toolAllowlist   String[]  @default([]) @map("tool_allowlist") @db.VarChar(100)
  toolDenylist    String[]  @default([]) @map("tool_denylist") @db.VarChar(100)
  preferredModel  String?   @map("preferred_model") @db.VarChar(50)
  maxTokenBudget  Int?      @map("max_token_budget")
  maxConcurrency  Int       @default(1) @map("max_concurrency")
  lastActiveAt    DateTime? @map("last_active_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  manager      Agent?       @relation("AgentHierarchy", fields: [managerId], references: [id])
  subordinates Agent[]      @relation("AgentHierarchy")
  team         Team?        @relation(fields: [teamId], references: [id])

  skillAssignments AgentSkillAssignment[]
  credentials      AgentCredential[]
  mcpAssignments   AgentMCPAssignment[]
  executions       AgentExecution[]
  // AR (Agent Resource) Management relations
  arAssignments    AgentAssignment[]
  codeOperations   CodeOperation[]

  @@index([organizationId])
  @@index([managerId])
  @@index([teamId])
  @@index([type])
  @@index([status])
  @@index([department])
  @@map("agents")
}

/// Agent Credentials (OAuth tokens, API keys, etc.)
model AgentCredential {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  agentId        String @map("agent_id") @db.Uuid

  provider       String    @db.VarChar(100)
  name           String    @db.VarChar(255)
  credentialType String    @map("credential_type") @db.VarChar(50)
  encryptedData  String    @map("encrypted_data") @db.Text
  expiresAt      DateTime? @map("expires_at") @db.Timestamptz(6)
  refreshTokenId String?   @map("refresh_token_id") @db.Uuid
  scopes         String[]  @default([]) @db.VarChar(100)
  enabled        Boolean   @default(true)
  lastUsedAt     DateTime? @map("last_used_at") @db.Timestamptz(6)
  lastError      String?   @map("last_error") @db.Text
  metadata       Json      @default("{}") @db.JsonB
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, provider, name])
  @@index([agentId])
  @@index([provider])
  @@map("agent_credentials")
}

/// Agent MCP Assignments (Which MCP tools each agent can use)
model AgentMCPAssignment {
  id                 String   @id @default(uuid()) @db.Uuid
  agentId            String   @map("agent_id") @db.Uuid
  mcpConnectionId    String   @map("mcp_connection_id") @db.Uuid
  allowedTools       String[] @default([]) @map("allowed_tools") @db.VarChar(100)
  deniedTools        String[] @default([]) @map("denied_tools") @db.VarChar(100)
  useAgentCredential Boolean  @default(false) @map("use_agent_credential")
  agentCredentialId  String?  @map("agent_credential_id") @db.Uuid
  enabled            Boolean  @default(true)
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  agent         Agent         @relation(fields: [agentId], references: [id], onDelete: Cascade)
  mcpConnection MCPConnection @relation(fields: [mcpConnectionId], references: [id], onDelete: Cascade)

  @@unique([agentId, mcpConnectionId])
  @@index([agentId])
  @@index([mcpConnectionId])
  @@map("agent_mcp_assignments")
}

/// Agent Executions (Tracks individual agent task executions)
model AgentExecution {
  id                 String    @id @default(uuid()) @db.Uuid
  organizationId     String    @map("organization_id") @db.Uuid
  agentId            String    @map("agent_id") @db.Uuid
  linkedActivityId   String?   @map("linked_activity_id") @db.Uuid
  sessionId          String    @map("session_id") @db.VarChar(255)
  parentExecutionId  String?   @map("parent_execution_id") @db.Uuid
  taskDescription    String    @map("task_description") @db.Text
  status             String    @default("pending") @db.VarChar(50)
  progressPercent    Int       @default(0) @map("progress_percent")
  currentAction      String?   @map("current_action") @db.Text
  configSnapshot     Json      @map("config_snapshot") @db.JsonB
  claudeMaxAccountId String?   @map("claude_max_account_id") @db.Uuid
  startedAt          DateTime? @map("started_at") @db.Timestamptz(6)
  completedAt        DateTime? @map("completed_at") @db.Timestamptz(6)
  durationMs         Int?      @map("duration_ms")
  inputData          Json?     @map("input_data") @db.JsonB
  outputData         Json?     @map("output_data") @db.JsonB
  streamChunks       Json[]    @default([]) @map("stream_chunks") @db.JsonB
  toolCalls          Json[]    @default([]) @map("tool_calls") @db.JsonB
  errorMessage       String?   @map("error_message") @db.Text
  errorType          String?   @map("error_type") @db.VarChar(50)
  slackChannelId     String?   @map("slack_channel_id") @db.VarChar(50)
  slackThreadTs      String?   @map("slack_thread_ts") @db.VarChar(50)
  slackMessageTs     String?   @map("slack_message_ts") @db.VarChar(50)
  metadata           Json      @default("{}") @db.JsonB
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  agent           Agent            @relation(fields: [agentId], references: [id], onDelete: Cascade)
  parentExecution AgentExecution?  @relation("ExecutionHierarchy", fields: [parentExecutionId], references: [id])
  childExecutions AgentExecution[] @relation("ExecutionHierarchy")

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([agentId, createdAt(sort: Desc)])
  @@index([sessionId])
  @@index([status])
  @@index([parentExecutionId])
  @@index([slackChannelId, slackThreadTs])
  @@map("agent_executions")
}

/// Teams (Groups of agents)
model Team {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String   @db.VarChar(255)
  leaderId       String?  @map("leader_id") @db.Uuid // Team leader
  type           String   @db.VarChar(50) // permanent, temporary, taskforce
  maxMembers     Int?     @map("max_members")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agents       Agent[]

  @@index([organizationId])
  @@map("teams")
}

// ============================================================================
// BUSINESS DATA TABLES (Tenant-scoped)
// ============================================================================

/// Projects
model Project {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  name           String    @db.VarChar(255)
  status         String    @db.VarChar(50)
  ownerId        String?   @map("owner_id") @db.Uuid
  startDate      DateTime? @map("start_date") @db.Date
  dueDate        DateTime? @map("due_date") @db.Date
  progress       Int       @default(0)
  budget         Decimal?  @db.Decimal(15, 2)
  description    String?   @db.Text
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tasks        Task[]

  @@index([organizationId, id])
  @@index([organizationId, createdAt(sort: Desc)])
  @@map("projects")
}

/// Tasks (RABSIC-enabled)
model Task {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @map("organization_id") @db.Uuid
  projectId       String?   @map("project_id") @db.Uuid
  name            String    @db.VarChar(500)
  status          String    @db.VarChar(50) // 1_ToDo, 2_InProgress, 5_Done
  dueDate         DateTime? @map("due_date") @db.Date
  urgencyScore    Int?      @default(0) @map("urgency_score")
  importanceScore Int?      @default(0) @map("importance_score")
  eisenhowerQuad  String?   @map("eisenhower_quadrant") @db.VarChar(50)

  // RABSIC fields
  responsible String[] @db.Uuid
  accountable String[] @db.Uuid // Must be exactly 1
  backup      String[] @db.Uuid
  support     String[] @db.Uuid
  informed    String[] @db.Uuid
  consulted   String[] @db.Uuid

  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project?     @relation(fields: [projectId], references: [id])

  @@index([organizationId, id])
  @@index([organizationId, status])
  @@index([organizationId, dueDate])
  @@index([organizationId, projectId])
  @@map("tasks")
}

/// Goals (Hierarchical)
model Goal {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @map("organization_id") @db.Uuid
  title           String    @db.VarChar(500)
  status          String    @db.VarChar(50)
  ownerPositionId String?   @map("owner_position_id") @db.Uuid
  dueDate         DateTime? @map("due_date") @db.Date
  progress        Int       @default(0)
  parentGoalId    String?   @map("parent_goal_id") @db.Uuid
  description     String?   @db.Text
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parentGoal   Goal?        @relation("GoalHierarchy", fields: [parentGoalId], references: [id])
  subGoals     Goal[]       @relation("GoalHierarchy")

  @@index([organizationId, id])
  @@index([parentGoalId])
  @@map("goals")
}

/// Value Streams (Business processes)
model ValueStream {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String   @db.VarChar(500)
  functions      String   @db.VarChar(100) // MD, Fashion Design, Marketing, CS, Sales
  type           String   @db.VarChar(50)
  input          String?  @db.Text
  output         String?  @db.Text
  parentId       String?  @map("parent_id") @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parent       ValueStream?  @relation("ValueStreamHierarchy", fields: [parentId], references: [id])
  subStreams   ValueStream[] @relation("ValueStreamHierarchy")

  @@index([organizationId, id])
  @@index([parentId])
  @@map("value_streams")
}

/// KPIs (Key Performance Indicators)
model KPI {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @map("organization_id") @db.Uuid
  name            String    @db.VarChar(255)
  status          String    @db.VarChar(50)
  ownerRoleId     String?   @map("owner_role_id") @db.Uuid
  target          String?   @db.VarChar(255)
  currentValue    Decimal?  @map("current_value") @db.Decimal(15, 2)
  unit            String?   @db.VarChar(50)
  updateFrequency String?   @map("update_frequency") @db.VarChar(50)
  dataSource      String?   @map("data_source") @db.Text
  upToDate        Boolean   @default(true) @map("up_to_date")
  lastUpdated     DateTime? @map("last_updated") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, id])
  @@map("kpis")
}

// ============================================================================
// WORKFLOW AUTOMATION TABLES (Phase 2 Week 3-4)
// ============================================================================

/// Workflows (Automation definitions)
model Workflow {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String   @db.VarChar(255)
  description    String?  @db.Text
  config         Json     @default("{}") @db.JsonB
  enabled        Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // SOP (Standard Operating Procedure) fields
  sopEnabled Boolean @default(false) @map("sop_enabled")
  sopSteps   Json?   @map("sop_steps") @db.JsonB // Array of step definitions

  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  executions   WorkflowExecution[]

  @@index([organizationId])
  @@index([organizationId, enabled])
  @@map("workflows")
}

/// Workflow Executions (Execution history)
model WorkflowExecution {
  id           String    @id @default(uuid()) @db.Uuid
  workflowId   String    @map("workflow_id") @db.Uuid
  status       String    @db.VarChar(50)
  inputData    Json?     @map("input_data") @db.JsonB
  outputData   Json?     @map("output_data") @db.JsonB
  errorMessage String?   @map("error_message") @db.Text
  startedAt    DateTime? @map("started_at") @db.Timestamptz(6)
  completedAt  DateTime? @map("completed_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("workflow_executions")
}

/// Orchestrator Executions (Conversation / delegation history)
/// Separate from WorkflowExecution to avoid mixing automation runs with orchestration.
model OrchestratorExecution {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  userId         String @map("user_id") @db.Uuid
  sessionId      String @map("session_id") @db.VarChar(255)

  category String   @db.VarChar(100)
  skills   String[] @default([]) @db.VarChar(100)
  status   String   @db.VarChar(50)
  duration Int      @default(0)

  inputData    Json?   @map("input_data") @db.JsonB
  outputData   Json?   @map("output_data") @db.JsonB
  errorMessage String? @map("error_message") @db.Text
  metadata     Json?   @default("{}") @db.JsonB

  // SOP execution tracking
  currentStep Int?  @map("current_step")
  stepResults Json? @map("step_results") @db.JsonB

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([organizationId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@index([sessionId])
  @@index([status])
  @@map("orchestrator_executions")
}

/// Agent Activity (Real-time agent execution tracking for visibility)
/// Tracks OMC agent activity for display in Slack and Web UI
model AgentActivity {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  // Agent identification
  agentType        String  @map("agent_type") @db.VarChar(100) // sisyphus, oracle, explore, librarian, executor, etc.
  agentName        String? @map("agent_name") @db.VarChar(255) // Human-readable name
  sessionId        String? @map("session_id") @db.VarChar(255) // OMC session ID
  parentActivityId String? @map("parent_activity_id") @db.Uuid // For nested delegations

  // Task details
  taskDescription String?  @map("task_description") @db.Text
  category        String?  @db.VarChar(100) // quick, ultrabrain, visual-engineering, etc.
  skills          String[] @default([]) @db.VarChar(100) // Skills loaded for this task

  // Status tracking
  status      String  @default("pending") @db.VarChar(50) // pending, running, completed, failed, cancelled
  progress    Int     @default(0) // 0-100 percent
  currentStep String? @map("current_step") @db.Text // What the agent is currently doing

  // Timing
  startedAt   DateTime? @map("started_at") @db.Timestamptz(6)
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)
  durationMs  Int?      @map("duration_ms")

  // Input/Output data
  inputData  Json? @map("input_data") @db.JsonB
  outputData Json? @map("output_data") @db.JsonB

  // Results
  result       Json?   @db.JsonB // Final result/output
  errorMessage String? @map("error_message") @db.Text

  // Slack visibility
  slackChannelId String? @map("slack_channel_id") @db.VarChar(50)
  slackThreadTs  String? @map("slack_thread_ts") @db.VarChar(50)
  slackMessageTs String? @map("slack_message_ts") @db.VarChar(50) // For updating messages

  // Claude Max account used (for quota tracking)
  claudeMaxAccountId String? @map("claude_max_account_id") @db.Uuid

  metadata  Json     @default("{}") @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parentActivity  AgentActivity?  @relation("AgentActivityHierarchy", fields: [parentActivityId], references: [id])
  childActivities AgentActivity[] @relation("AgentActivityHierarchy")

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([organizationId, status])
  @@index([sessionId])
  @@index([agentType])
  @@index([status])
  @@index([parentActivityId])
  @@index([slackChannelId, slackThreadTs])
  @@map("agent_activities")
}

// ============================================================================
// MCP INTEGRATION TABLES (Phase 2 Week 9-12)
// ============================================================================

/// Generic MCP Connections (Organization-level integrations)
/// Supports: Notion, Linear, Jira, Asana, Airtable, etc.
model MCPConnection {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  provider       String    @db.VarChar(100) // notion, linear, jira, asana, airtable, etc.
  namespace      String    @db.VarChar(100) // MCP namespace/scope identifier
  name           String    @db.VarChar(255) // User-friendly name
  config         Json      @db.JsonB // Provider-specific config (API keys, tokens, etc.)
  refreshToken   String?   @map("refresh_token") @db.Text // OAuth refresh token (encrypted)
  expiresAt      DateTime? @map("expires_at") @db.Timestamptz(6) // Token expiration timestamp
  enabled        Boolean   @default(true)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization     Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agentAssignments AgentMCPAssignment[]

  @@index([organizationId])
  @@index([organizationId, enabled])
  @@index([provider])
  @@index([namespace])
  @@map("mcp_connections")
}

/// Claude Accounts (Per-account circuit breaker state)
/// Tracks API health and circuit breaker status for individual Claude accounts
model ClaudeAccount {
  id                  String    @id @default(uuid()) @db.Uuid
  organizationId      String    @map("organization_id") @db.Uuid
  name                String    @db.VarChar(255)
  status              String    @default("active") @db.VarChar(50)
  consecutiveFailures Int       @default(0) @map("consecutive_failures")
  halfOpenSuccesses   Int       @default(0) @map("half_open_successes")
  circuitOpensAt      DateTime? @map("circuit_opens_at") @db.Timestamptz(6)
  lastFailureAt       DateTime? @map("last_failure_at") @db.Timestamptz(6)
  lastFailureReason   String?   @map("last_failure_reason") @db.Text
  lastSuccessAt       DateTime? @map("last_success_at") @db.Timestamptz(6)
  metadata            Json      @default("{}") @db.JsonB
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  quotaAlerts  QuotaAlert[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([status])
  @@index([circuitOpensAt])
  @@map("claude_accounts")
}

model QuotaAlert {
  id           String    @id @default(uuid()) @db.Uuid
  accountId    String    @map("account_id") @db.Uuid
  type         String    @db.VarChar(50)
  severity     String    @db.VarChar(20)
  message      String    @db.Text
  currentValue Int       @map("current_value")
  limit        Int
  percentage   Float
  quotaType    String    @map("quota_type") @db.VarChar(50)
  resolvedAt   DateTime? @map("resolved_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  account ClaudeAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([type])
  @@index([severity])
  @@index([resolvedAt])
  @@index([createdAt(sort: Desc)])
  @@map("quota_alerts")
}

/// Claude Max Subscription Accounts (Consumer accounts running via CLI)
/// These are NOT API accounts - they use Claude CLI with subscription limits
model ClaudeMaxAccount {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  // Account identification
  nickname String @db.VarChar(100) // e.g., "work", "personal", "backup-1"
  email    String @db.VarChar(255) // Claude account email

  // Status tracking (no direct API - inferred from CLI behavior)
  status String @default("active") @db.VarChar(50) // active, rate_limited, exhausted, cooldown

  // Usage estimation (tracked from CLI output/errors)
  estimatedUsagePercent Float     @default(0) @map("estimated_usage_percent") // 0-100
  lastUsageUpdateAt     DateTime? @map("last_usage_update_at") @db.Timestamptz(6)
  estimatedResetAt      DateTime? @map("estimated_reset_at") @db.Timestamptz(6) // When quota resets

  // Session tracking for c2switcher-style rotation
  currentSessionId String?   @map("current_session_id") @db.VarChar(255)
  lastActiveAt     DateTime? @map("last_active_at") @db.Timestamptz(6)

  // Rate limit detection
  consecutiveRateLimits Int       @default(0) @map("consecutive_rate_limits")
  lastRateLimitAt       DateTime? @map("last_rate_limit_at") @db.Timestamptz(6)
  cooldownUntil         DateTime? @map("cooldown_until") @db.Timestamptz(6)

  // Priority for selection algorithm (higher = prefer)
  priority Int @default(100)

  // Encrypted credentials storage reference (stored separately)
  credentialRef String? @map("credential_ref") @db.VarChar(255)

  metadata  Json     @default("{}") @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, nickname])
  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([status])
  @@index([priority])
  @@index([cooldownUntil])
  @@map("claude_max_accounts")
}

/// Notion Connections (supports OAuth and legacy API key)
model NotionConnection {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  apiKey         String @default("") @map("api_key") @db.VarChar(255) // Legacy API key (empty when using OAuth)

  // OAuth fields (filled after OAuth flow)
  accessToken   String?   @map("access_token") @db.Text // OAuth access token (encrypted)
  botId         String?   @map("bot_id") @db.VarChar(100)
  workspaceId   String?   @map("workspace_id") @db.VarChar(100)
  workspaceName String?   @map("workspace_name") @db.VarChar(255)
  workspaceIcon String?   @map("workspace_icon") @db.Text
  connectedAt   DateTime? @map("connected_at") @db.Timestamptz(6)

  defaultDatabaseId String?  @map("default_database_id") @db.VarChar(255)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId])
  @@index([organizationId])
  @@map("notion_connections")
}

// ============================================================================
// SLACK INTEGRATION TABLES (Phase 2 Week 9-12 - Multi-Tenant)
// ============================================================================

/// Slack Integrations (Per-organization Slack workspaces)
/// Supports BYOA (Bring Your Own App) - organizations provide their own Slack App credentials
model SlackIntegration {
  id             String  @id @default(uuid()) @db.Uuid
  organizationId String  @unique @map("organization_id") @db.Uuid
  workspaceId    String? @unique @map("workspace_id") @db.VarChar(50) // Slack Team ID (T01234ABCD) - filled after OAuth
  workspaceName  String? @map("workspace_name") @db.VarChar(255) // Friendly name - filled after OAuth

  // Slack App credentials (BYOA - encrypted)
  clientId     String? @map("client_id") @db.Text // Slack App Client ID (encrypted)
  clientSecret String? @map("client_secret") @db.Text // Slack App Client Secret (encrypted)

  // OAuth tokens (encrypted in application layer before storage) - filled after OAuth
  botToken String? @map("bot_token") @db.Text // xoxb-... (encrypted)
  appToken String? @map("app_token") @db.Text // xapp-... (encrypted, for Socket Mode)

  // Security
  signingSecret String? @map("signing_secret") @db.Text // Webhook verification (encrypted)

  // OAuth metadata
  botUserId String?  @map("bot_user_id") @db.VarChar(50) // U01234ABCD
  scopes    String[] @default([]) @db.VarChar(100) // [app_mentions:read, chat:write, ...]

  // Installation metadata
  installedBy String?  @map("installed_by") @db.Uuid // Which user authorized
  installedAt DateTime @default(now()) @map("installed_at") @db.Timestamptz(6)

  // Status
  enabled         Boolean   @default(true)
  lastHealthCheck DateTime? @map("last_health_check") @db.Timestamptz(6)
  healthStatus    String    @default("unknown") @map("health_status") @db.VarChar(50) // healthy, degraded, offline, unknown

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([workspaceId])
  @@index([enabled])
  @@map("slack_integrations")
}

// ==========================================================================
// FEATURE FLAGS (Safe release / rollout)
// ==========================================================================

model FeatureFlag {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique @db.VarChar(100) // e.g. "new_dashboard"
  name        String   @db.VarChar(255)
  description String?  @db.Text
  enabled     Boolean  @default(false) // Global kill switch
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  rules     FeatureFlagRule[]
  overrides FeatureFlagOverride[]
  auditLogs FeatureFlagAuditLog[]

  @@index([key])
  @@map("feature_flags")
}

model FeatureFlagRule {
  id            String @id @default(uuid()) @db.Uuid
  featureFlagId String @map("feature_flag_id") @db.Uuid

  type            String   @db.VarChar(50) // ALLOWLIST | BLOCKLIST | PERCENTAGE
  organizationIds String[] @default([]) @map("organization_ids") @db.Uuid
  percentage      Int      @default(0)
  priority        Int      @default(100)
  enabled         Boolean  @default(true)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  featureFlag FeatureFlag @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)

  @@index([featureFlagId, priority])
  @@index([enabled, priority])
  @@index([type])
  @@map("feature_flag_rules")
}

model FeatureFlagOverride {
  id             String @id @default(uuid()) @db.Uuid
  featureFlagId  String @map("feature_flag_id") @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  enabled   Boolean
  reason    String?   @db.Text
  expiresAt DateTime? @map("expires_at") @db.Timestamptz(6)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  featureFlag  FeatureFlag  @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([featureFlagId, organizationId])
  @@index([organizationId])
  @@index([expiresAt])
  @@map("feature_flag_overrides")
}

model FeatureFlagAuditLog {
  id            String @id @default(uuid()) @db.Uuid
  featureFlagId String @map("feature_flag_id") @db.Uuid

  action String @db.VarChar(50) // CREATED | UPDATED | RULE_SET | OVERRIDE_SET | EVALUATED

  organizationId String? @map("organization_id") @db.Uuid
  userId         String? @map("user_id") @db.Uuid
  metadata       Json?   @db.JsonB

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  featureFlag  FeatureFlag   @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([featureFlagId, createdAt(sort: Desc)])
  @@index([organizationId, createdAt(sort: Desc)])
  @@index([action, createdAt(sort: Desc)])
  @@map("feature_flag_audit_logs")
}

// ============================================================================
// AUDIT LOG TABLE (System-wide action tracking)
// ============================================================================

/// AuditLog (Tracks all user/system actions)
model AuditLog {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  action       String  @db.VarChar(100) // user.login, workflow.execute, etc.
  userId       String? @map("user_id") @db.Uuid
  resourceType String? @map("resource_type") @db.VarChar(100)
  resourceId   String? @map("resource_id") @db.VarChar(255)
  details      Json?   @db.JsonB
  ipAddress    String? @map("ip_address") @db.VarChar(45)
  userAgent    String? @map("user_agent") @db.Text
  success      Boolean @default(true)
  errorMessage String? @map("error_message") @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([action, createdAt(sort: Desc)])
  @@index([resourceType, resourceId])
  @@map("audit_logs")
}

// ============================================================================
// APPROVAL WORKFLOW TABLES
// ============================================================================

/// Approvals (Budget, deployment, content approvals)
model Approval {
  id                 String    @id @default(uuid()) @db.Uuid
  organizationId     String    @map("organization_id") @db.Uuid
  requesterId        String    @map("requester_id") @db.Uuid
  approverId         String    @map("approver_id") @db.Uuid
  fallbackApproverId String?   @map("fallback_approver_id") @db.Uuid
  type               String    @db.VarChar(50) // budget, deployment, content
  title              String    @db.VarChar(500)
  description        String    @db.Text
  context            Json?     @db.JsonB
  status             String    @default("pending") @db.VarChar(50) // pending, approved, rejected, expired
  responseNote       String?   @map("response_note") @db.Text
  slackMessageTs     String?   @map("slack_message_ts") @db.VarChar(50)
  slackChannelId     String?   @map("slack_channel_id") @db.VarChar(50)
  expiresAt          DateTime  @map("expires_at") @db.Timestamptz(6)
  respondedAt        DateTime? @map("responded_at") @db.Timestamptz(6)
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId, status])
  @@index([approverId, status])
  @@index([fallbackApproverId])
  @@index([requesterId])
  @@index([expiresAt])
  @@map("approvals")
}

// ============================================================================
// PERMISSION DELEGATION TABLES
// ============================================================================

/// Delegations (Permission transfers between users)
model Delegation {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  delegatorId    String    @map("delegator_id") @db.Uuid
  delegateeId    String    @map("delegatee_id") @db.Uuid
  permissions    String[]  @db.VarChar(100)
  scope          Json?     @db.JsonB
  validFrom      DateTime  @map("valid_from") @db.Timestamptz(6)
  validUntil     DateTime  @map("valid_until") @db.Timestamptz(6)
  reason         String    @db.Text
  revokedAt      DateTime? @map("revoked_at") @db.Timestamptz(6)
  revokedBy      String?   @map("revoked_by") @db.Uuid
  revokedReason  String?   @map("revoked_reason") @db.Text
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId, delegateeId])
  @@index([organizationId, delegatorId])
  @@index([delegateeId, validUntil])
  @@index([validUntil])
  @@map("delegations")
}

/// Agent Permission Overrides (Custom permissions for specific agents)
model AgentPermissionOverride {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  agentId        String   @map("agent_id") @db.Uuid
  readPatterns   String[] @default([]) @map("read_patterns") @db.VarChar(255)
  writePatterns  String[] @default([]) @map("write_patterns") @db.VarChar(255)
  tools          String[] @default([]) @db.VarChar(255)
  restricted     String[] @default([]) @db.VarChar(255)
  approvalRules  Json?    @map("approval_rules") @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([organizationId, agentId])
  @@index([organizationId])
  @@index([agentId])
  @@map("agent_permission_overrides")
}

// ============================================================================
// OKR (OBJECTIVES AND KEY RESULTS) TABLES
// ============================================================================

/// Objectives (OKR Objectives)
model Objective {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  title          String   @db.VarChar(500)
  description    String?  @db.Text
  quarter        String   @db.VarChar(10) // e.g., "2026-Q1"
  ownerId        String   @map("owner_id") @db.Uuid
  status         String   @default("on_track") @db.VarChar(50) // on_track, at_risk, behind
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  keyResults KeyResult[]

  @@index([organizationId, quarter])
  @@index([ownerId])
  @@map("objectives")
}

/// Key Results (OKR Key Results)
model KeyResult {
  id          String   @id @default(uuid()) @db.Uuid
  objectiveId String   @map("objective_id") @db.Uuid
  title       String   @db.VarChar(500)
  target      Float
  current     Float    @default(0)
  unit        String   @db.VarChar(50) // percentage, count, currency, etc.
  ownerId     String?  @map("owner_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  objective Objective @relation(fields: [objectiveId], references: [id], onDelete: Cascade)

  @@index([objectiveId])
  @@index([ownerId])
  @@map("key_results")
}

// ============================================================================
// ORGANIZATION CHANGE MANAGEMENT TABLES
// ============================================================================

/// Organization Changes (Track organizational changes and responses)
model OrganizationChange {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  title          String   @db.VarChar(500)
  description    String   @db.Text
  type           String   @db.VarChar(50) // new_agent, process_modification, integration_update, role_change
  status         String   @default("pending") @db.VarChar(50) // pending, in_progress, completed, cancelled
  impactLevel    String   @default("low") @map("impact_level") @db.VarChar(20) // low, medium, high
  requestedBy    String   @map("requested_by") @db.Uuid
  impactAnalysis String?  @map("impact_analysis") @db.Text
  prUrl          String?  @map("pr_url") @db.Text
  metadata       Json?    @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId, status])
  @@index([requestedBy])
  @@index([type])
  @@index([impactLevel])
  @@map("organization_changes")
}

// ============================================================================
// GOOGLE DRIVE INTEGRATION TABLES
// ============================================================================

/// Drive Connections (Google Drive OAuth connections)
model DriveConnection {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @unique @map("organization_id") @db.Uuid
  accessToken     String    @map("access_token") @db.Text // Encrypted
  refreshToken    String?   @map("refresh_token") @db.Text // Encrypted
  expiresAt       DateTime? @map("expires_at") @db.Timestamptz(6)
  defaultFolderId String?   @map("default_folder_id") @db.VarChar(255)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId])
  @@map("drive_connections")
}

/// Google Calendar Connections (Google Calendar OAuth connections)
model GoogleCalendarConnection {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @unique @map("organization_id") @db.Uuid
  accessToken    String    @map("access_token") @db.Text // Encrypted
  refreshToken   String?   @map("refresh_token") @db.Text // Encrypted
  expiresAt      DateTime? @map("expires_at") @db.Timestamptz(6)
  calendarId     String?   @map("calendar_id") @db.VarChar(255) // Primary calendar ID (usually email)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId])
  @@map("google_calendar_connections")
}

// ============================================================================
// SECURITY TABLES
// ============================================================================

/// Session Hijacking Attempts (Security monitoring)
model SessionHijackingAttempt {
  id             String   @id @default(uuid()) @db.Uuid
  sessionId      String   @map("session_id") @db.VarChar(255)
  userId         String   @map("user_id") @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  type           String   @db.VarChar(50) // ip_change, user_agent_change, suspicious_activity
  mismatchType   String?  @map("mismatch_type") @db.VarChar(50) // ip_mismatch, user_agent_mismatch, both
  originalIp     String?  @map("original_ip") @db.VarChar(45)
  attemptedIp    String?  @map("attempted_ip") @db.VarChar(45)
  originalAgent  String?  @map("original_agent") @db.Text
  attemptedAgent String?  @map("attempted_agent") @db.Text
  blocked        Boolean  @default(true)
  metadata       Json?    @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([sessionId])
  @@index([userId, createdAt(sort: Desc)])
  @@index([organizationId, createdAt(sort: Desc)])
  @@map("session_hijacking_attempts")
}

// ============================================================================
// SKILL & MCP ECOSYSTEM TABLES
// ============================================================================

/// MarketplaceExtension - Unified marketplace item for extensions/skills/MCP servers
model MarketplaceExtension {
  id             String  @id @default(uuid()) @db.Uuid
  organizationId String? @map("organization_id") @db.Uuid

  slug        String @db.VarChar(100)
  name        String @db.VarChar(255)
  description String @db.Text
  version     String @db.VarChar(20)

  extensionType ExtensionType @default(extension) @map("extension_type")
  category      String        @db.VarChar(50)
  tags          String[]      @default([]) @db.VarChar(50)

  source     String? @db.VarChar(50)
  format     String? @db.VarChar(20)
  manifest   Json    @default("{}") @db.JsonB
  definition Json?   @db.JsonB

  runtimeType   String?  @map("runtime_type") @db.VarChar(30)
  runtimeConfig Json?    @map("runtime_config") @db.JsonB
  triggers      String[] @default([]) @db.VarChar(100)
  parameters    Json     @default("[]") @db.JsonB
  outputs       Json     @default("[]") @db.JsonB
  dependencies  String[] @default([]) @db.VarChar(100)
  toolsRequired String[] @default([]) @map("tools_required") @db.VarChar(100)
  mcpProviders  String[] @default([]) @map("mcp_providers") @db.VarChar(50)
  megaAppConfig Json?    @map("mega_app_config") @db.JsonB // MegaApp module configuration

  publisherId String? @map("publisher_id") @db.Uuid
  isPublic    Boolean @default(false) @map("is_public")
  verified    Boolean @default(false)
  downloads   Int     @default(0)
  rating      Float?  @db.Real
  ratingCount Int     @default(0) @map("rating_count")

  status  String  @default("active") @db.VarChar(20)
  enabled Boolean @default(true)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy String?  @map("created_by") @db.Uuid

  organization     Organization?           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  publisher        ExtensionPublisher?     @relation(fields: [publisherId], references: [id])
  versions         ExtensionVersion[]
  installations    ExtensionInstallation[]
  usageLogs        ExtensionUsageLog[]
  permissions      ExtensionPermission[]
  agentAssignments AgentSkillAssignment[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([extensionType])
  @@index([category])
  @@index([isPublic, status])
  @@map("marketplace_extensions")
}

/// ExtensionVersion - Version history
model ExtensionVersion {
  id          String  @id @default(uuid()) @db.Uuid
  extensionId String  @map("extension_id") @db.Uuid
  version     String  @db.VarChar(20)
  manifest    Json    @db.JsonB
  definition  Json?   @db.JsonB
  changelog   String? @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy String?  @map("created_by") @db.Uuid

  extension MarketplaceExtension @relation(fields: [extensionId], references: [id], onDelete: Cascade)

  @@unique([extensionId, version])
  @@index([extensionId])
  @@map("extension_versions")
}

/// ExtensionInstallation - Org-level installations
model ExtensionInstallation {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  extensionId    String @map("extension_id") @db.Uuid
  version        String @db.VarChar(20)

  configOverrides Json? @map("config_overrides") @db.JsonB
  credentials     Json? @db.JsonB

  status     String  @default("active") @db.VarChar(20)
  autoUpdate Boolean @default(true) @map("auto_update")

  installedAt DateTime @default(now()) @map("installed_at") @db.Timestamptz(6)
  installedBy String   @map("installed_by") @db.Uuid
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  extension    MarketplaceExtension @relation(fields: [extensionId], references: [id], onDelete: Cascade)

  @@unique([organizationId, extensionId])
  @@index([organizationId])
  @@index([extensionId])
  @@map("extension_installations")
}

/// ExtensionPublisher - Publisher accounts
model ExtensionPublisher {
  id             String  @id @default(uuid()) @db.Uuid
  organizationId String? @map("organization_id") @db.Uuid

  name        String  @db.VarChar(255)
  slug        String  @unique @db.VarChar(100)
  description String? @db.Text
  website     String? @db.Text
  verified    Boolean @default(false)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  extensions MarketplaceExtension[]
  payouts    PublisherPayout[]

  @@index([organizationId])
  @@map("extension_publishers")
}

/// ExtensionPermission - Access control
model ExtensionPermission {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  extensionId String? @map("extension_id") @db.Uuid
  category    String? @db.VarChar(50)

  agentId String? @map("agent_id") @db.Uuid
  roleId  String? @map("role_id") @db.VarChar(50)

  canExecute   Boolean @default(true) @map("can_execute")
  canConfigure Boolean @default(false) @map("can_configure")
  canInstall   Boolean @default(false) @map("can_install")

  allowedTools String[] @default([]) @map("allowed_tools") @db.VarChar(100)
  deniedTools  String[] @default([]) @map("denied_tools") @db.VarChar(100)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  extension    MarketplaceExtension? @relation(fields: [extensionId], references: [id], onDelete: Cascade)
  organization Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([extensionId])
  @@index([agentId])
  @@map("extension_permissions")
}

/// ExtensionUsageLog - Execution history
model ExtensionUsageLog {
  id             String  @id @default(uuid()) @db.Uuid
  organizationId String  @map("organization_id") @db.Uuid
  extensionId    String  @map("extension_id") @db.Uuid
  agentId        String? @map("agent_id") @db.Uuid
  sessionId      String? @map("session_id") @db.VarChar(255)

  executionId String @map("execution_id") @db.Uuid
  status      String @db.VarChar(20)
  durationMs  Int    @map("duration_ms")

  errorCode    String? @map("error_code") @db.VarChar(50)
  errorMessage String? @map("error_message") @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  extension    MarketplaceExtension @relation(fields: [extensionId], references: [id], onDelete: Cascade)
  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([extensionId])
  @@map("extension_usage_logs")
}

/// SkillLearningPattern - Pattern detection for skill generation
model SkillLearningPattern {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  patternHash String @map("pattern_hash") @db.VarChar(64)
  patternType String @map("pattern_type") @db.VarChar(30)
  steps       Json   @db.JsonB
  frequency   Int    @default(1)

  triggerPhrases String[] @default([]) @map("trigger_phrases") @db.Text
  contextTags    String[] @default([]) @map("context_tags") @db.VarChar(50)

  status String @default("detected") @db.VarChar(20)

  firstSeenAt DateTime @default(now()) @map("first_seen_at") @db.Timestamptz(6)
  lastSeenAt  DateTime @default(now()) @map("last_seen_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, patternHash])
  @@index([organizationId])
  @@index([status])
  @@map("skill_learning_patterns")
}

/// AgentSkillAssignment - Agent-specific skill configurations
model AgentSkillAssignment {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  agentId        String @map("agent_id") @db.Uuid
  extensionId    String @map("extension_id") @db.Uuid

  assignmentType  String  @map("assignment_type") @db.VarChar(20)
  enabled         Boolean @default(true)
  priority        Int     @default(100)
  configOverrides Json?   @map("config_overrides") @db.JsonB

  successCount Int @default(0) @map("success_count")
  failureCount Int @default(0) @map("failure_count")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  agent        Agent                @relation(fields: [agentId], references: [id], onDelete: Cascade)
  extension    MarketplaceExtension @relation(fields: [extensionId], references: [id], onDelete: Cascade)
  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([agentId, extensionId])
  @@index([organizationId])
  @@index([agentId])
  @@map("agent_skill_assignments")
}

/// MarketplaceCategory - Extension categories and subcategories
model MarketplaceCategory {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @db.VarChar(100)
  slug        String  @unique @db.VarChar(100)
  description String? @db.Text
  icon        String? @db.VarChar(100) // Icon name or emoji
  parentId    String? @map("parent_id") @db.Uuid // Self-reference for subcategories
  sortOrder   Int     @default(0) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  parent        MarketplaceCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  subcategories MarketplaceCategory[] @relation("CategoryHierarchy")

  @@index([parentId])
  @@index([sortOrder])
  @@map("marketplace_categories")
}

/// ExtensionReview - User reviews for marketplace extensions
model ExtensionReview {
  id          String  @id @default(uuid()) @db.Uuid
  extensionId String  @map("extension_id") @db.Uuid
  userId      String  @map("user_id") @db.Uuid
  rating      Int // 1-5 stars
  title       String? @db.VarChar(255)
  content     String? @db.Text
  isVerified  Boolean @default(false) @map("is_verified") // Verified purchase

  helpfulCount   Int @default(0) @map("helpful_count")
  unhelpfulCount Int @default(0) @map("unhelpful_count")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  helpfulVotes ReviewHelpfulVote[]

  @@unique([extensionId, userId]) // One review per user per extension
  @@index([extensionId])
  @@index([userId])
  @@index([rating])
  @@map("extension_reviews")
}

/// ReviewHelpfulVote - Votes on extension reviews
model ReviewHelpfulVote {
  id        String  @id @default(uuid()) @db.Uuid
  reviewId  String  @map("review_id") @db.Uuid
  userId    String  @map("user_id") @db.Uuid
  isHelpful Boolean @map("is_helpful") // true = helpful, false = not helpful

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  review ExtensionReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId]) // One vote per user per review
  @@index([reviewId])
  @@map("review_helpful_votes")
}

/// PublisherPayout - Payment records for extension publishers
model PublisherPayout {
  id            String    @id @default(uuid()) @db.Uuid
  publisherId   String    @map("publisher_id") @db.Uuid
  amount        Int // Amount in cents
  currency      String    @default("usd") @db.VarChar(10)
  status        String    @default("pending") @db.VarChar(50) // pending, processing, completed, failed, cancelled
  paymentMethod String?   @map("payment_method") @db.VarChar(50) // stripe, paypal, bank_transfer
  transactionId String?   @map("transaction_id") @db.VarChar(255) // External payment reference
  periodStart   DateTime? @map("period_start") @db.Timestamptz(6) // Payout period
  periodEnd     DateTime? @map("period_end") @db.Timestamptz(6)
  processedAt   DateTime? @map("processed_at") @db.Timestamptz(6)
  failureReason String?   @map("failure_reason") @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  publisher ExtensionPublisher @relation(fields: [publisherId], references: [id], onDelete: Cascade)

  @@index([publisherId])
  @@index([status])
  @@index([processedAt])
  @@map("publisher_payouts")
}

// ============================================================================
// BILLING & SUBSCRIPTION TABLES
// ============================================================================

/// Subscription (Organization billing subscription)
model Subscription {
  id                   String    @id @default(uuid()) @db.Uuid
  organizationId       String    @unique @map("organization_id") @db.Uuid
  stripeCustomerId     String?   @map("stripe_customer_id") @db.VarChar(255)
  stripeSubscriptionId String?   @map("stripe_subscription_id") @db.VarChar(255)
  plan                 String    @default("free") @db.VarChar(50) // free, starter, pro, enterprise
  status               String    @default("active") @db.VarChar(50) // active, past_due, canceled, trialing
  currentPeriodStart   DateTime? @map("current_period_start") @db.Timestamptz(6)
  currentPeriodEnd     DateTime? @map("current_period_end") @db.Timestamptz(6)
  cancelAtPeriodEnd    Boolean   @default(false) @map("cancel_at_period_end")
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  invoices Invoice[]

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@map("subscriptions")
}

/// Invoice (Billing invoices)
model Invoice {
  id              String    @id @default(uuid()) @db.Uuid
  subscriptionId  String    @map("subscription_id") @db.Uuid
  stripeInvoiceId String?   @unique @map("stripe_invoice_id") @db.VarChar(255)
  amountDue       Int       @map("amount_due") // in cents
  amountPaid      Int       @default(0) @map("amount_paid")
  currency        String    @default("usd") @db.VarChar(10)
  status          String    @default("draft") @db.VarChar(50) // draft, open, paid, void, uncollectible
  invoiceUrl      String?   @map("invoice_url") @db.Text
  pdfUrl          String?   @map("pdf_url") @db.Text
  periodStart     DateTime? @map("period_start") @db.Timestamptz(6)
  periodEnd       DateTime? @map("period_end") @db.Timestamptz(6)
  dueDate         DateTime? @map("due_date") @db.Timestamptz(6)
  paidAt          DateTime? @map("paid_at") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([status])
  @@map("invoices")
}

/// UsageRecord (Track usage for billing)
model UsageRecord {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  sessionId      String?  @map("session_id") @db.VarChar(255)
  model          String   @db.VarChar(100)
  inputTokens    Int      @map("input_tokens")
  outputTokens   Int      @map("output_tokens")
  costCents      Int      @map("cost_cents")
  category       String?  @db.VarChar(50)
  agentId        String?  @map("agent_id") @db.Uuid
  metadata       Json?    @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([organizationId, model])
  @@index([agentId])
  @@map("usage_records")
}

// ============================================================================
// ONBOARDING TABLES
// ============================================================================

/// OnboardingState (Track user onboarding progress)
model OnboardingState {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @unique @map("organization_id") @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  currentStep    String    @default("welcome") @map("current_step") @db.VarChar(50)
  completedSteps String[]  @default([]) @map("completed_steps") @db.VarChar(50)
  skippedSteps   String[]  @default([]) @map("skipped_steps") @db.VarChar(50)
  metadata       Json?     @db.JsonB
  startedAt      DateTime  @default(now()) @map("started_at") @db.Timestamptz(6)
  completedAt    DateTime? @map("completed_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  checklistItems OnboardingChecklistItem[]

  @@index([userId])
  @@map("onboarding_states")
}

/// OnboardingChecklistItem (Individual onboarding tasks)
model OnboardingChecklistItem {
  id                String    @id @default(uuid()) @db.Uuid
  onboardingStateId String    @map("onboarding_state_id") @db.Uuid
  key               String    @db.VarChar(100)
  title             String    @db.VarChar(255)
  description       String?   @db.Text
  category          String?   @db.VarChar(50)
  required          Boolean   @default(false)
  completed         Boolean   @default(false)
  completedAt       DateTime? @map("completed_at") @db.Timestamptz(6)
  metadata          Json?     @db.JsonB
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  onboardingState OnboardingState @relation(fields: [onboardingStateId], references: [id], onDelete: Cascade)

  @@unique([onboardingStateId, key])
  @@index([onboardingStateId])
  @@map("onboarding_checklist_items")
}

// ============================================================================
// PUBLIC API & WEBHOOKS TABLES
// ============================================================================

/// APIKey (Public API keys for external integrations)
model APIKey {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  userId         String    @map("user_id") @db.Uuid // Owner of this API key
  name           String    @db.VarChar(255)
  keyHash        String    @unique @map("key_hash") @db.VarChar(64) // SHA-256 hash of the key
  keyPrefix      String    @map("key_prefix") @db.VarChar(10) // First 8 chars for identification
  scopes         String[]  @default([]) @db.VarChar(100)
  rateLimitTier  String    @default("standard") @map("rate_limit_tier") @db.VarChar(50) // free, standard, premium, unlimited
  isActive       Boolean   @default(true) @map("is_active")
  expiresAt      DateTime? @map("expires_at") @db.Timestamptz(6)
  lastUsedAt     DateTime? @map("last_used_at") @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId])
  @@index([keyPrefix])
  @@map("api_keys")
}

/// PublicWebhook (Outbound webhooks for external systems)
model PublicWebhook {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String   @db.VarChar(255)
  url            String   @db.Text
  secret         String   @db.VarChar(255) // For HMAC signature verification
  events         String[] @default([]) @db.VarChar(100) // event types to send
  enabled        Boolean  @default(true)
  retryCount     Int      @default(3) @map("retry_count")
  timeoutMs      Int      @default(30000) @map("timeout_ms")
  metadata       Json?    @db.JsonB
  createdBy      String   @map("created_by") @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  deliveries WebhookDelivery[]

  @@index([organizationId])
  @@index([enabled])
  @@map("public_webhooks")
}

/// WebhookDelivery (Track webhook delivery attempts)
model WebhookDelivery {
  id            String    @id @default(uuid()) @db.Uuid
  webhookId     String    @map("webhook_id") @db.Uuid
  eventType     String    @map("event_type") @db.VarChar(100)
  payload       Json      @db.JsonB
  status        String    @default("pending") @db.VarChar(50) // pending, success, failed
  statusCode    Int?      @map("status_code")
  responseBody  String?   @map("response_body") @db.Text
  attempts      Int       @default(0)
  lastAttemptAt DateTime? @map("last_attempt_at") @db.Timestamptz(6)
  nextRetryAt   DateTime? @map("next_retry_at") @db.Timestamptz(6)
  errorMessage  String?   @map("error_message") @db.Text
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  webhook PublicWebhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([status])
  @@index([nextRetryAt])
  @@map("webhook_deliveries")
}

// ============================================================================
// AI PROVIDER PREFERENCES
// ============================================================================

/// OrganizationAIProvider (Organization-level AI provider preferences)
model OrganizationAIProvider {
  id               String   @id @default(uuid()) @db.Uuid
  organizationId   String   @unique @map("organization_id") @db.Uuid
  defaultProvider  String   @default("anthropic") @map("default_provider") @db.VarChar(50)
  providers        Json     @default("{}") @db.JsonB // provider-specific settings
  modelPreferences Json     @default("{}") @map("model_preferences") @db.JsonB // category -> model mapping
  rateLimits       Json?    @map("rate_limits") @db.JsonB
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("organization_ai_providers")
}

// ============================================================================
// WORK QUEUE & JOB EXECUTION (PostgreSQL Queue Pattern)
// ============================================================================

/// WorkQueue - PostgreSQL-backed queue for reliable task processing
/// Used as a durable fallback when Redis/BullMQ is unavailable
model WorkQueue {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  queueName      String    @map("queue_name") @db.VarChar(100) // slack-events, orchestration, notifications, etc.
  priority       Int       @default(0) // Higher = more important
  status         String    @default("pending") @db.VarChar(50) // pending, processing, completed, failed, dead_letter
  payload        Json      @db.JsonB
  result         Json?     @db.JsonB
  errorMessage   String?   @map("error_message") @db.Text
  attempts       Int       @default(0)
  maxAttempts    Int       @default(3) @map("max_attempts")
  lockedBy       String?   @map("locked_by") @db.VarChar(255) // Worker ID that locked this job
  lockedAt       DateTime? @map("locked_at") @db.Timestamptz(6)
  scheduledFor   DateTime? @map("scheduled_for") @db.Timestamptz(6) // For delayed jobs
  completedAt    DateTime? @map("completed_at") @db.Timestamptz(6)
  metadata       Json      @default("{}") @db.JsonB
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  jobExecutions JobExecution[]

  @@index([queueName, status, priority(sort: Desc), createdAt])
  @@index([organizationId, queueName])
  @@index([status, scheduledFor])
  @@index([lockedBy, lockedAt])
  @@index([status, attempts])
  @@map("work_queue")
}

/// JobExecution - Tracks individual execution attempts of work queue items
model JobExecution {
  id           String    @id @default(uuid()) @db.Uuid
  workQueueId  String    @map("work_queue_id") @db.Uuid
  workerId     String    @map("worker_id") @db.VarChar(255) // Which worker processed this
  attempt      Int // Attempt number (1, 2, 3...)
  status       String    @db.VarChar(50) // started, completed, failed, timeout
  result       Json?     @db.JsonB
  errorMessage String?   @map("error_message") @db.Text
  startedAt    DateTime  @default(now()) @map("started_at") @db.Timestamptz(6)
  completedAt  DateTime? @map("completed_at") @db.Timestamptz(6)
  durationMs   Int?      @map("duration_ms")

  workQueue WorkQueue @relation(fields: [workQueueId], references: [id], onDelete: Cascade)

  @@index([workQueueId, attempt])
  @@index([workerId, startedAt(sort: Desc)])
  @@index([status])
  @@map("job_executions")
}

// ============================================================================
// SLACK USER PROVISIONING TABLES
// ============================================================================

/// SlackUser (Maps Slack workspace users to internal Users)
/// Enables automatic user provisioning from Slack interactions
model SlackUser {
  id             String    @id @default(cuid())
  slackUserId    String    @unique @map("slack_user_id")
  slackTeamId    String    @map("slack_team_id")
  userId         String    @map("user_id") @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  displayName    String?   @map("display_name") @db.VarChar(255)
  realName       String?   @map("real_name") @db.VarChar(255)
  email          String?   @db.VarChar(255)
  avatarUrl      String?   @map("avatar_url") @db.Text
  isBot          Boolean   @default(false) @map("is_bot")
  isAdmin        Boolean   @default(false) @map("is_admin")
  lastSyncedAt   DateTime? @map("last_synced_at") @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([slackTeamId])
  @@index([userId])
  @@index([organizationId])
  @@map("slack_users")
}

/// SlackWorkspace - Maps Slack workspaces to internal Organizations
model SlackWorkspace {
  id                  String    @id @default(cuid())
  slackTeamId         String    @unique @map("slack_team_id")
  slackTeamName       String    @map("slack_team_name") @db.VarChar(255)
  organizationId      String    @map("organization_id") @db.Uuid
  accessToken         String?   @map("access_token") @db.Text
  botUserId           String?   @map("bot_user_id") @db.VarChar(100)
  botAccessToken      String?   @map("bot_access_token") @db.Text
  installerUserId     String?   @map("installer_user_id") @db.VarChar(100)
  appId               String?   @map("app_id") @db.VarChar(100)
  enterpriseId        String?   @map("enterprise_id") @db.VarChar(100)
  enterpriseName      String?   @map("enterprise_name") @db.VarChar(255)
  isEnterpriseInstall Boolean   @default(false) @map("is_enterprise_install")
  scopes              String[]  @default([])
  status              String    @default("active") @db.VarChar(50)
  lastSyncedAt        DateTime? @map("last_synced_at") @db.Timestamptz(6)
  installedAt         DateTime  @default(now()) @map("installed_at") @db.Timestamptz(6)
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([status])
  @@map("slack_workspaces")
}

// ============================================================================
// MARKETPLACE HUB TABLES (External marketplace integrations)
// ============================================================================

/// ExternalMarketplaceCredential - Store API keys for external marketplaces
/// Supports: Smithery, LangChain Hub, Civitai, ComfyUI, etc.
model ExternalMarketplaceCredential {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  source       String    @db.VarChar(50) // smithery, langchain-hub, civitai, comfyui, etc.
  apiKey       String?   @map("api_key") @db.Text // Encrypted
  accessToken  String?   @map("access_token") @db.Text // Encrypted
  refreshToken String?   @map("refresh_token") @db.Text // Encrypted
  expiresAt    DateTime? @map("expires_at") @db.Timestamptz(6)

  enabled  Boolean @default(true)
  metadata Json    @default("{}") @db.JsonB

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, source])
  @@index([organizationId])
  @@index([source])
  @@map("external_marketplace_credentials")
}

/// InstallationQueue - Track installation requests from external marketplaces
/// Supports: Smithery, ComfyUI, LangChain Hub, etc.
model InstallationQueue {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  source   String @db.VarChar(50) // smithery, comfyui, langchain-hub, etc.
  itemId   String @map("item_id") @db.VarChar(255)
  itemName String @map("item_name") @db.VarChar(255)
  itemType String @map("item_type") @db.VarChar(50) // mcp_server, workflow, prompt, node, etc.

  status String  @default("pending") @db.VarChar(50) // pending, installing, completed, failed, cancelled
  config Json?   @db.JsonB
  error  String? @db.Text
  result Json?   @db.JsonB // Installation result data

  // Who requested
  requestedBy String   @map("requested_by") @db.Uuid // User or Agent ID
  requestedAt DateTime @default(now()) @map("requested_at") @db.Timestamptz(6)

  // Approval workflow (for recommend mode)
  requiresApproval Boolean   @default(false) @map("requires_approval")
  approvedBy       String?   @map("approved_by") @db.Uuid
  approvedAt       DateTime? @map("approved_at") @db.Timestamptz(6)
  rejectedBy       String?   @map("rejected_by") @db.Uuid
  rejectedAt       DateTime? @map("rejected_at") @db.Timestamptz(6)
  rejectionReason  String?   @map("rejection_reason") @db.Text

  // Completion
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)
  extensionId String?   @map("extension_id") @db.Uuid // Created extension ID

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, status])
  @@index([organizationId, createdAt(sort: Desc)])
  @@index([status])
  @@index([requestedBy])
  @@map("installation_queue")
}

/// OrganizationMarketplaceSettings - Organization-level marketplace settings
model OrganizationMarketplaceSettings {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @unique @map("organization_id") @db.Uuid

  // Installation mode settings
  installationMode String   @default("recommend") @map("installation_mode") @db.VarChar(20) // manual, recommend, yolo
  allowedSources   String[] @default([]) @map("allowed_sources") // Empty = all allowed
  blockedSources   String[] @default([]) @map("blocked_sources")
  maxAutoInstalls  Int      @default(5) @map("max_auto_installs") // Per session limit
  requireReview    Boolean  @default(false) @map("require_review") // Human review for YOLO

  // External source API keys (encrypted)
  smitheryApiKey   String? @map("smithery_api_key") // Optional: for premium Smithery features
  civitaiApiKey    String? @map("civitai_api_key") // Optional: for CivitAI rate limits & NSFW
  langchainApiKey  String? @map("langchain_api_key") // Optional: for private LangChain Hub prompts

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("organization_marketplace_settings")
}

/// AgentInstallationPolicy - Per-agent installation policy overrides
model AgentInstallationPolicy {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  agentId        String @map("agent_id") @db.Uuid // Agent UUID

  // Override settings (null = use org default)
  installationMode String?  @map("installation_mode") @db.VarChar(20)
  allowedSources   String[] @map("allowed_sources")
  blockedSources   String[] @map("blocked_sources")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([organizationId, agentId])
  @@index([organizationId])
  @@map("agent_installation_policies")
}

// ============================================================================
// N8N WORKFLOW AUTOMATION INTEGRATION TABLES
// ============================================================================

/// N8nInstance - Per-tenant n8n container
/// Each organization gets its own isolated n8n instance
model N8nInstance {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  containerUrl   String @map("container_url") @db.Text // e.g., https://org-slug.workflows.nubabel.com
  apiKey         String @map("api_key") @db.Text // Encrypted n8n API key
  encryptionKey  String @map("encryption_key") @db.Text // N8N_ENCRYPTION_KEY (unique per tenant)
  webhookBaseUrl String @map("webhook_base_url") @db.Text // Webhook URL base

  status String @default("provisioning") @map("status") @db.VarChar(50) // provisioning, active, stopped, failed
  config Json   @default("{}") @map("config") @db.JsonB // Additional config

  lastHealthCheck DateTime? @map("last_health_check") @db.Timestamptz(6)
  errorMessage    String?   @map("error_message") @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  workflows    N8nWorkflow[]
  credentials  N8nCredential[]

  @@unique([organizationId])
  @@index([status])
  @@map("n8n_instances")
}

/// N8nWorkflow - Workflow references with categorization
/// Synced from n8n instance, can be registered as orchestrator skills
model N8nWorkflow {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  instanceId     String @map("instance_id") @db.Uuid

  n8nWorkflowId String   @map("n8n_workflow_id") @db.VarChar(255) // ID in n8n's database
  name          String   @db.VarChar(255)
  description   String?  @db.Text
  category      String   @default("uncategorized") @map("category") @db.VarChar(50) // automation, notification, data-sync, etc.
  tags          String[] @default([]) @db.VarChar(100)

  workflowJson Json    @map("workflow_json") @db.JsonB // Full n8n workflow JSON (synced)
  isActive     Boolean @default(false) @map("is_active")
  isSkill      Boolean @default(false) @map("is_skill") // Registered as orchestrator skill

  sopId String? @map("sop_id") @db.Uuid // Link to source SOP if converted

  syncedAt  DateTime @default(now()) @map("synced_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  instance     N8nInstance             @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  executions   N8nExecution[]
  permissions  N8nWorkflowPermission[]

  @@unique([instanceId, n8nWorkflowId])
  @@index([organizationId, category])
  @@index([isSkill])
  @@map("n8n_workflows")
}

/// N8nExecution - Execution tracking
/// Records each workflow execution with status and results
model N8nExecution {
  id         String @id @default(uuid()) @db.Uuid
  workflowId String @map("workflow_id") @db.Uuid

  n8nExecutionId String @map("n8n_execution_id") @db.VarChar(255) // ID in n8n's database
  status         String @db.VarChar(50) // waiting, running, success, error, canceled
  mode           String @db.VarChar(50) // manual, trigger, webhook, retry

  startedAt   DateTime  @map("started_at") @db.Timestamptz(6)
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)

  inputData    Json?   @map("input_data") @db.JsonB // Summary only
  outputData   Json?   @map("output_data") @db.JsonB // Summary only
  errorMessage String? @map("error_message") @db.Text

  retryOf    String? @map("retry_of") @db.Uuid // If this is a retry, link to original
  retryCount Int     @default(0) @map("retry_count")

  triggeredBy String? @map("triggered_by") @db.VarChar(255) // userId or "system" or "webhook"

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  workflow N8nWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId, status])
  @@index([startedAt])
  @@map("n8n_executions")
}

/// N8nCredential - Credential mapping
/// Maps n8n credentials to MCP connections for unified access control
model N8nCredential {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  instanceId     String @map("instance_id") @db.Uuid

  n8nCredentialId String  @map("n8n_credential_id") @db.VarChar(255) // ID in n8n's database
  mcpConnectionId String? @map("mcp_connection_id") @db.Uuid // Link to MCPConnection if mapped

  credentialType String @map("credential_type") @db.VarChar(100) // e.g., "slackApi", "notionApi", "httpHeaderAuth"
  name           String @db.VarChar(255) // Display name

  syncedAt  DateTime @default(now()) @map("synced_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  instance     N8nInstance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@unique([instanceId, n8nCredentialId])
  @@index([organizationId])
  @@map("n8n_credentials")
}

/// N8nWorkflowPermission - Agent-based access control
/// Controls which agents can view/execute/edit workflows
model N8nWorkflowPermission {
  id         String @id @default(uuid()) @db.Uuid
  workflowId String @map("workflow_id") @db.Uuid

  agentId String? @map("agent_id") @db.Uuid // If assigned to specific agent
  roleId  String? @map("role_id") @db.VarChar(50) // If assigned to role (admin, member, viewer)

  canView    Boolean @default(true) @map("can_view")
  canExecute Boolean @default(false) @map("can_execute")
  canEdit    Boolean @default(false) @map("can_edit")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  workflow N8nWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([workflowId, agentId])
  @@unique([workflowId, roleId])
  @@map("n8n_workflow_permissions")
}

// ============================================================================
// KNOWLEDGE GRAPH & MEMORY SYSTEM
// ============================================================================

/// KnowledgeNode - Nodes in the knowledge graph
/// Represents entities, concepts, documents, or any knowledge unit
model KnowledgeNode {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  type        String  @db.VarChar(100) // entity, concept, document, task, person, etc.
  name        String  @db.VarChar(500)
  description String? @db.Text
  metadata    Json    @default("{}") @db.JsonB // Flexible additional data

  // Vector embedding for semantic search (stored as JSON array of floats)
  embedding Json? @db.JsonB // [0.1, 0.2, ...] float vector

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization  Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  outgoingEdges KnowledgeEdge[] @relation("SourceNode")
  incomingEdges KnowledgeEdge[] @relation("TargetNode")

  @@index([organizationId, type])
  @@index([organizationId, name])
  @@map("knowledge_nodes")
}

/// KnowledgeEdge - Relationships between nodes
/// Weighted, typed edges connecting knowledge nodes
model KnowledgeEdge {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  sourceNodeId String @map("source_node_id") @db.Uuid
  targetNodeId String @map("target_node_id") @db.Uuid

  relationshipType String @map("relationship_type") @db.VarChar(100) // related_to, parent_of, depends_on, mentions, etc.
  weight           Float  @default(1.0) @db.Real // Strength of relationship (0.0-1.0)
  metadata         Json   @default("{}") @db.JsonB

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sourceNode   KnowledgeNode @relation("SourceNode", fields: [sourceNodeId], references: [id], onDelete: Cascade)
  targetNode   KnowledgeNode @relation("TargetNode", fields: [targetNodeId], references: [id], onDelete: Cascade)

  @@unique([sourceNodeId, targetNodeId, relationshipType])
  @@index([organizationId])
  @@index([sourceNodeId])
  @@index([targetNodeId])
  @@index([relationshipType])
  @@map("knowledge_edges")
}

/// KnowledgeCluster - Groups of related nodes
/// For organizing and navigating the knowledge graph
model KnowledgeCluster {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  name        String   @db.VarChar(255)
  description String?  @db.Text
  nodeIds     String[] @map("node_ids") @db.Uuid // Array of node IDs in this cluster

  // Centroid vector for the cluster (averaged embeddings)
  centroid Json? @db.JsonB // [0.1, 0.2, ...] float vector

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("knowledge_clusters")
}

/// EntityMemory - Memory about specific entities
/// Short-term, context-specific memory for entities
model EntityMemory {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  entityType String @map("entity_type") @db.VarChar(100) // agent, user, project, task, etc.
  entityId   String @map("entity_id") @db.Uuid

  memoryType String @map("memory_type") @db.VarChar(100) // preference, context, state, note, etc.
  content    String @db.Text
  metadata   Json   @default("{}") @db.JsonB

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  expiresAt DateTime? @map("expires_at") @db.Timestamptz(6) // Optional expiration

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, entityType, entityId])
  @@index([expiresAt]) // For cleanup of expired memories
  @@map("entity_memories")
}

/// Memory - Long-term memory storage
/// Episodic, semantic, and procedural memory for the system
model Memory {
  id             String  @id @default(uuid()) @db.Uuid
  organizationId String  @map("organization_id") @db.Uuid
  userId         String? @map("user_id") @db.Uuid // Optional: memory specific to a user

  type String @db.VarChar(50) // episodic (events), semantic (facts), procedural (how-tos)

  content   String @db.Text
  embedding Json?  @db.JsonB // [0.1, 0.2, ...] float vector for semantic search

  // Memory strength metrics
  importance     Float    @default(0.5) @db.Real // 0.0-1.0
  accessCount    Int      @default(0) @map("access_count")
  lastAccessedAt DateTime @default(now()) @map("last_accessed_at") @db.Timestamptz(6)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, type])
  @@index([organizationId, userId])
  @@index([importance])
  @@index([lastAccessedAt])
  @@map("memories")
}

// ============================================================================
// EXTERNAL IDENTITY LINKING SYSTEM
// ============================================================================

/// System user for automated operations (used as performedBy for system actions)
/// This avoids FK constraint issues when system performs audit-logged actions
model SystemUser {
  id        String   @id @default(uuid()) @db.Uuid
  type      String   @db.VarChar(50) // 'system', 'migration', 'cron'
  name      String   @db.VarChar(100)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("system_users")
}

/// Unified external identity storage for all providers (Slack, Google, Notion, etc.)
model ExternalIdentity {
  id             String  @id @default(uuid()) @db.Uuid
  organizationId String  @map("organization_id") @db.Uuid
  userId         String? @map("user_id") @db.Uuid // Nullable until linked

  // Provider identification
  provider       String  @db.VarChar(50) // 'slack', 'google', 'notion'
  providerUserId String  @map("provider_user_id") @db.VarChar(255)
  providerTeamId String? @map("provider_team_id") @db.VarChar(255)

  // Profile data (synced from provider)
  email       String? @db.VarChar(255)
  displayName String? @map("display_name") @db.VarChar(255)
  realName    String? @map("real_name") @db.VarChar(255)
  avatarUrl   String? @map("avatar_url") @db.Text

  // Provider-specific metadata
  metadata Json @default("{}") @db.JsonB

  // Linking information
  linkStatus     String    @default("unlinked") @map("link_status") @db.VarChar(20) // 'unlinked', 'linked', 'suggested'
  linkMethod     String?   @map("link_method") @db.VarChar(50) // 'auto_email', 'auto_fuzzy', 'manual', 'admin', 'migration'
  linkConfidence Float?    @map("link_confidence") @db.Real // 0.00 to 1.00 (using Float for simplicity)
  linkedAt       DateTime? @map("linked_at") @db.Timestamptz(6)
  linkedBy       String?   @map("linked_by") @db.Uuid

  // Sync tracking
  lastSyncedAt DateTime? @map("last_synced_at") @db.Timestamptz(6)
  syncError    String?   @map("sync_error") @db.Text

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation("ExternalIdentities", fields: [userId], references: [id], onDelete: SetNull)
  linkedByUser User?        @relation("IdentityLinkedBy", fields: [linkedBy], references: [id])

  suggestions IdentityLinkSuggestion[] @relation("SourceIdentity")
  auditLogs   IdentityLinkAudit[]

  // Constraints
  @@unique([organizationId, provider, providerUserId])
  @@index([organizationId])
  @@index([organizationId, userId])
  @@index([organizationId, provider])
  @@index([organizationId, linkStatus])
  @@index([organizationId, email])
  @@index([providerUserId])
  @@map("external_identities")
}

/// Suggested identity links awaiting user/admin confirmation
model IdentityLinkSuggestion {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  // Source (external identity to be linked)
  externalIdentityId String @map("external_identity_id") @db.Uuid

  // Suggested target user
  suggestedUserId String @map("suggested_user_id") @db.Uuid

  // Match details
  matchMethod     String @map("match_method") @db.VarChar(50) // 'email', 'fuzzy_name', 'domain'
  confidenceScore Float  @map("confidence_score") @db.Real
  matchDetails    Json   @default("{}") @map("match_details") @db.JsonB

  // Workflow state
  status          String    @default("pending") @db.VarChar(20) // 'pending', 'accepted', 'rejected', 'expired', 'superseded'
  reviewedBy      String?   @map("reviewed_by") @db.Uuid
  reviewedAt      DateTime? @map("reviewed_at") @db.Timestamptz(6)
  rejectionReason String?   @map("rejection_reason") @db.Text

  // Expiry
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization     Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  externalIdentity ExternalIdentity @relation("SourceIdentity", fields: [externalIdentityId], references: [id], onDelete: Cascade)
  suggestedUser    User             @relation("SuggestedIdentityLinks", fields: [suggestedUserId], references: [id], onDelete: Cascade)
  reviewer         User?            @relation("IdentitySuggestionReviewer", fields: [reviewedBy], references: [id])

  // Constraints
  @@unique([externalIdentityId, suggestedUserId])
  @@index([organizationId, status])
  @@index([organizationId, suggestedUserId])
  @@index([expiresAt])
  @@map("identity_link_suggestions")
}

/// Audit trail for all identity linking decisions
model IdentityLinkAudit {
  id                 String @id @default(uuid()) @db.Uuid
  organizationId     String @map("organization_id") @db.Uuid
  externalIdentityId String @map("external_identity_id") @db.Uuid

  // Action details
  action         String  @db.VarChar(30) // 'linked', 'unlinked', 'rejected', 'suggestion_created', 'superseded'
  userId         String? @map("user_id") @db.Uuid // Target user (if applicable)
  previousUserId String? @map("previous_user_id") @db.Uuid // For unlink/re-link

  // Context
  linkMethod      String? @map("link_method") @db.VarChar(50)
  confidenceScore Float?  @map("confidence_score") @db.Real
  performedBy     String? @map("performed_by") @db.Uuid // Nullable for system actions
  reason          String? @db.Text
  metadata        Json    @default("{}") @db.JsonB

  // Request context
  ipAddress String? @map("ip_address") @db.VarChar(45)
  userAgent String? @map("user_agent") @db.Text

  // Timestamp
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  organization     Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  externalIdentity ExternalIdentity @relation(fields: [externalIdentityId], references: [id], onDelete: Cascade)
  performer        User?            @relation("IdentityAuditPerformer", fields: [performedBy], references: [id])

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([externalIdentityId, createdAt(sort: Desc)])
  @@index([userId])
  @@map("identity_link_audit")
}

/// Organization-level identity linking settings
model IdentitySettings {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @unique @map("organization_id") @db.Uuid

  // Auto-linking configuration
  autoLinkOnEmail     Boolean @default(true) @map("auto_link_on_email")
  autoLinkThreshold   Float   @default(0.95) @map("auto_link_threshold") @db.Real
  suggestionThreshold Float   @default(0.85) @map("suggestion_threshold") @db.Real

  // Provider priorities (JSON array of provider names)
  providerPriority Json @default("[\"google\", \"slack\", \"notion\"]") @map("provider_priority") @db.JsonB

  // Self-service settings
  allowUserSelfLink    Boolean @default(true) @map("allow_user_self_link")
  allowUserSelfUnlink  Boolean @default(true) @map("allow_user_self_unlink")
  requireAdminApproval Boolean @default(false) @map("require_admin_approval")

  // Retention
  suggestionExpiryDays Int @default(30) @map("suggestion_expiry_days")
  auditRetentionDays   Int @default(2555) @map("audit_retention_days") // ~7 years for compliance

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("identity_settings")
}

// ============================================================================
// FEEDBACK & LEARNING SYSTEM (Phase 3 Intelligence Layer)
// ============================================================================

/// FeedbackCapture - User feedback on agent responses
/// Captures reactions, corrections, and ratings for continuous improvement
model FeedbackCapture {
  id             String  @id @default(uuid()) @db.Uuid
  organizationId String  @map("organization_id") @db.Uuid
  userId         String  @map("user_id") @db.Uuid
  executionId    String? @map("execution_id") @db.Uuid // Link to OrchestratorExecution if available

  // Slack context
  slackWorkspaceId String? @map("slack_workspace_id") @db.VarChar(50)
  slackChannelId   String? @map("slack_channel_id") @db.VarChar(50)
  slackThreadTs    String? @map("slack_thread_ts") @db.VarChar(50)
  slackMessageTs   String  @map("slack_message_ts") @db.VarChar(50)

  // Feedback type
  feedbackType String @map("feedback_type") @db.VarChar(50) // reaction, correction, rating

  // Reaction data
  reaction String? @db.VarChar(50) // thumbsdown, -1, thumbsup, +1, etc.

  // Original message content
  originalMessage String @map("original_message") @db.Text

  // Correction text (optional, provided by user)
  correction String? @db.Text

  // Metadata
  metadata Json @default("{}") @db.JsonB

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([executionId])
  @@index([slackWorkspaceId, slackMessageTs])
  @@index([feedbackType])
  @@index([userId])
  @@map("feedback_captures")
}

/// Prompt Suggestions - AI-generated prompt improvements from feedback analysis
model PromptSuggestion {
  id              String   @id @default(uuid()) @db.Uuid
  organizationId  String   @map("organization_id") @db.Uuid
  agentType       String?  @map("agent_type") @db.VarChar(100) // sisyphus, oracle, executor, etc.
  patternId       String   @map("pattern_id") @db.VarChar(100) // Reference to detected pattern
  currentPrompt   String?  @map("current_prompt") @db.Text
  suggestedPrompt String   @map("suggested_prompt") @db.Text
  reason          String   @db.Text // Why this change is suggested
  confidence      Float    @default(0.0) // 0-1 confidence score
  status          String   @default("pending") @db.VarChar(20) // pending, approved, rejected
  approvedBy      String?  @map("approved_by") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId, status])
  @@index([agentType])
  @@index([createdAt(sort: Desc)])
  @@map("prompt_suggestions")
}

// ============================================================================
// AR (AGENT RESOURCE) MANAGEMENT SYSTEM
// Enterprise-grade Agent Resource management - mirrors HR practices for AI agents
// ============================================================================

// --- Module 1: Agent Organization Schema ---

/// Agent Department (Organizational Unit)
/// Hierarchical department structure for organizing agents
model AgentDepartment {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String   @db.VarChar(255) // "Product Design", "Operations"
  code           String   @db.VarChar(50) // "PROD-DESIGN", "OPS"
  description    String?  @db.Text
  parentId       String?  @map("parent_id") @db.Uuid // Hierarchical
  headAgentId    String?  @map("head_agent_id") @db.Uuid // Department head agent
  headHumanId    String?  @map("head_human_id") @db.Uuid // Human owner
  budgetCents    Int?     @map("budget_cents")
  costCenter     String?  @map("cost_center") @db.VarChar(50)
  status         String   @default("active") @db.VarChar(50)
  metadata       Json     @default("{}") @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization   Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parent         AgentDepartment?         @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children       AgentDepartment[]        @relation("DepartmentHierarchy")
  positions      AgentPosition[]
  humanPositions HumanPosition[]
  dailySummaries DepartmentDailySummary[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([parentId])
  @@index([status])
  @@map("agent_departments")
}

/// Agent Position (Role Definition)
/// Defines roles/positions that agents can hold within departments
model AgentPosition {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  departmentId   String   @map("department_id") @db.Uuid
  title          String   @db.VarChar(255) // "Senior Designer", "Lead Analyst"
  level          Int      @default(1) // 1=Entry, 2=Mid, 3=Senior, 4=Lead, 5=Head
  reportsToId    String?  @map("reports_to_id") @db.Uuid
  requiredSkills String[] @default([]) @db.VarChar(100)
  preferredModel String?  @map("preferred_model") @db.VarChar(50) // "opus", "sonnet"
  maxConcurrent  Int      @default(1) @map("max_concurrent") // How many agents can hold this position
  budgetPerTask  Int?     @map("budget_per_task") // Token budget
  approvalLevel  Int      @default(0) @map("approval_level") // 0=none, 1=team, 2=dept, 3=org
  metadata       Json     @default("{}") @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization  Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department    AgentDepartment   @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  reportsTo     AgentPosition?    @relation("PositionHierarchy", fields: [reportsToId], references: [id])
  directReports AgentPosition[]   @relation("PositionHierarchy")
  assignments   AgentAssignment[]

  @@index([organizationId])
  @@index([departmentId])
  @@index([reportsToId])
  @@index([level])
  @@map("agent_positions")
}

/// Agent Assignment (Agent to Position mapping)
/// Maps agents to positions with assignment details
model AgentAssignment {
  id               String    @id @default(uuid()) @db.Uuid
  organizationId   String    @map("organization_id") @db.Uuid
  agentId          String    @map("agent_id") @db.Uuid
  positionId       String    @map("position_id") @db.Uuid
  humanSupervisor  String?   @map("human_supervisor") @db.Uuid // User who oversees
  assignmentType   String    @default("permanent") @db.VarChar(50) // permanent, temporary, acting
  startDate        DateTime  @default(now()) @map("start_date") @db.Timestamptz(6)
  endDate          DateTime? @map("end_date") @db.Timestamptz(6)
  status           String    @default("active") @db.VarChar(50) // active, on_leave, suspended
  performanceScore Float?    @map("performance_score") @db.Real // 0-100
  workload         Float     @default(1.0) @db.Real // 0-1 capacity utilization
  metadata         Json      @default("{}") @db.JsonB
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agent        Agent         @relation(fields: [agentId], references: [id], onDelete: Cascade)
  position     AgentPosition @relation(fields: [positionId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([agentId])
  @@index([positionId])
  @@index([status])
  @@index([assignmentType])
  @@map("agent_assignments")
}

/// AR Cost Entry - Cost tracking per agent/department
/// Tracks all costs associated with agent operations
model ARCostEntry {
  id             String       @id @default(uuid()) @db.Uuid
  organizationId String       @map("organization_id") @db.Uuid
  agentId        String?      @map("agent_id") @db.Uuid
  departmentId   String?      @map("department_id") @db.Uuid
  costType       String       @db.VarChar(50) // "token", "api_call", "compute"
  amountCents    Int          @map("amount_cents")
  tokenCount     Int?         @map("token_count")
  modelUsed      String?      @map("model_used") @db.VarChar(50)
  taskReference  String?      @map("task_reference") @db.VarChar(255)
  description    String?      @db.Text
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([agentId])
  @@index([departmentId])
  @@index([costType])
  @@map("ar_cost_entries")
}

// --- Module 2: Human-Agent Approval Workflow ---

/// AR Approval Request - Multi-level approval requests
/// Handles approval workflows across organizational levels
model ARApprovalRequest {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  // Request details
  requestType    String  @map("request_type") @db.VarChar(50) // "task", "budget", "assignment", "schedule"
  level          Int // 1-5 (Task to Objective)
  title          String  @db.VarChar(500)
  description    String  @db.Text
  context        Json    @default("{}") @db.JsonB
  impactScope    String? @map("impact_scope") @db.VarChar(50) // "individual", "team", "department", "org"
  estimatedValue Int?    @map("estimated_value") // In cents

  // Requester
  requesterType String @map("requester_type") @db.VarChar(20) // "agent", "human"
  requesterId   String @map("requester_id") @db.Uuid

  // Approver chain (computed at creation time)
  approverChain Json @map("approver_chain") @db.JsonB // [{level, approverId, type}]
  currentLevel  Int  @default(1) @map("current_level")

  // Status
  status    String @default("pending") @db.VarChar(50)
  responses Json   @default("[]") @db.JsonB // [{level, approverId, decision, note, timestamp}]

  // Timing
  expiresAt    DateTime  @map("expires_at") @db.Timestamptz(6)
  escalationAt DateTime? @map("escalation_at") @db.Timestamptz(6) // When to auto-escalate

  // Slack integration
  slackChannelId String? @map("slack_channel_id") @db.VarChar(50)
  slackMessageTs String? @map("slack_message_ts") @db.VarChar(50)

  createdAt    DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, status])
  @@index([requesterId, requesterType])
  @@index([status, expiresAt])
  @@index([status, escalationAt])
  @@map("ar_approval_requests")
}

/// AR Approval Rule - Escalation and routing rules
/// Defines rules for approval routing and escalation
model ARApprovalRule {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  name        String @db.VarChar(255)
  requestType String @map("request_type") @db.VarChar(50)

  // Conditions
  conditions Json @db.JsonB // {minValue, maxValue, impactScope, keywords}

  // Approval chain template
  requiredLevel Int  @map("required_level") // Minimum level required
  chainTemplate Json @map("chain_template") @db.JsonB // How to build approver chain

  // Timing
  timeoutMinutes Int     @default(60) @map("timeout_minutes")
  autoEscalate   Boolean @default(true) @map("auto_escalate")

  enabled  Boolean @default(true)
  priority Int     @default(0) // Higher = checked first

  createdAt    DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, enabled])
  @@index([organizationId, requestType])
  @@index([priority])
  @@map("ar_approval_rules")
}

// --- Module 3: Autonomous Coordination Engine ---

/// Agent Daily Report - Daily agent activity summaries
/// Generated reports for each agent's daily activities
model AgentDailyReport {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  agentId        String   @map("agent_id") @db.Uuid
  reportDate     DateTime @map("report_date") @db.Date

  // Activity summary
  tasksCompleted  Int    @default(0) @map("tasks_completed")
  tasksInProgress Int    @default(0) @map("tasks_in_progress")
  tasksBlocked    Int    @default(0) @map("tasks_blocked")
  tokensConsumed  Int    @default(0) @map("tokens_consumed")
  avgResponseTime Float? @map("avg_response_time") @db.Real // ms

  // Goal alignment
  goalAlignmentScore Float?   @map("goal_alignment_score") @db.Real // 0-100
  contributedGoals   String[] @default([]) @map("contributed_goals") @db.Uuid

  // Issues & blockers
  blockers   Json @default("[]") @db.JsonB // [{description, severity, suggestedAction}]
  challenges Json @default("[]") @db.JsonB // [{description, category}]

  // Recommendations
  recommendations Json @default("[]") @db.JsonB // [{type, description, priority}]

  // AI-generated summary
  summaryText String? @map("summary_text") @db.Text

  createdAt    DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  organization Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, agentId, reportDate])
  @@index([organizationId, reportDate])
  @@index([agentId, reportDate])
  @@map("agent_daily_reports")
}

/// Department Daily Summary - Aggregated department reports
/// Daily summary reports for departments
model DepartmentDailySummary {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  departmentId   String   @map("department_id") @db.Uuid
  reportDate     DateTime @map("report_date") @db.Date

  // Aggregated metrics
  totalAgents      Int    @default(0) @map("total_agents")
  activeAgents     Int    @default(0) @map("active_agents")
  totalTasks       Int    @default(0) @map("total_tasks")
  completedTasks   Int    @default(0) @map("completed_tasks")
  avgGoalAlignment Float? @map("avg_goal_alignment") @db.Real
  totalCostCents   Int    @default(0) @map("total_cost_cents")

  // Department-level issues
  criticalBlockers  Json @default("[]") @map("critical_blockers") @db.JsonB
  resourceShortages Json @default("[]") @map("resource_shortages") @db.JsonB

  // AI analysis
  analysisText    String? @map("analysis_text") @db.Text
  priorityActions Json    @default("[]") @map("priority_actions") @db.JsonB

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  department AgentDepartment @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([organizationId, departmentId, reportDate])
  @@index([organizationId, reportDate])
  @@index([departmentId])
  @@map("department_daily_summaries")
}

/// Goal Alignment Record - Tracks agent contributions to goals
/// Records how agents align with organizational goals
model GoalAlignmentRecord {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  agentId        String @map("agent_id") @db.Uuid
  goalId         String @map("goal_id") @db.Uuid

  alignmentScore Float    @map("alignment_score") @db.Real // 0-100
  contribution   String   @db.Text // Description of contribution
  evidenceLinks  String[] @default([]) @map("evidence_links") // Task IDs, etc.

  analysisDate DateTime     @map("analysis_date") @db.Timestamptz(6)
  createdAt    DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, goalId])
  @@index([agentId, analysisDate])
  @@index([alignmentScore])
  @@map("goal_alignment_records")
}

/// Workload Rebalancing - Tracks workload rebalancing events
/// Records decisions to rebalance work across agents
model WorkloadRebalancing {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  triggerType    String @map("trigger_type") @db.VarChar(50) // "overload", "underutilized", "deadline_risk", "manual"
  triggerDetails Json   @map("trigger_details") @db.JsonB

  // Changes made
  changes Json @db.JsonB // [{agentId, action, from, to}]

  // Approval if needed
  approvalId String? @map("approval_id") @db.Uuid
  status     String  @default("pending") @db.VarChar(50) // pending, approved, rejected, applied

  appliedAt    DateTime?    @map("applied_at") @db.Timestamptz(6)
  createdAt    DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, status])
  @@index([triggerType])
  @@index([appliedAt])
  @@map("workload_rebalancing")
}

// --- Module 4: Schedule & Availability System ---

/// Human Availability - Synced from calendar
/// Tracks human team members' availability
model HumanAvailability {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  userId         String @map("user_id") @db.Uuid

  date           DateTime @db.Date
  availableFrom  String   @map("available_from") @db.VarChar(5) // "09:00"
  availableUntil String   @map("available_until") @db.VarChar(5) // "18:00"
  timezone       String   @db.VarChar(50)

  // Status
  status       String @db.VarChar(50) // "available", "busy", "vacation", "sick"
  blockedSlots Json   @default("[]") @map("blocked_slots") @db.JsonB // [{from, to, reason}]

  // Sync info
  calendarSyncId String?   @map("calendar_sync_id") @db.VarChar(255)
  lastSyncAt     DateTime? @map("last_sync_at") @db.Timestamptz(6)

  createdAt    DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, userId, date])
  @@index([organizationId, date])
  @@index([userId])
  @@index([status])
  @@map("human_availability")
}

/// Agent Capacity - Computed agent capacity
/// Tracks agent capacity for scheduling purposes
model AgentCapacity {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  agentId        String @map("agent_id") @db.Uuid

  date         DateTime @db.Date
  maxTasks     Int      @default(10) @map("max_tasks")
  currentTasks Int      @default(0) @map("current_tasks")
  maxTokens    Int      @default(100000) @map("max_tokens")
  usedTokens   Int      @default(0) @map("used_tokens")

  // Capacity score 0-100
  capacityScore Float @map("capacity_score") @db.Real

  // Constraints
  blockedReasons Json @default("[]") @map("blocked_reasons") @db.JsonB // [{reason, severity}]

  createdAt    DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, agentId, date])
  @@index([organizationId, date])
  @@index([agentId])
  @@index([capacityScore])
  @@map("agent_capacity")
}

/// AR Meeting - AR-aware meetings
/// Meetings that include both human and agent participants
model ARMeeting {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  title       String  @db.VarChar(500)
  description String? @db.Text
  meetingType String  @map("meeting_type") @db.VarChar(50) // "standup", "review", "planning", "adhoc"

  // Participants
  humanParticipants String[] @default([]) @map("human_participants") @db.Uuid
  agentParticipants String[] @default([]) @map("agent_participants") @db.Uuid

  // Scheduling
  scheduledAt     DateTime @map("scheduled_at") @db.Timestamptz(6)
  durationMinutes Int      @map("duration_minutes")
  timezone        String   @db.VarChar(50)

  // Recurrence
  isRecurring    Boolean @default(false) @map("is_recurring")
  recurrenceRule String? @map("recurrence_rule") @db.VarChar(255) // RRULE format

  // Calendar sync
  googleEventId String? @map("google_event_id") @db.VarChar(255)

  status String @default("scheduled") @db.VarChar(50)

  createdAt    DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, scheduledAt])
  @@index([status])
  @@index([meetingType])
  @@map("ar_meetings")
}

/// AR Leave Request - Vacation/leave requests
/// Handles leave requests for both humans and agents
model ARLeaveRequest {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  // Who is taking leave
  entityType String @map("entity_type") @db.VarChar(20) // "human", "agent"
  entityId   String @map("entity_id") @db.Uuid

  leaveType String @map("leave_type") @db.VarChar(50) // "vacation", "sick", "maintenance", "upgrade"

  startDate DateTime @map("start_date") @db.Date
  endDate   DateTime @map("end_date") @db.Date

  reason String? @db.Text

  // Coverage planning
  coveringEntity String? @map("covering_entity") @db.Uuid
  coveringType   String? @map("covering_type") @db.VarChar(20) // "human", "agent"
  handoverNotes  String? @map("handover_notes") @db.Text

  // Approval
  approvalId String? @map("approval_id") @db.Uuid
  status     String  @default("pending") @db.VarChar(50)

  createdAt    DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, entityId])
  @@index([organizationId, startDate, endDate])
  @@index([status])
  @@index([entityType])
  @@map("ar_leave_requests")
}

// --- Module 5: Dynamic Team Templates ---

/// AR Industry Template - Best practices templates
/// Pre-defined organizational templates for different industries
model ARIndustryTemplate {
  id String @id @default(uuid()) @db.Uuid

  name        String @db.VarChar(255) // "Tech Startup - Early Stage"
  industry    String @db.VarChar(100) // "technology", "fashion", "ecommerce"
  companySize String @map("company_size") @db.VarChar(50) // "startup", "smb", "enterprise"
  growthStage String @map("growth_stage") @db.VarChar(50) // "seed", "growth", "mature"

  // Template structure
  departments Json @db.JsonB // [{name, description, positions: [...]}]
  keyRoles    Json @map("key_roles") @db.JsonB // Priority roles for this template

  // Recommended practices
  bestPractices Json @map("best_practices") @db.JsonB
  antiPatterns  Json @map("anti_patterns") @db.JsonB

  // Metrics
  usageCount Int    @default(0) @map("usage_count")
  avgRating  Float? @map("avg_rating") @db.Real

  isBuiltIn Boolean  @default(false) @map("is_built_in")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  teamConfigs          ARTeamConfiguration[]
  recommendations      ARTeamRecommendation[]
  effectivenessRecords TemplateEffectivenessRecord[]
  abTestsA             TemplateABTest[]              @relation("TemplateA")
  abTestsB             TemplateABTest[]              @relation("TemplateB")
  winningTests         TemplateABTest[]              @relation("WinningTemplate")

  @@index([industry])
  @@index([companySize])
  @@index([growthStage])
  @@index([isBuiltIn])
  @@map("ar_industry_templates")
}

/// AR Team Configuration - Organization team configs
/// Organization-specific team configurations based on templates
model ARTeamConfiguration {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  name       String  @db.VarChar(255) // "Project Alpha Team"
  templateId String? @map("template_id") @db.Uuid // Base template

  // Custom configuration
  structure   Json @db.JsonB // Final team structure
  constraints Json @default("{}") @db.JsonB // {maxBudget, maxAgents, requiredSkills}

  // Team members
  assignments Json @default("[]") @db.JsonB // [{positionId, agentId, startDate}]

  // Project association
  projectId String? @map("project_id") @db.Uuid

  status String @default("active") @db.VarChar(50)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  template     ARIndustryTemplate? @relation(fields: [templateId], references: [id])
  organization Organization        @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([templateId])
  @@index([status])
  @@map("ar_team_configurations")
}

/// AR Team Recommendation - Team composition recommendations
/// AI-generated recommendations for team composition
model ARTeamRecommendation {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  // Trigger
  triggerType String @map("trigger_type") @db.VarChar(50) // "new_project", "scaling", "optimization"
  context     Json   @db.JsonB

  // Recommendations
  recommendations Json @db.JsonB // [{action, rationale, impact, effort}]

  // Matched templates
  matchedTemplates  Json    @map("matched_templates") @db.JsonB // [{templateId, matchScore}]
  primaryTemplateId String? @map("primary_template_id") @db.Uuid

  status    String    @default("pending") @db.VarChar(50)
  appliedAt DateTime? @map("applied_at") @db.Timestamptz(6)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  primaryTemplate ARIndustryTemplate? @relation(fields: [primaryTemplateId], references: [id])
  organization    Organization        @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([status])
  @@index([triggerType])
  @@map("ar_team_recommendations")
}

// --- Module 6: AR Department Self-Management ---

/// AR Meta-Agent - Meta-agent definitions
/// Defines agents that manage the AR system itself
model ARMetaAgent {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  agentId  String @map("agent_id") @db.Uuid // Link to Agent table
  metaRole String @map("meta_role") @db.VarChar(50) // "director", "ops_manager", "analyst", "coach"

  // Configuration
  config   Json @default("{}") @db.JsonB
  schedule Json @default("{}") @db.JsonB // When this meta-agent runs

  // Status
  status       String    @default("active") @db.VarChar(50)
  lastActiveAt DateTime? @map("last_active_at") @db.Timestamptz(6)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  departmentLogs ARDepartmentLog[]
  organization   Organization      @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, metaRole])
  @@index([organizationId])
  @@index([status])
  @@map("ar_meta_agents")
}

/// AR Department Log - AR department activity log
/// Audit trail for AR department meta-agent actions
model ARDepartmentLog {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  metaAgentId String? @map("meta_agent_id") @db.Uuid
  action      String  @db.VarChar(100)
  category    String  @db.VarChar(50) // "monitoring", "analysis", "coaching", "coordination"

  details Json    @db.JsonB
  impact  String? @db.VarChar(50) // "low", "medium", "high"

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  metaAgent    ARMetaAgent? @relation(fields: [metaAgentId], references: [id], onDelete: SetNull)
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([category])
  @@index([metaAgentId])
  @@index([impact])
  @@map("ar_department_logs")
}

// --- Addendum C: Human Position Schema ---

/// Human Position - Role definitions for humans
/// Defines positions that humans can hold within AR departments
model HumanPosition {
  id             String  @id @default(uuid()) @db.Uuid
  organizationId String  @map("organization_id") @db.Uuid
  departmentId   String? @map("department_id") @db.Uuid // Can belong to agent department

  title String @db.VarChar(255) // "VP Engineering", "Product Manager"
  level Int    @default(1) // 1-10 (higher = more senior)

  // AR Authority
  arApprovalLevel   Int     @default(0) @map("ar_approval_level") // 0-5, what AR decisions can approve
  maxBudgetApproval Int?    @map("max_budget_approval") // Max budget (cents) can approve
  canOverrideAgents Boolean @default(false) @map("can_override_agents")
  canAssignAgents   Boolean @default(false) @map("can_assign_agents")

  // Supervision scope
  supervisedDepartments String[] @default([]) @map("supervised_departments") @db.Uuid
  supervisedPositions   String[] @default([]) @map("supervised_positions") @db.Uuid

  metadata  Json     @default("{}") @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department   AgentDepartment?  @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  assignments  HumanAssignment[]

  @@index([organizationId])
  @@index([departmentId])
  @@index([level])
  @@index([arApprovalLevel])
  @@map("human_positions")
}

/// Human Assignment - User to Position mapping
/// Maps users to human positions within the organization
model HumanAssignment {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  userId         String @map("user_id") @db.Uuid
  positionId     String @map("position_id") @db.Uuid

  assignmentType String    @default("primary") @db.VarChar(50) // primary, secondary, acting
  startDate      DateTime  @default(now()) @map("start_date") @db.Timestamptz(6)
  endDate        DateTime? @map("end_date") @db.Timestamptz(6)
  status         String    @default("active") @db.VarChar(50)

  // Delegation when absent
  delegateToId     String? @map("delegate_to_id") @db.Uuid
  delegationReason String? @map("delegation_reason") @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  position     HumanPosition @relation(fields: [positionId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId, positionId])
  @@index([organizationId])
  @@index([userId])
  @@index([positionId])
  @@index([status])
  @@map("human_assignments")
}

// --- Addendum D: Template Learning Loop ---

/// Template Effectiveness Record - Tracks template effectiveness
/// Metrics for measuring how well templates perform
model TemplateEffectivenessRecord {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  templateId     String @map("template_id") @db.Uuid

  // Usage tracking
  usageStartDate DateTime  @map("usage_start_date") @db.Timestamptz(6)
  usageEndDate   DateTime? @map("usage_end_date") @db.Timestamptz(6)

  // Outcome metrics
  taskCompletionRate    Float? @map("task_completion_rate") @db.Real // 0-1
  avgGoalAlignmentScore Float? @map("avg_goal_alignment_score") @db.Real // 0-100
  avgAgentUtilization   Float? @map("avg_agent_utilization") @db.Real // 0-1
  totalCostCents        Int?   @map("total_cost_cents")
  teamSatisfactionScore Float? @map("team_satisfaction_score") @db.Real // 0-10 (from surveys)

  // Comparative metrics
  comparedToBaseline     Float? @map("compared_to_baseline") @db.Real // Performance vs no template
  comparedToAlternatives Json?  @map("compared_to_alternatives") @db.JsonB

  // Learning signals
  customizations      Json @default("[]") @db.JsonB // Changes made from template
  problemsEncountered Json @default("[]") @map("problems_encountered") @db.JsonB // Issues during usage
  successPatterns     Json @default("[]") @map("success_patterns") @db.JsonB // What worked well

  // Feedback
  userFeedback Json @default("[]") @map("user_feedback") @db.JsonB // Direct user feedback

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  template     ARIndustryTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  organization Organization       @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([templateId])
  @@index([usageStartDate])
  @@map("template_effectiveness_records")
}

/// Template A/B Test - A/B testing for templates
/// Tracks experiments comparing different templates
model TemplateABTest {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  name        String  @db.VarChar(255)
  description String? @db.Text

  // Test configuration
  templateAId String @map("template_a_id") @db.Uuid
  templateBId String @map("template_b_id") @db.Uuid

  // Split configuration
  splitRatio       Float    @default(0.5) @map("split_ratio") @db.Real // % going to template A
  targetMetric     String   @map("target_metric") @db.VarChar(100) // Primary success metric
  secondaryMetrics String[] @default([]) @map("secondary_metrics") @db.VarChar(100)

  // Duration
  startDate     DateTime  @map("start_date") @db.Timestamptz(6)
  endDate       DateTime? @map("end_date") @db.Timestamptz(6)
  minSampleSize Int       @default(10) @map("min_sample_size")

  // Results
  status                  String  @default("running") @db.VarChar(50) // running, completed, cancelled
  results                 Json?   @db.JsonB
  winningTemplateId       String? @map("winning_template_id") @db.Uuid
  statisticalSignificance Float?  @map("statistical_significance") @db.Real // p-value

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  templateA       ARIndustryTemplate  @relation("TemplateA", fields: [templateAId], references: [id], onDelete: Cascade)
  templateB       ARIndustryTemplate  @relation("TemplateB", fields: [templateBId], references: [id], onDelete: Cascade)
  winningTemplate ARIndustryTemplate? @relation("WinningTemplate", fields: [winningTemplateId], references: [id], onDelete: SetNull)
  organization    Organization        @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([status])
  @@index([startDate])
  @@map("template_ab_tests")
}

// ============================================================================
// MEGA APP - VALUE STREAM TABLES (Fashion Value Stream Integration)
// ============================================================================

/// Value Stream Artifacts (Core data flowing between modules)
model ValueStreamArtifact {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  moduleId       String @map("module_id") @db.VarChar(100)

  // Versioning
  version           Int     @default(1)
  previousVersionId String? @map("previous_version_id") @db.Uuid

  // Status
  status String @default("draft") @db.VarChar(50) // draft, review, approved, archived

  // Data
  data Json @db.JsonB

  // Metadata
  seasonCode   String?  @map("season_code") @db.VarChar(20) // e.g., "2026SS"
  collectionId String?  @map("collection_id") @db.Uuid
  tags         String[] @default([]) @db.VarChar(100)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy String?  @map("created_by") @db.Uuid

  // Relations
  organization    Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  upstreamLinks   ArtifactLink[] @relation("DownstreamArtifact")
  downstreamLinks ArtifactLink[] @relation("UpstreamArtifact")

  @@index([organizationId, moduleId])
  @@index([organizationId, seasonCode])
  @@index([organizationId, status])
  @@index([collectionId])
  @@map("value_stream_artifacts")
}

/// Artifact Links (Lineage tracking between artifacts)
model ArtifactLink {
  id               String @id @default(uuid()) @db.Uuid
  upstreamId       String @map("upstream_id") @db.Uuid
  downstreamId     String @map("downstream_id") @db.Uuid
  relationshipType String @map("relationship_type") @db.VarChar(50) // source, derived, reference

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  upstream   ValueStreamArtifact @relation("UpstreamArtifact", fields: [upstreamId], references: [id], onDelete: Cascade)
  downstream ValueStreamArtifact @relation("DownstreamArtifact", fields: [downstreamId], references: [id], onDelete: Cascade)

  @@unique([upstreamId, downstreamId])
  @@index([upstreamId])
  @@index([downstreamId])
  @@map("artifact_links")
}

/// Mega App Module Definitions (Stored module metadata)
model MegaAppModule {
  id             String @id @db.VarChar(100) // e.g., "fashion-research"
  organizationId String @map("organization_id") @db.Uuid

  name        String  @db.VarChar(255)
  description String? @db.Text
  version     String  @db.VarChar(50)

  // Schemas
  inputSchema  Json @map("input_schema") @db.JsonB
  outputSchema Json @map("output_schema") @db.JsonB

  // Dependencies
  requiredInputs String[] @default([]) @map("required_inputs") @db.VarChar(100)
  optionalInputs String[] @default([]) @map("optional_inputs") @db.VarChar(100)

  // Executor
  executorType   String @map("executor_type") @db.VarChar(50) // ai-agent, workflow, mcp-tool, hybrid
  executorConfig Json   @map("executor_config") @db.JsonB

  // Status
  enabled Boolean @default(true)
  status  String  @default("draft") @db.VarChar(50) // draft, active, deprecated

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, id])
  @@index([organizationId, enabled])
  @@map("mega_app_modules")
}

/// Mega App Roles (Pre-configured permission templates)
model MegaAppRole {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  name        String  @db.VarChar(100) // e.g., "MD", "Designer", "Production Manager"
  description String? @db.Text

  // Default module permissions for this role
  defaultPermissions Json @map("default_permissions") @db.JsonB

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  memberships       Membership[]
  modulePermissions ModulePermission[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("mega_app_roles")
}

/// Module Permissions (Per-module access control)
model ModulePermission {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  moduleId       String @map("module_id") @db.VarChar(100)

  // Who (one of these must be set)
  userId        String? @map("user_id") @db.Uuid // Specific user override
  megaAppRoleId String? @map("mega_app_role_id") @db.Uuid // Role-based default

  // What permissions
  canView      Boolean @default(false) @map("can_view")
  canExecute   Boolean @default(false) @map("can_execute")
  canCreate    Boolean @default(false) @map("can_create")
  canApprove   Boolean @default(false) @map("can_approve")
  canConfigure Boolean @default(false) @map("can_configure")
  canDelete    Boolean @default(false) @map("can_delete")

  // Data visibility
  dataScope String @default("own") @map("data_scope") @db.VarChar(50) // own, team, all

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  megaAppRole  MegaAppRole? @relation(fields: [megaAppRoleId], references: [id], onDelete: Cascade)

  @@unique([organizationId, moduleId, userId])
  @@unique([organizationId, moduleId, megaAppRoleId])
  @@index([organizationId])
  @@index([userId])
  @@index([megaAppRoleId])
  @@map("module_permissions")
}

/// Feature Requests (Captured from various channels)
model FeatureRequest {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  // Source
  source      String  @db.VarChar(50) // slack, web, notion, email
  sourceRef   String? @map("source_ref") @db.Text // message ID, page ID, etc.
  requesterId String? @map("requester_id") @db.Uuid

  // Content
  rawContent     String  @map("raw_content") @db.Text // Original request text
  analyzedIntent String? @map("analyzed_intent") @db.Text // AI-extracted intent

  // Categorization
  relatedModules String[] @default([]) @map("related_modules") @db.VarChar(100)
  tags           String[] @default([]) @db.VarChar(100)

  // Prioritization
  priority       Int     @default(3) // 0=Critical, 1=High, 2=Medium, 3=Low
  businessImpact String? @map("business_impact") @db.VarChar(50)
  requestCount   Int     @default(1) @map("request_count") // Duplicate aggregation

  // Status
  status String @default("new") @db.VarChar(50) // new, analyzing, backlog, planning, developing, released

  // Linking
  parentRequestId String? @map("parent_request_id") @db.Uuid // Merged into
  linkedModuleId  String? @map("linked_module_id") @db.VarChar(100) // When implemented

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  embedding    FeatureRequestEmbedding?

  @@index([organizationId, status])
  @@index([organizationId, priority])
  @@index([relatedModules])
  @@map("feature_requests")
}

/// Feature Request Embeddings (Vector embeddings for semantic similarity)
model FeatureRequestEmbedding {
  id               String   @id @default(uuid()) @db.Uuid
  featureRequestId String   @unique @map("feature_request_id") @db.Uuid
  embedding        Float[] // Vector embedding array
  contentHash      String   @map("content_hash") @db.VarChar(50)
  generatedAt      DateTime @default(now()) @map("generated_at") @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  featureRequest FeatureRequest @relation(fields: [featureRequestId], references: [id], onDelete: Cascade)

  @@index([generatedAt])
  @@map("feature_request_embeddings")
}

/// Mega App Agent Teams (Hierarchical agent organization - different from core Team)
model MegaAppTeam {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  name        String  @db.VarChar(255)
  description String? @db.Text

  // Hierarchy
  parentTeamId String? @map("parent_team_id") @db.Uuid
  moduleId     String? @map("module_id") @db.VarChar(100) // Primary module responsibility

  // Lead agent
  leadAgentId String? @map("lead_agent_id") @db.Uuid

  // Configuration
  maxAgents     Int    @default(5) @map("max_agents")
  scalingPolicy String @default("manual") @map("scaling_policy") @db.VarChar(50) // manual, auto, demand-based

  // Status
  status String @default("active") @db.VarChar(50)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parentTeam   MegaAppTeam?  @relation("MegaAppTeamHierarchy", fields: [parentTeamId], references: [id])
  childTeams   MegaAppTeam[] @relation("MegaAppTeamHierarchy")

  @@index([organizationId])
  @@index([parentTeamId])
  @@index([moduleId])
  @@map("mega_app_teams")
}

/// Agent Scaling Rules (Auto-scaling configuration for MegaAppTeams)
model AgentScalingRule {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  teamId         String @map("team_id") @db.Uuid

  // Trigger conditions
  triggerType  String @map("trigger_type") @db.VarChar(50) // queue-depth, latency, schedule
  triggerValue Int    @map("trigger_value") // threshold value

  // Action
  action        String @db.VarChar(50) // scale-up, scale-down
  agentCount    Int    @map("agent_count")
  agentTemplate String @map("agent_template") @db.VarChar(100) // Which agent type to spawn

  // Limits
  minAgents       Int @default(1) @map("min_agents")
  maxAgents       Int @default(10) @map("max_agents")
  cooldownMinutes Int @default(5) @map("cooldown_minutes")

  enabled Boolean @default(true)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([organizationId])
  @@map("agent_scaling_rules")
}

/// Value Stream Templates (Pre-defined flows)
model ValueStreamTemplate {
  id             String  @id @default(uuid()) @db.Uuid
  organizationId String? @map("organization_id") @db.Uuid // NULL = global template

  name        String  @db.VarChar(255)
  description String? @db.Text

  // Flow definition
  moduleOrder String[] @map("module_order") @db.VarChar(100)
  flowConfig  Json     @map("flow_config") @db.JsonB

  // Usage
  isPublic   Boolean @default(false) @map("is_public")
  usageCount Int     @default(0) @map("usage_count")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId])
  @@index([isPublic])
  @@map("value_stream_templates")
}

// ============================================================================
// ENTERPRISE RESOURCE REGISTRY (ERR) - Resource Mapping System
// ============================================================================

/// Resource Provider Types
/// External data sources that can be connected
enum ResourceProviderType {
  notion_database
  google_sheets
  slack_canvas
  jira_project
  confluence_page
  clickup_list
  airtable_base
  custom_api
}

/// Internal Resource Types
/// Standard resource types recognized by the system
enum InternalResourceType {
  vision
  mission
  goal
  objective
  key_result
  strategy
  business_model
  value_stream
  project
  task
  department
  position
  kpi
  custom
}

/// Sync Direction
/// How data flows between external and internal systems
enum SyncDirection {
  pull_only
  push_only
  bidirectional
  manual
}

/// Resource Provider Connection
/// Stores connection details to external resource providers
model ResourceProviderConnection {
  id             String               @id @default(uuid()) @db.Uuid
  organizationId String               @map("organization_id") @db.Uuid
  providerType   ResourceProviderType @map("provider_type")
  displayName    String               @map("display_name") @db.VarChar(255)

  // Connection credentials (encrypted)
  credentials   Json    @default("{}") @db.JsonB // Encrypted tokens, API keys
  connectionUrl String? @map("connection_url") @db.Text // Base URL for API

  // Status
  status          String    @default("active") @db.VarChar(50) // active, inactive, error
  lastValidatedAt DateTime? @map("last_validated_at") @db.Timestamptz(6)
  validationError String?   @map("validation_error") @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  mappings     ResourceMapping[]
  syncLogs     ResourceSyncLog[]

  @@index([organizationId])
  @@index([providerType])
  @@index([status])
  @@map("resource_provider_connections")
}

/// Resource Mapping
/// Maps external resources to internal resource types
model ResourceMapping {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  connectionId   String @map("connection_id") @db.Uuid

  // External resource identification
  externalResourceId   String @map("external_resource_id") @db.VarChar(500) // Notion DB ID, Sheet ID, etc.
  externalResourceName String @map("external_resource_name") @db.VarChar(500) // Human-readable name

  // Internal mapping
  internalType   InternalResourceType @map("internal_type")
  customTypeName String?              @map("custom_type_name") @db.VarChar(100) // If internalType is 'custom'
  typeSchemaId   String?              @map("type_schema_id") @db.Uuid

  // Field mappings
  fieldMappings Json @default("{}") @map("field_mappings") @db.JsonB // {externalField: internalField, ...}

  // Sync configuration
  syncDirection SyncDirection @default(pull_only) @map("sync_direction")
  syncSchedule  String?       @map("sync_schedule") @db.VarChar(100) // Cron expression
  lastSyncAt    DateTime?     @map("last_sync_at") @db.Timestamptz(6)
  syncError     String?       @map("sync_error") @db.Text

  // AI detection confidence
  detectionConfidence Float? @map("detection_confidence") @db.Real // 0-1, from AI schema detection

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization  Organization               @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  connection    ResourceProviderConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  typeSchema    ResourceTypeSchema?        @relation(fields: [typeSchemaId], references: [id], onDelete: SetNull)
  linkedRecords ResourceLinkedRecord[]
  syncLogs      ResourceSyncLog[]

  @@unique([connectionId, externalResourceId])
  @@index([organizationId])
  @@index([connectionId])
  @@index([internalType])
  @@index([isActive])
  @@map("resource_mappings")
}

/// Resource Linked Record
/// Individual records synced from external sources
model ResourceLinkedRecord {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  mappingId      String @map("mapping_id") @db.Uuid

  // External record identification
  externalRecordId String @map("external_record_id") @db.VarChar(500) // Row ID, Page ID, etc.

  // Cached data from external source
  cachedData    Json      @default("{}") @map("cached_data") @db.JsonB
  lastFetchedAt DateTime? @map("last_fetched_at") @db.Timestamptz(6)

  // Link to internal record (if exists)
  internalRecordId   String? @map("internal_record_id") @db.Uuid // Reference to internal entity
  internalRecordType String? @map("internal_record_type") @db.VarChar(100) // Table name

  // Sync status
  syncStatus String    @default("synced") @map("sync_status") @db.VarChar(50) // synced, pending, conflict, error
  lastSyncAt DateTime? @map("last_sync_at") @db.Timestamptz(6)
  syncError  String?   @map("sync_error") @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  mapping      ResourceMapping @relation(fields: [mappingId], references: [id], onDelete: Cascade)

  @@unique([mappingId, externalRecordId])
  @@index([organizationId])
  @@index([mappingId])
  @@index([externalRecordId])
  @@index([internalRecordId])
  @@index([syncStatus])
  @@map("resource_linked_records")
}

/// Resource Sync Log
/// Audit trail for synchronization operations
model ResourceSyncLog {
  id             String  @id @default(uuid()) @db.Uuid
  organizationId String  @map("organization_id") @db.Uuid
  connectionId   String? @map("connection_id") @db.Uuid
  mappingId      String? @map("mapping_id") @db.Uuid

  // Sync operation details
  operation   String @db.VarChar(50) // pull, push, detect, validate
  status      String @db.VarChar(50) // started, completed, failed
  triggeredBy String @map("triggered_by") @db.VarChar(100) // user:id, scheduler, manual

  // Statistics
  recordsProcessed Int @default(0) @map("records_processed")
  recordsCreated   Int @default(0) @map("records_created")
  recordsUpdated   Int @default(0) @map("records_updated")
  recordsDeleted   Int @default(0) @map("records_deleted")
  recordsFailed    Int @default(0) @map("records_failed")

  // Timing
  startedAt   DateTime  @map("started_at") @db.Timestamptz(6)
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)
  durationMs  Int?      @map("duration_ms")

  // Error details
  errorMessage String? @map("error_message") @db.Text
  errorDetails Json?   @map("error_details") @db.JsonB

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  organization Organization                @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  connection   ResourceProviderConnection? @relation(fields: [connectionId], references: [id], onDelete: SetNull)
  mapping      ResourceMapping?            @relation(fields: [mappingId], references: [id], onDelete: SetNull)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([connectionId])
  @@index([mappingId])
  @@index([operation])
  @@index([status])
  @@map("resource_sync_logs")
}

/// Resource Type Schema
/// Defines expected schema for each resource type (with AI hints)
model ResourceTypeSchema {
  id             String               @id @default(uuid()) @db.Uuid
  organizationId String?              @map("organization_id") @db.Uuid // NULL for global/built-in schemas
  internalType   InternalResourceType @map("internal_type")
  customTypeName String?              @map("custom_type_name") @db.VarChar(100) // For custom types

  displayName String  @map("display_name") @db.VarChar(255)
  description String? @db.Text

  // Schema definition
  fields Json @db.JsonB // [{name, type, required, description, aiHints}]

  // AI detection hints
  aiDetectionKeywords String[] @default([]) @map("ai_detection_keywords") @db.VarChar(100) // Keywords AI looks for
  aiDetectionPatterns Json     @default("[]") @map("ai_detection_patterns") @db.JsonB // Regex patterns for field detection

  // Examples for AI learning
  exampleData Json @default("[]") @map("example_data") @db.JsonB // Sample data for pattern matching

  isBuiltIn Boolean  @default(false) @map("is_built_in")
  version   Int      @default(1)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization?     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  mappings     ResourceMapping[]

  @@unique([organizationId, internalType, customTypeName])
  @@index([organizationId])
  @@index([internalType])
  @@index([isBuiltIn])
  @@map("resource_type_schemas")
}

// ============================================================================
// CODE OPERATION SYSTEM
// Self-modifying agent system for autonomous code changes
// ============================================================================

/// Code Operation Type
enum CodeOperationType {
  debug
  implement
  refactor
  fix
  test
}

/// Code Operation Status
enum CodeOperationStatus {
  queued
  cloning
  analyzing
  executing
  testing
  scanning
  committing
  pushing
  creating_pr
  completed
  failed
  cancelled
}

/// Code Operation
/// Tracks autonomous code modification operations
model CodeOperation {
  id             String              @id @default(uuid()) @db.Uuid
  organizationId String              @map("organization_id") @db.Uuid

  // Operation details
  operationType  CodeOperationType   @map("operation_type")
  status         CodeOperationStatus @default(queued)
  description    String              @db.Text

  // Repository info
  repoOwner      String              @map("repo_owner") @db.VarChar(255)
  repoName       String              @map("repo_name") @db.VarChar(255)
  baseBranch     String              @map("base_branch") @db.VarChar(255)
  workingBranch  String?             @map("working_branch") @db.VarChar(255)

  // Context
  targetFiles    String[]            @default([]) @map("target_files")
  errorContext   Json?               @map("error_context") @db.JsonB
  featureContext Json?               @map("feature_context") @db.JsonB

  // User/Agent info
  userId         String?             @map("user_id") @db.Uuid
  agentId        String?             @map("agent_id") @db.Uuid
  agentPosition  Int                 @default(0) @map("agent_position")

  // Slack integration
  slackChannel   String?             @map("slack_channel") @db.VarChar(255)
  slackThreadTs  String?             @map("slack_thread_ts") @db.VarChar(255)
  slackTeamId    String?             @map("slack_team_id") @db.VarChar(255)

  // Result tracking
  filesModified  String[]            @default([]) @map("files_modified")
  commits        Json                @default("[]") @db.JsonB
  prNumber       Int?                @map("pr_number")
  prUrl          String?             @map("pr_url") @db.Text

  // Execution metrics
  iterations     Int                 @default(0)
  startedAt      DateTime?           @map("started_at") @db.Timestamptz(6)
  completedAt    DateTime?           @map("completed_at") @db.Timestamptz(6)
  durationMs     Int?                @map("duration_ms")

  // Error tracking
  errorMessage   String?             @map("error_message") @db.Text
  errorStep      String?             @map("error_step") @db.VarChar(255)

  // Safety
  approvalRequired Boolean           @default(true) @map("approval_required")
  approvedBy     String?             @map("approved_by") @db.Uuid
  approvedAt     DateTime?           @map("approved_at") @db.Timestamptz(6)

  // Audit
  aiLogs         Json                @default("[]") @map("ai_logs") @db.JsonB
  secretsScanned Boolean             @default(false) @map("secrets_scanned")

  createdAt      DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  agent          Agent?              @relation(fields: [agentId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([status])
  @@index([operationType])
  @@index([userId])
  @@index([agentId])
  @@index([createdAt(sort: Desc)])
  @@map("code_operations")
}
