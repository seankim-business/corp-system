// Prisma Schema for Kyndof Corp System
// Multi-tenant SaaS with Google Workspace integration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE MULTI-TENANT TABLES
// ============================================================================

/// Organizations (Tenants)
/// Each organization represents a separate company/workspace
model Organization {
  id                     String    @id @default(uuid()) @db.Uuid
  slug                   String    @unique @db.VarChar(50) // Subdomain: kyndof, clientco
  name                   String    @db.VarChar(255)
  logoUrl                String?   @map("logo_url") @db.Text
  settings               Json      @default("{}") @db.JsonB
  monthlyBudgetCents     Int?      @map("monthly_budget_cents")
  currentMonthSpendCents Int       @default(0) @map("current_month_spend_cents")
  budgetResetAt          DateTime? @map("budget_reset_at") @db.Timestamptz(6)
  createdAt              DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  workspaceDomains       WorkspaceDomain[]
  memberships            Membership[]
  agents                 Agent[]
  teams                  Team[]
  projects               Project[]
  tasks                  Task[]
  goals                  Goal[]
  valueStreams           ValueStream[]
  kpis                   KPI[]
  workflows              Workflow[]
  notionConnections      NotionConnection[]
  mcpConnections         MCPConnection[]
  slackIntegrations      SlackIntegration[]
  orchestratorExecutions OrchestratorExecution[]
  featureFlagOverrides   FeatureFlagOverride[]
  featureFlagAuditLogs   FeatureFlagAuditLog[]
  aiProvider             OrganizationAIProvider?
  functions              Function[]
  skills                 Skill[]
  sops                   Sop[]

  @@map("organizations")
}

/// Users (Global identity)
/// One user can belong to multiple organizations
model User {
  id            String   @id @default(uuid()) @db.Uuid
  email         String   @unique @db.VarChar(255)
  passwordHash  String?  @map("password_hash") @db.VarChar(255) // NULL for Google-only users
  googleId      String?  @unique @map("google_id") @db.VarChar(255) // Google OAuth sub
  displayName   String?  @map("display_name") @db.VarChar(255)
  avatarUrl     String?  @map("avatar_url") @db.Text
  emailVerified Boolean  @default(false) @map("email_verified")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  memberships            Membership[]
  sessions               Session[]
  orchestratorExecutions OrchestratorExecution[]
  featureFlagAuditLogs   FeatureFlagAuditLog[]

  @@index([email])
  @@index([googleId])
  @@map("users")
}

/// Memberships (User ↔ Organization relationship)
/// Defines user's role and permissions within an organization
model Membership {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  role           String    @db.VarChar(50) // owner, admin, member
  permissions    Json      @default("{}") @db.JsonB
  invitedBy      String?   @map("invited_by") @db.Uuid
  invitedAt      DateTime  @default(now()) @map("invited_at") @db.Timestamptz(6)
  joinedAt       DateTime? @map("joined_at") @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Daily briefing preferences
  dailyBriefingEnabled  Boolean @default(false) @map("daily_briefing_enabled")
  dailyBriefingTime     String  @default("09:00") @map("daily_briefing_time") @db.VarChar(5)
  dailyBriefingTimezone String  @default("UTC") @map("daily_briefing_timezone") @db.VarChar(50)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("memberships")
}

/// Workspace Domains (Google Workspace domains)
/// Links Google Workspace domains to organizations
model WorkspaceDomain {
  id                String    @id @default(uuid()) @db.Uuid
  organizationId    String    @map("organization_id") @db.Uuid
  domain            String    @unique @db.VarChar(255) // nubabel.com, client-company.com
  verified          Boolean   @default(false)
  verificationToken String?   @map("verification_token") @db.VarChar(255)
  verifiedAt        DateTime? @map("verified_at") @db.Timestamptz(6)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, domain])
  @@index([organizationId])
  @@index([domain])
  @@map("workspace_domains")
}

/// Sessions (Enhanced for Orchestrator + JWT)
/// Tracks both authentication sessions AND orchestrator conversation sessions
model Session {
  id             String   @id @db.VarChar(255) // Can be UUID or ses_xxx format
  userId         String   @map("user_id") @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  tokenHash      String?  @unique @map("token_hash") @db.VarChar(255) // NULL for orchestrator sessions
  source         String?  @db.VarChar(50) // slack, web, terminal, api (for orchestrator)
  state          Json     @default("{}") @db.JsonB // Orchestrator state
  history        Json     @default("[]") @db.JsonB // Conversation history
  metadata       Json     @default("{}") @db.JsonB // Additional data
  expiresAt      DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  lastUsedAt     DateTime @default(now()) @map("last_used_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Session hijacking prevention
  ipAddress String? @map("ip_address") @db.VarChar(45)
  userAgent String? @map("user_agent") @db.Text

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([organizationId, expiresAt])
  @@index([tokenHash])
  @@index([expiresAt])
  @@index([source])
  @@map("sessions")
}

// ============================================================================
// AGENT HIERARCHY TABLES (Dynamic Team Management)
// ============================================================================

/// Agents (AI Agents - both permanent and temporary)
model Agent {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  name           String    @db.VarChar(100) // designer-bokyung, pm-killin-it-girl
  type           String    @db.VarChar(50) // permanent, temporary, contractor
  role           String    @db.Text // "K-POP 무대 의상 디자이너"
  managerId      String?   @map("manager_id") @db.Uuid // Reports to which agent
  teamId         String?   @map("team_id") @db.Uuid
  functionId     String?   @map("function_id") @db.Uuid
  skills         String[]  @db.VarChar(100) // [fashion-design, clo3d, adobe-suite]
  sessionId      String?   @map("session_id") @db.VarChar(255) // Persistent session for continuity
  hiredAt        DateTime  @default(now()) @map("hired_at") @db.Timestamptz(6)
  contractEnd    DateTime? @map("contract_end") @db.Timestamptz(6) // NULL for permanent
  projectId      String?   @map("project_id") @db.Uuid // For project-based agents
  status         String    @default("active") @db.VarChar(50) // active, inactive, archived
  metadata       Json      @default("{}") @db.JsonB
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  manager      Agent?       @relation("AgentHierarchy", fields: [managerId], references: [id])
  subordinates Agent[]      @relation("AgentHierarchy")
  team         Team?        @relation(fields: [teamId], references: [id])
  function     Function?    @relation(fields: [functionId], references: [id])
  agentSkills  AgentSkill[]

  @@index([organizationId])
  @@index([managerId])
  @@index([teamId])
  @@index([functionId])
  @@index([type])
  @@index([status])
  @@map("agents")
}

/// Teams (Groups of agents)
model Team {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String   @db.VarChar(255)
  leaderId       String?  @map("leader_id") @db.Uuid // Team leader
  type           String   @db.VarChar(50) // permanent, temporary, taskforce
  maxMembers     Int?     @map("max_members")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agents       Agent[]

  @@index([organizationId])
  @@map("teams")
}

// ============================================================================
// FUNCTION & SKILL TABLES (Organizational structure)
// ============================================================================

/// Function (기능 조직 - Functional organization units)
model Function {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String   @db.VarChar(255)
  nameKo         String?  @map("name_ko") @db.VarChar(255) // Korean name
  description    String?  @db.Text
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agents       Agent[]
  sops         Sop[]

  @@index([organizationId])
  @@map("functions")
}

/// Skill (Capabilities that agents can possess)
model Skill {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  skillId        String   @unique @map("skill_id") @db.VarChar(100) // e.g., "campaign-brief-creation"
  name           String   @db.VarChar(255)
  description    String?  @db.Text
  category       String?  @db.VarChar(100)
  triggers       String[] @default([]) @db.VarChar(255) // keywords that trigger this skill
  parameters     Json?    @db.JsonB // input parameters schema
  outputs        Json?    @db.JsonB // output schema
  toolsRequired  String[] @default([]) @map("tools_required") @db.VarChar(100) // MCP tools needed
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agents       AgentSkill[]

  @@index([organizationId])
  @@index([skillId])
  @@index([category])
  @@map("skills")
}

/// AgentSkill (Many-to-many relationship between agents and skills)
model AgentSkill {
  id        String   @id @default(uuid()) @db.Uuid
  agentId   String   @map("agent_id") @db.Uuid
  skillId   String   @map("skill_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)
  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([agentId, skillId])
  @@index([agentId])
  @@index([skillId])
  @@map("agent_skills")
}

/// Sop (Standard Operating Procedures)
model Sop {
  id               String   @id @default(uuid()) @db.Uuid
  organizationId   String   @map("organization_id") @db.Uuid
  sopId            String   @unique @map("sop_id") @db.VarChar(100) // e.g., "customer-onboarding"
  name             String   @db.VarChar(255)
  description      String?  @db.Text
  functionId       String?  @map("function_id") @db.Uuid
  steps            Json     @db.JsonB // array of step definitions
  triggers         String[] @default([]) @db.VarChar(255)
  approvalRequired Boolean  @default(false) @map("approval_required")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  function     Function?       @relation(fields: [functionId], references: [id])
  executions   SopExecution[]

  @@index([organizationId])
  @@index([sopId])
  @@index([functionId])
  @@map("sops")
}

/// SopExecution (Tracks SOP execution history)
model SopExecution {
  id             String    @id @default(uuid()) @db.Uuid
  sopId          String    @map("sop_id") @db.Uuid
  status         String    @db.VarChar(50) // pending, in_progress, completed, failed
  currentStep    Int       @default(0) @map("current_step")
  stepResults    Json      @default("[]") @map("step_results") @db.JsonB
  inputData      Json?     @map("input_data") @db.JsonB
  outputData     Json?     @map("output_data") @db.JsonB
  errorMessage   String?   @map("error_message") @db.Text
  startedAt      DateTime? @map("started_at") @db.Timestamptz(6)
  completedAt    DateTime? @map("completed_at") @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  sop Sop @relation(fields: [sopId], references: [id], onDelete: Cascade)

  @@index([sopId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("sop_executions")
}

// ============================================================================
// BUSINESS DATA TABLES (Tenant-scoped)
// ============================================================================

/// Projects
model Project {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  name           String    @db.VarChar(255)
  status         String    @db.VarChar(50)
  ownerId        String?   @map("owner_id") @db.Uuid
  startDate      DateTime? @map("start_date") @db.Date
  dueDate        DateTime? @map("due_date") @db.Date
  progress       Int       @default(0)
  budget         Decimal?  @db.Decimal(15, 2)
  description    String?   @db.Text
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tasks        Task[]

  @@index([organizationId, id])
  @@index([organizationId, createdAt(sort: Desc)])
  @@map("projects")
}

/// Tasks (RABSIC-enabled)
model Task {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @map("organization_id") @db.Uuid
  projectId       String?   @map("project_id") @db.Uuid
  name            String    @db.VarChar(500)
  status          String    @db.VarChar(50) // 1_ToDo, 2_InProgress, 5_Done
  dueDate         DateTime? @map("due_date") @db.Date
  urgencyScore    Int?      @default(0) @map("urgency_score")
  importanceScore Int?      @default(0) @map("importance_score")
  eisenhowerQuad  String?   @map("eisenhower_quadrant") @db.VarChar(50)

  // RABSIC fields
  responsible String[] @db.Uuid
  accountable String[] @db.Uuid // Must be exactly 1
  backup      String[] @db.Uuid
  support     String[] @db.Uuid
  informed    String[] @db.Uuid
  consulted   String[] @db.Uuid

  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project?     @relation(fields: [projectId], references: [id])

  @@index([organizationId, id])
  @@index([organizationId, status])
  @@index([organizationId, dueDate])
  @@index([organizationId, projectId])
  @@map("tasks")
}

/// Goals (Hierarchical)
model Goal {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @map("organization_id") @db.Uuid
  title           String    @db.VarChar(500)
  status          String    @db.VarChar(50)
  ownerPositionId String?   @map("owner_position_id") @db.Uuid
  dueDate         DateTime? @map("due_date") @db.Date
  progress        Int       @default(0)
  parentGoalId    String?   @map("parent_goal_id") @db.Uuid
  description     String?   @db.Text
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parentGoal   Goal?        @relation("GoalHierarchy", fields: [parentGoalId], references: [id])
  subGoals     Goal[]       @relation("GoalHierarchy")

  @@index([organizationId, id])
  @@index([parentGoalId])
  @@map("goals")
}

/// Value Streams (Business processes)
model ValueStream {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String   @db.VarChar(500)
  functions      String   @db.VarChar(100) // MD, Fashion Design, Marketing, CS, Sales
  type           String   @db.VarChar(50)
  input          String?  @db.Text
  output         String?  @db.Text
  parentId       String?  @map("parent_id") @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parent       ValueStream?  @relation("ValueStreamHierarchy", fields: [parentId], references: [id])
  subStreams   ValueStream[] @relation("ValueStreamHierarchy")

  @@index([organizationId, id])
  @@index([parentId])
  @@map("value_streams")
}

/// KPIs (Key Performance Indicators)
model KPI {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @map("organization_id") @db.Uuid
  name            String    @db.VarChar(255)
  status          String    @db.VarChar(50)
  ownerRoleId     String?   @map("owner_role_id") @db.Uuid
  target          String?   @db.VarChar(255)
  currentValue    Decimal?  @map("current_value") @db.Decimal(15, 2)
  unit            String?   @db.VarChar(50)
  updateFrequency String?   @map("update_frequency") @db.VarChar(50)
  dataSource      String?   @map("data_source") @db.Text
  upToDate        Boolean   @default(true) @map("up_to_date")
  lastUpdated     DateTime? @map("last_updated") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, id])
  @@map("kpis")
}

// ============================================================================
// WORKFLOW AUTOMATION TABLES (Phase 2 Week 3-4)
// ============================================================================

/// Workflows (Automation definitions)
model Workflow {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String   @db.VarChar(255)
  description    String?  @db.Text
  config         Json     @default("{}") @db.JsonB
  enabled        Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // SOP (Standard Operating Procedure) fields
  sopEnabled Boolean @default(false) @map("sop_enabled")
  sopSteps   Json?   @map("sop_steps") @db.JsonB // Array of step definitions

  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  executions   WorkflowExecution[]

  @@index([organizationId])
  @@index([organizationId, enabled])
  @@map("workflows")
}

/// Workflow Executions (Execution history)
model WorkflowExecution {
  id           String    @id @default(uuid()) @db.Uuid
  workflowId   String    @map("workflow_id") @db.Uuid
  status       String    @db.VarChar(50)
  inputData    Json?     @map("input_data") @db.JsonB
  outputData   Json?     @map("output_data") @db.JsonB
  errorMessage String?   @map("error_message") @db.Text
  startedAt    DateTime? @map("started_at") @db.Timestamptz(6)
  completedAt  DateTime? @map("completed_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("workflow_executions")
}

/// Orchestrator Executions (Conversation / delegation history)
/// Separate from WorkflowExecution to avoid mixing automation runs with orchestration.
model OrchestratorExecution {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  userId         String @map("user_id") @db.Uuid
  sessionId      String @map("session_id") @db.VarChar(255)

  category String   @db.VarChar(100)
  skills   String[] @default([]) @db.VarChar(100)
  status   String   @db.VarChar(50)
  duration Int      @default(0)

  inputData    Json?   @map("input_data") @db.JsonB
  outputData   Json?   @map("output_data") @db.JsonB
  errorMessage String? @map("error_message") @db.Text
  metadata     Json?   @default("{}") @db.JsonB

  // SOP execution tracking
  currentStep Int?  @map("current_step")
  stepResults Json? @map("step_results") @db.JsonB

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([organizationId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@index([sessionId])
  @@index([status])
  @@map("orchestrator_executions")
}

// ============================================================================
// MCP INTEGRATION TABLES (Phase 2 Week 9-12)
// ============================================================================

/// Generic MCP Connections (Organization-level integrations)
/// Supports: Notion, Linear, Jira, Asana, Airtable, etc.
model MCPConnection {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  provider       String    @db.VarChar(100) // notion, linear, jira, asana, airtable, etc.
  namespace      String    @db.VarChar(100) // MCP namespace/scope identifier
  name           String    @db.VarChar(255) // User-friendly name
  config         Json      @db.JsonB // Provider-specific config (API keys, tokens, etc.)
  refreshToken   String?   @map("refresh_token") @db.Text // OAuth refresh token (encrypted)
  expiresAt      DateTime? @map("expires_at") @db.Timestamptz(6) // Token expiration timestamp
  enabled        Boolean   @default(true)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, enabled])
  @@index([provider])
  @@index([namespace])
  @@map("mcp_connections")
}

/// Legacy Notion Connections (Backward compatibility)
model NotionConnection {
  id                String   @id @default(uuid()) @db.Uuid
  organizationId    String   @map("organization_id") @db.Uuid
  apiKey            String   @map("api_key") @db.VarChar(255)
  defaultDatabaseId String?  @map("default_database_id") @db.VarChar(255)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId])
  @@index([organizationId])
  @@map("notion_connections")
}

// ============================================================================
// SLACK INTEGRATION TABLES (Phase 2 Week 9-12 - Multi-Tenant)
// ============================================================================

/// Slack Integrations (Per-organization Slack workspaces)
/// Replaces hardcoded SLACK_BOT_TOKEN environment variable
model SlackIntegration {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  workspaceId    String @unique @map("workspace_id") @db.VarChar(50) // Slack Team ID (T01234ABCD)
  workspaceName  String @map("workspace_name") @db.VarChar(255) // Friendly name

  // OAuth tokens (encrypted in application layer before storage)
  botToken String  @map("bot_token") @db.Text // xoxb-... (encrypted)
  appToken String? @map("app_token") @db.Text // xapp-... (encrypted, for Socket Mode)

  // Security
  signingSecret String @map("signing_secret") @db.Text // Webhook verification (encrypted)

  // OAuth metadata
  botUserId String?  @map("bot_user_id") @db.VarChar(50) // U01234ABCD
  scopes    String[] @default([]) @db.VarChar(100) // [app_mentions:read, chat:write, ...]

  // Installation metadata
  installedBy String?  @map("installed_by") @db.Uuid // Which user authorized
  installedAt DateTime @default(now()) @map("installed_at") @db.Timestamptz(6)

  // Status
  enabled         Boolean   @default(true)
  lastHealthCheck DateTime? @map("last_health_check") @db.Timestamptz(6)
  healthStatus    String    @default("unknown") @map("health_status") @db.VarChar(50) // healthy, degraded, offline, unknown

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, workspaceId])
  @@index([organizationId])
  @@index([workspaceId])
  @@index([enabled])
  @@map("slack_integrations")
}

/// SlackUser (Maps Slack users to Nubabel users)
model SlackUser {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  slackUserId    String   @map("slack_user_id") @db.VarChar(50) // U01234ABCD
  userId         String?  @map("user_id") @db.Uuid // Link to Nubabel user (nullable for unlinked)
  slackUsername  String?  @map("slack_username") @db.VarChar(255)
  slackEmail     String?  @map("slack_email") @db.VarChar(255)
  isBot          Boolean  @default(false) @map("is_bot")
  metadata       Json     @default("{}") @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([organizationId, slackUserId])
  @@index([organizationId])
  @@index([slackUserId])
  @@index([userId])
  @@map("slack_users")
}

/// SlackWorkspace (Additional workspace metadata)
model SlackWorkspace {
  id                 String   @id @default(uuid()) @db.Uuid
  slackWorkspaceId   String   @unique @map("slack_workspace_id") @db.VarChar(50) // T01234ABCD
  name               String   @db.VarChar(255)
  domain             String?  @db.VarChar(255) // workspace.slack.com
  iconUrl            String?  @map("icon_url") @db.Text
  enterpriseId       String?  @map("enterprise_id") @db.VarChar(50) // For Enterprise Grid
  enterpriseName     String?  @map("enterprise_name") @db.VarChar(255)
  memberCount        Int?     @map("member_count")
  lastSyncAt         DateTime? @map("last_sync_at") @db.Timestamptz(6)
  metadata           Json     @default("{}") @db.JsonB
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([slackWorkspaceId])
  @@map("slack_workspaces")
}

// ==========================================================================
// FEATURE FLAGS (Safe release / rollout)
// ==========================================================================

model FeatureFlag {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique @db.VarChar(100) // e.g. "new_dashboard"
  name        String   @db.VarChar(255)
  description String?  @db.Text
  enabled     Boolean  @default(false) // Global kill switch
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  rules     FeatureFlagRule[]
  overrides FeatureFlagOverride[]
  auditLogs FeatureFlagAuditLog[]

  @@index([key])
  @@map("feature_flags")
}

model FeatureFlagRule {
  id            String @id @default(uuid()) @db.Uuid
  featureFlagId String @map("feature_flag_id") @db.Uuid

  type            String   @db.VarChar(50) // ALLOWLIST | BLOCKLIST | PERCENTAGE
  organizationIds String[] @default([]) @map("organization_ids") @db.Uuid
  percentage      Int      @default(0)
  priority        Int      @default(100)
  enabled         Boolean  @default(true)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  featureFlag FeatureFlag @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)

  @@index([featureFlagId, priority])
  @@index([enabled, priority])
  @@index([type])
  @@map("feature_flag_rules")
}

model FeatureFlagOverride {
  id             String @id @default(uuid()) @db.Uuid
  featureFlagId  String @map("feature_flag_id") @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  enabled   Boolean
  reason    String?   @db.Text
  expiresAt DateTime? @map("expires_at") @db.Timestamptz(6)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  featureFlag  FeatureFlag  @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([featureFlagId, organizationId])
  @@index([organizationId])
  @@index([expiresAt])
  @@map("feature_flag_overrides")
}

model FeatureFlagAuditLog {
  id            String @id @default(uuid()) @db.Uuid
  featureFlagId String @map("feature_flag_id") @db.Uuid

  action String @db.VarChar(50) // CREATED | UPDATED | RULE_SET | OVERRIDE_SET | EVALUATED

  organizationId String? @map("organization_id") @db.Uuid
  userId         String? @map("user_id") @db.Uuid
  metadata       Json?   @db.JsonB

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  featureFlag  FeatureFlag   @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([featureFlagId, createdAt(sort: Desc)])
  @@index([organizationId, createdAt(sort: Desc)])
  @@index([action, createdAt(sort: Desc)])
  @@map("feature_flag_audit_logs")
}

// ============================================================================
// AUDIT LOG TABLE (System-wide action tracking)
// ============================================================================

/// AuditLog (Tracks all user/system actions)
model AuditLog {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  action       String  @db.VarChar(100) // user.login, workflow.execute, etc.
  userId       String? @map("user_id") @db.Uuid
  resourceType String? @map("resource_type") @db.VarChar(100)
  resourceId   String? @map("resource_id") @db.VarChar(255)
  details      Json?   @db.JsonB
  ipAddress    String? @map("ip_address") @db.VarChar(45)
  userAgent    String? @map("user_agent") @db.Text
  success      Boolean @default(true)
  errorMessage String? @map("error_message") @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([action, createdAt(sort: Desc)])
  @@index([resourceType, resourceId])
  @@map("audit_logs")
}

// ============================================================================
// APPROVAL WORKFLOW TABLES
// ============================================================================

/// Approvals (Budget, deployment, content approvals)
model Approval {
  id                 String    @id @default(uuid()) @db.Uuid
  organizationId     String    @map("organization_id") @db.Uuid
  requesterId        String    @map("requester_id") @db.Uuid
  approverId         String    @map("approver_id") @db.Uuid
  fallbackApproverId String?   @map("fallback_approver_id") @db.Uuid
  type               String    @db.VarChar(50) // budget, deployment, content
  title              String    @db.VarChar(500)
  description        String    @db.Text
  context            Json?     @db.JsonB
  status             String    @default("pending") @db.VarChar(50) // pending, approved, rejected, expired
  responseNote       String?   @map("response_note") @db.Text
  slackMessageTs     String?   @map("slack_message_ts") @db.VarChar(50)
  slackChannelId     String?   @map("slack_channel_id") @db.VarChar(50)
  expiresAt          DateTime  @map("expires_at") @db.Timestamptz(6)
  respondedAt        DateTime? @map("responded_at") @db.Timestamptz(6)
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId, status])
  @@index([approverId, status])
  @@index([fallbackApproverId])
  @@index([requesterId])
  @@index([expiresAt])
  @@map("approvals")
}

// ============================================================================
// PERMISSION DELEGATION TABLES
// ============================================================================

/// Delegations (Permission transfers between users)
model Delegation {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  delegatorId    String    @map("delegator_id") @db.Uuid
  delegateeId    String    @map("delegatee_id") @db.Uuid
  permissions    String[]  @db.VarChar(100)
  scope          Json?     @db.JsonB
  validFrom      DateTime  @map("valid_from") @db.Timestamptz(6)
  validUntil     DateTime  @map("valid_until") @db.Timestamptz(6)
  reason         String    @db.Text
  revokedAt      DateTime? @map("revoked_at") @db.Timestamptz(6)
  revokedBy      String?   @map("revoked_by") @db.Uuid
  revokedReason  String?   @map("revoked_reason") @db.Text
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId, delegateeId])
  @@index([organizationId, delegatorId])
  @@index([delegateeId, validUntil])
  @@index([validUntil])
  @@map("delegations")
}

/// Agent Permission Overrides (Custom permissions for specific agents)
model AgentPermissionOverride {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  agentId        String   @map("agent_id") @db.Uuid
  readPatterns   String[] @default([]) @map("read_patterns") @db.VarChar(255)
  writePatterns  String[] @default([]) @map("write_patterns") @db.VarChar(255)
  tools          String[] @default([]) @db.VarChar(255)
  restricted     String[] @default([]) @db.VarChar(255)
  approvalRules  Json?    @map("approval_rules") @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([organizationId, agentId])
  @@index([organizationId])
  @@index([agentId])
  @@map("agent_permission_overrides")
}

// ============================================================================
// OKR (OBJECTIVES AND KEY RESULTS) TABLES
// ============================================================================

/// Objectives (OKR Objectives)
model Objective {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  title          String   @db.VarChar(500)
  description    String?  @db.Text
  quarter        String   @db.VarChar(10) // e.g., "2026-Q1"
  ownerId        String   @map("owner_id") @db.Uuid
  status         String   @default("on_track") @db.VarChar(50) // on_track, at_risk, behind
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  keyResults KeyResult[]

  @@index([organizationId, quarter])
  @@index([ownerId])
  @@map("objectives")
}

/// Key Results (OKR Key Results)
model KeyResult {
  id          String   @id @default(uuid()) @db.Uuid
  objectiveId String   @map("objective_id") @db.Uuid
  title       String   @db.VarChar(500)
  target      Float
  current     Float    @default(0)
  unit        String   @db.VarChar(50) // percentage, count, currency, etc.
  ownerId     String?  @map("owner_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  objective Objective @relation(fields: [objectiveId], references: [id], onDelete: Cascade)

  @@index([objectiveId])
  @@index([ownerId])
  @@map("key_results")
}

// ============================================================================
// ORGANIZATION CHANGE MANAGEMENT TABLES
// ============================================================================

/// Organization Changes (Track organizational changes and responses)
model OrganizationChange {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  title          String   @db.VarChar(500)
  description    String   @db.Text
  type           String   @db.VarChar(50) // new_agent, process_modification, integration_update, role_change
  status         String   @default("pending") @db.VarChar(50) // pending, in_progress, completed, cancelled
  impactLevel    String   @default("low") @map("impact_level") @db.VarChar(20) // low, medium, high
  requestedBy    String   @map("requested_by") @db.Uuid
  impactAnalysis String?  @map("impact_analysis") @db.Text
  prUrl          String?  @map("pr_url") @db.Text
  metadata       Json?    @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId, status])
  @@index([requestedBy])
  @@index([type])
  @@index([impactLevel])
  @@map("organization_changes")
}

// ============================================================================
// GOOGLE DRIVE INTEGRATION TABLES
// ============================================================================

/// Drive Connections (Google Drive OAuth connections)
model DriveConnection {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @unique @map("organization_id") @db.Uuid
  accessToken     String    @map("access_token") @db.Text // Encrypted
  refreshToken    String?   @map("refresh_token") @db.Text // Encrypted
  expiresAt       DateTime? @map("expires_at") @db.Timestamptz(6)
  defaultFolderId String?   @map("default_folder_id") @db.VarChar(255)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId])
  @@map("drive_connections")
}

/// Google Calendar Connections (Google Calendar OAuth connections)
model GoogleCalendarConnection {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @unique @map("organization_id") @db.Uuid
  accessToken    String    @map("access_token") @db.Text // Encrypted
  refreshToken   String?   @map("refresh_token") @db.Text // Encrypted
  expiresAt      DateTime? @map("expires_at") @db.Timestamptz(6)
  calendarId     String?   @map("calendar_id") @db.VarChar(255) // Primary calendar ID (usually email)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId])
  @@map("google_calendar_connections")
}

// ============================================================================
// PUBLIC API TABLES
// ============================================================================

/// API Keys (Public API authentication)
model APIKey {
  id                String    @id @default(uuid()) @db.Uuid
  organizationId    String    @map("organization_id") @db.Uuid
  name              String    @db.VarChar(255)
  keyHash           String    @unique @map("key_hash") @db.VarChar(64)
  keyPrefix         String    @map("key_prefix") @db.VarChar(12)
  scopes            String[]  @default([]) @db.VarChar(50)
  rateLimitTier     String    @default("free") @map("rate_limit_tier") @db.VarChar(20)
  requestsPerMinute Int       @default(60) @map("requests_per_minute")
  requestsPerDay    Int       @default(1000) @map("requests_per_day")
  lastUsedAt        DateTime? @map("last_used_at") @db.Timestamptz(6)
  totalRequests     Int       @default(0) @map("total_requests")
  status            String    @default("active") @db.VarChar(20)
  expiresAt         DateTime? @map("expires_at") @db.Timestamptz(6)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy         String    @map("created_by") @db.Uuid
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId])
  @@index([keyPrefix])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("api_keys")
}

/// Public Webhooks (Organization webhook endpoints)
model PublicWebhook {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  url            String    @db.Text
  events         String[]  @default([]) @db.VarChar(100)
  secret         String    @db.VarChar(64)
  status         String    @default("active") @db.VarChar(20)
  failureCount   Int       @default(0) @map("failure_count")
  lastFailure    DateTime? @map("last_failure") @db.Timestamptz(6)
  lastSuccess    DateTime? @map("last_success") @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  deliveries WebhookDelivery[]

  @@index([organizationId])
  @@index([status])
  @@index([organizationId, status])
  @@map("public_webhooks")
}

/// Webhook Deliveries (Webhook delivery logs)
model WebhookDelivery {
  id             String    @id @default(uuid()) @db.Uuid
  webhookId      String    @map("webhook_id") @db.Uuid
  event          String    @db.VarChar(100)
  payload        Json      @db.JsonB
  status         String    @default("pending") @db.VarChar(20)
  attempts       Int       @default(0)
  lastAttemptAt  DateTime? @map("last_attempt_at") @db.Timestamptz(6)
  responseStatus Int?      @map("response_status")
  responseBody   String?   @map("response_body") @db.Text
  error          String?   @db.Text
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  webhook PublicWebhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("webhook_deliveries")
}

// ============================================================================
// SECURITY TABLES
// ============================================================================

/// Session Hijacking Attempts (Security monitoring)
model SessionHijackingAttempt {
  id             String   @id @default(uuid()) @db.Uuid
  sessionId      String   @map("session_id") @db.VarChar(255)
  userId         String   @map("user_id") @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  type           String   @db.VarChar(50) // ip_change, user_agent_change, suspicious_activity
  mismatchType   String?  @map("mismatch_type") @db.VarChar(50) // ip_mismatch, user_agent_mismatch, both
  originalIp     String?  @map("original_ip") @db.VarChar(45)
  attemptedIp    String?  @map("attempted_ip") @db.VarChar(45)
  originalAgent  String?  @map("original_agent") @db.Text
  attemptedAgent String?  @map("attempted_agent") @db.Text
  blocked        Boolean  @default(true)
  metadata       Json?    @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([sessionId])
  @@index([userId, createdAt(sort: Desc)])
  @@index([organizationId, createdAt(sort: Desc)])
  @@map("session_hijacking_attempts")
}

// ============================================================================
// BILLING & SUBSCRIPTION TABLES
// ============================================================================

/// Subscription (Organization billing subscriptions)
/// Tracks Stripe subscription status and plan details
model Subscription {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @unique @map("organization_id") @db.Uuid

  // Stripe IDs
  stripeCustomerId     String? @unique @map("stripe_customer_id") @db.VarChar(255)
  stripeSubscriptionId String? @unique @map("stripe_subscription_id") @db.VarChar(255)
  stripePriceId        String? @map("stripe_price_id") @db.VarChar(255)

  // Plan details
  planId          String @default("free") @map("plan_id") @db.VarChar(50)
  status          String @default("active") @db.VarChar(50)
  billingInterval String @default("monthly") @map("billing_interval") @db.VarChar(20)

  // Billing period
  currentPeriodStart DateTime? @map("current_period_start") @db.Timestamptz(6)
  currentPeriodEnd   DateTime? @map("current_period_end") @db.Timestamptz(6)
  cancelAtPeriodEnd  Boolean   @default(false) @map("cancel_at_period_end")
  canceledAt         DateTime? @map("canceled_at") @db.Timestamptz(6)

  // Trial
  trialStart DateTime? @map("trial_start") @db.Timestamptz(6)
  trialEnd   DateTime? @map("trial_end") @db.Timestamptz(6)

  // Custom limits override
  customLimits Json? @map("custom_limits") @db.JsonB

  // Metadata
  metadata Json @default("{}") @db.JsonB

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  invoices Invoice[]

  @@index([organizationId])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([status])
  @@index([planId])
  @@map("subscriptions")
}

/// Invoice (Billing invoices synced from Stripe)
model Invoice {
  id             String  @id @default(uuid()) @db.Uuid
  subscriptionId String? @map("subscription_id") @db.Uuid
  organizationId String  @map("organization_id") @db.Uuid

  // Stripe IDs
  stripeInvoiceId       String? @unique @map("stripe_invoice_id") @db.VarChar(255)
  stripePaymentIntentId String? @map("stripe_payment_intent_id") @db.VarChar(255)

  // Invoice details
  number   String? @db.VarChar(100)
  status   String  @default("draft") @db.VarChar(50)
  amount   Int     @default(0) // In cents
  currency String  @default("usd") @db.VarChar(3)

  // Dates
  periodStart DateTime  @map("period_start") @db.Timestamptz(6)
  periodEnd   DateTime  @map("period_end") @db.Timestamptz(6)
  dueDate     DateTime? @map("due_date") @db.Timestamptz(6)
  paidAt      DateTime? @map("paid_at") @db.Timestamptz(6)

  // URLs
  hostedInvoiceUrl String? @map("hosted_invoice_url") @db.Text
  invoicePdfUrl    String? @map("invoice_pdf_url") @db.Text

  // Line items
  lineItems Json @default("[]") @map("line_items") @db.JsonB
  metadata  Json @default("{}") @db.JsonB

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  subscription Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([organizationId])
  @@index([stripeInvoiceId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("invoices")
}

/// UsageRecord (Usage tracking per organization)
/// Tracks usage metrics per period for billing and limits
model UsageRecord {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  metric String @db.VarChar(50) // executions, api_requests, storage_bytes, team_members, agents, workflows
  value  Int    @default(0)
  period String @db.VarChar(7) // YYYY-MM format

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([organizationId, metric, period])
  @@index([organizationId])
  @@index([metric])
  @@index([period])
  @@map("usage_records")
}

/// OrganizationAIProvider (AI provider preferences per organization)
/// Stores preferred AI provider, fallback settings, and usage limits
model OrganizationAIProvider {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @unique @map("organization_id") @db.Uuid

  preferredProvider String  @default("anthropic") @map("preferred_provider") @db.VarChar(50) // anthropic, openai, google-ai, github-models, openrouter
  fallbackProvider  String? @map("fallback_provider") @db.VarChar(50)
  autoFallback      Boolean @default(true) @map("auto_fallback")

  // Usage limits (optional)
  monthlyTokenLimit BigInt? @map("monthly_token_limit")
  dailyTokenLimit   BigInt? @map("daily_token_limit")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  usageRecords AIProviderUsageRecord[]

  @@index([organizationId])
  @@map("organization_ai_providers")
}

/// AIProviderUsageRecord (Token usage tracking per AI request)
/// Tracks token consumption and costs per provider/model
model AIProviderUsageRecord {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  aiProviderId   String @map("ai_provider_id") @db.Uuid

  provider     String  @db.VarChar(50) // anthropic, openai, google-ai, github-models, openrouter
  model        String  @db.VarChar(100) // claude-3-sonnet, gpt-4, gemini-pro, etc.
  inputTokens  Int     @map("input_tokens")
  outputTokens Int     @map("output_tokens")
  totalTokens  Int     @map("total_tokens")
  costCents    Int     @default(0) @map("cost_cents") // Cost in cents for billing
  requestType  String? @map("request_type") @db.VarChar(50) // chat, completion, embedding

  // Context
  sessionId String? @map("session_id") @db.Uuid
  agentId   String? @map("agent_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  aiProvider OrganizationAIProvider @relation(fields: [aiProviderId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([aiProviderId])
  @@index([provider])
  @@index([createdAt(sort: Desc)])
  @@map("ai_provider_usage_records")
}

// ============================================================================
// ONBOARDING TABLES
// ============================================================================

/// OnboardingState (Tracks organization onboarding progress)
model OnboardingState {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @unique @map("organization_id") @db.Uuid
  currentStep    String    @default("company_info") @map("current_step") @db.VarChar(50)
  completedSteps String[]  @default([]) @map("completed_steps") @db.VarChar(50)
  skippedSteps   String[]  @default([]) @map("skipped_steps") @db.VarChar(50)
  data           Json      @default("{}") @db.JsonB
  templateId     String?   @map("template_id") @db.VarChar(100)
  lastActivityAt DateTime  @default(now()) @map("last_activity_at") @db.Timestamptz(6)
  completedAt    DateTime? @map("completed_at") @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId])
  @@index([currentStep])
  @@map("onboarding_states")
}

/// OnboardingChecklistItem (Tracks individual checklist item completion)
model OnboardingChecklistItem {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  itemId         String    @map("item_id") @db.VarChar(100)
  status         String    @default("pending") @db.VarChar(20) // pending, in_progress, completed, skipped
  completedAt    DateTime? @map("completed_at") @db.Timestamptz(6)
  metadata       Json?     @db.JsonB
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([organizationId, itemId])
  @@index([organizationId])
  @@index([status])
  @@map("onboarding_checklist_items")
}

// ============================================================================
// MEMORY TABLES (AI Agent Memory System)
// ============================================================================

/// EntityMemory (Stores entity-specific memories - people, projects, companies)
model EntityMemory {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  entityType     String   @map("entity_type") @db.VarChar(50) // person, project, company, product, team
  entityName     String   @map("entity_name") @db.VarChar(255)
  attributes     Json     @default("{}") @db.JsonB // Key-value pairs
  relationships  Json     @default("[]") @db.JsonB // Array of {entityId, relationship}
  notes          Json     @default("[]") @db.JsonB // Array of notes
  lastMentioned  DateTime @default(now()) @map("last_mentioned") @db.Timestamptz(6)
  mentionCount   Int      @default(0) @map("mention_count")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId])
  @@index([organizationId, entityType])
  @@index([organizationId, entityName])
  @@index([lastMentioned(sort: Desc)])
  @@index([mentionCount(sort: Desc)])
  @@map("entity_memories")
}

/// Memory (Long-term memory storage with scoping)
model Memory {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  scope          String    @db.VarChar(50) // user, team, org, project, agent
  scopeId        String    @map("scope_id") @db.Uuid
  type           String    @db.VarChar(50) // preference, fact, context, instruction
  key            String    @db.VarChar(255)
  value          String    @db.Text
  importance     String    @default("medium") @db.VarChar(20) // low, medium, high, critical
  sourceType     String    @default("explicit") @map("source_type") @db.VarChar(50) // explicit, inferred, learned
  sourceId       String?   @map("source_id") @db.Uuid
  lastAccessedAt DateTime  @default(now()) @map("last_accessed_at") @db.Timestamptz(6)
  expiresAt      DateTime? @map("expires_at") @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([organizationId, scope, scopeId, key])
  @@index([organizationId])
  @@index([organizationId, scope, scopeId])
  @@index([key])
  @@index([expiresAt])
  @@index([lastAccessedAt(sort: Desc)])
  @@map("memories")
}
