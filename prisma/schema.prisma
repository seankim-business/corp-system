// Prisma Schema for Kyndof Corp System
// Multi-tenant SaaS with Google Workspace integration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// SKILL & MCP ECOSYSTEM ENUMS
// ============================================================================

enum ExtensionType {
  extension
  skill
  mcp_server
}

// ============================================================================
// CORE MULTI-TENANT TABLES
// ============================================================================

/// Organizations (Tenants)
/// Each organization represents a separate company/workspace
model Organization {
  id                     String    @id @default(uuid()) @db.Uuid
  slug                   String    @unique @db.VarChar(50) // Subdomain: kyndof, clientco
  name                   String    @db.VarChar(255)
  logoUrl                String?   @map("logo_url") @db.Text
  settings               Json      @default("{}") @db.JsonB
  monthlyBudgetCents     Int?      @map("monthly_budget_cents")
  currentMonthSpendCents Int       @default(0) @map("current_month_spend_cents")
  budgetResetAt          DateTime? @map("budget_reset_at") @db.Timestamptz(6)
  createdAt              DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  workspaceDomains       WorkspaceDomain[]
  memberships            Membership[]
  agents                 Agent[]
  teams                  Team[]
  projects               Project[]
  tasks                  Task[]
  goals                  Goal[]
  valueStreams           ValueStream[]
  kpis                   KPI[]
  workflows              Workflow[]
  notionConnections      NotionConnection[]
  mcpConnections         MCPConnection[]
  claudeAccounts         ClaudeAccount[]
  slackIntegrations      SlackIntegration[]
  orchestratorExecutions OrchestratorExecution[]
  featureFlagOverrides   FeatureFlagOverride[]
  featureFlagAuditLogs   FeatureFlagAuditLog[]
  marketplaceExtensions  MarketplaceExtension[]
  extensionInstallations ExtensionInstallation[]
  extensionPermissions   ExtensionPermission[]
  skillLearningPatterns  SkillLearningPattern[]
  agentSkillAssignments  AgentSkillAssignment[]
  extensionUsageLogs     ExtensionUsageLog[]

  @@map("organizations")
}

/// Users (Global identity)
/// One user can belong to multiple organizations
model User {
  id            String   @id @default(uuid()) @db.Uuid
  email         String   @unique @db.VarChar(255)
  passwordHash  String?  @map("password_hash") @db.VarChar(255) // NULL for Google-only users
  googleId      String?  @unique @map("google_id") @db.VarChar(255) // Google OAuth sub
  displayName   String?  @map("display_name") @db.VarChar(255)
  avatarUrl     String?  @map("avatar_url") @db.Text
  emailVerified Boolean  @default(false) @map("email_verified")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  memberships            Membership[]
  sessions               Session[]
  orchestratorExecutions OrchestratorExecution[]
  featureFlagAuditLogs   FeatureFlagAuditLog[]

  @@index([email])
  @@index([googleId])
  @@map("users")
}

/// Memberships (User ↔ Organization relationship)
/// Defines user's role and permissions within an organization
model Membership {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  role           String    @db.VarChar(50) // owner, admin, member
  permissions    Json      @default("{}") @db.JsonB
  invitedBy      String?   @map("invited_by") @db.Uuid
  invitedAt      DateTime  @default(now()) @map("invited_at") @db.Timestamptz(6)
  joinedAt       DateTime? @map("joined_at") @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Daily briefing preferences
  dailyBriefingEnabled  Boolean @default(false) @map("daily_briefing_enabled")
  dailyBriefingTime     String  @default("09:00") @map("daily_briefing_time") @db.VarChar(5)
  dailyBriefingTimezone String  @default("UTC") @map("daily_briefing_timezone") @db.VarChar(50)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("memberships")
}

/// Workspace Domains (Google Workspace domains)
/// Links Google Workspace domains to organizations
model WorkspaceDomain {
  id                String    @id @default(uuid()) @db.Uuid
  organizationId    String    @map("organization_id") @db.Uuid
  domain            String    @unique @db.VarChar(255) // nubabel.com, client-company.com
  verified          Boolean   @default(false)
  verificationToken String?   @map("verification_token") @db.VarChar(255)
  verifiedAt        DateTime? @map("verified_at") @db.Timestamptz(6)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, domain])
  @@index([organizationId])
  @@index([domain])
  @@map("workspace_domains")
}

/// Sessions (Enhanced for Orchestrator + JWT)
/// Tracks both authentication sessions AND orchestrator conversation sessions
model Session {
  id             String   @id @db.VarChar(255) // Can be UUID or ses_xxx format
  userId         String   @map("user_id") @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  tokenHash      String?  @unique @map("token_hash") @db.VarChar(255) // NULL for orchestrator sessions
  source         String?  @db.VarChar(50) // slack, web, terminal, api (for orchestrator)
  state          Json     @default("{}") @db.JsonB // Orchestrator state
  history        Json     @default("[]") @db.JsonB // Conversation history
  metadata       Json     @default("{}") @db.JsonB // Additional data
  expiresAt      DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  lastUsedAt     DateTime @default(now()) @map("last_used_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Session hijacking prevention
  ipAddress String? @map("ip_address") @db.VarChar(45)
  userAgent String? @map("user_agent") @db.Text

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([organizationId, expiresAt])
  @@index([tokenHash])
  @@index([expiresAt])
  @@index([source])
  @@map("sessions")
}

// ============================================================================
// AGENT HIERARCHY TABLES (Dynamic Team Management)
// ============================================================================

/// Agents (AI Agents - both permanent and temporary)
model Agent {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  name           String    @db.VarChar(100) // designer-bokyung, pm-killin-it-girl
  type           String    @db.VarChar(50) // permanent, temporary, contractor
  role           String    @db.Text // "K-POP 무대 의상 디자이너"
  managerId      String?   @map("manager_id") @db.Uuid // Reports to which agent
  teamId         String?   @map("team_id") @db.Uuid
  skills         String[]  @db.VarChar(100) // [fashion-design, clo3d, adobe-suite]
  sessionId      String?   @map("session_id") @db.VarChar(255) // Persistent session for continuity
  hiredAt        DateTime  @default(now()) @map("hired_at") @db.Timestamptz(6)
  contractEnd    DateTime? @map("contract_end") @db.Timestamptz(6) // NULL for permanent
  projectId      String?   @map("project_id") @db.Uuid // For project-based agents
  status         String    @default("active") @db.VarChar(50) // active, inactive, archived
  metadata       Json      @default("{}") @db.JsonB
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  manager      Agent?       @relation("AgentHierarchy", fields: [managerId], references: [id])
  subordinates Agent[]      @relation("AgentHierarchy")
  team         Team?        @relation(fields: [teamId], references: [id])

  skillAssignments AgentSkillAssignment[]

  @@index([organizationId])
  @@index([managerId])
  @@index([teamId])
  @@index([type])
  @@index([status])
  @@map("agents")
}

/// Teams (Groups of agents)
model Team {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String   @db.VarChar(255)
  leaderId       String?  @map("leader_id") @db.Uuid // Team leader
  type           String   @db.VarChar(50) // permanent, temporary, taskforce
  maxMembers     Int?     @map("max_members")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agents       Agent[]

  @@index([organizationId])
  @@map("teams")
}

// ============================================================================
// BUSINESS DATA TABLES (Tenant-scoped)
// ============================================================================

/// Projects
model Project {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  name           String    @db.VarChar(255)
  status         String    @db.VarChar(50)
  ownerId        String?   @map("owner_id") @db.Uuid
  startDate      DateTime? @map("start_date") @db.Date
  dueDate        DateTime? @map("due_date") @db.Date
  progress       Int       @default(0)
  budget         Decimal?  @db.Decimal(15, 2)
  description    String?   @db.Text
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tasks        Task[]

  @@index([organizationId, id])
  @@index([organizationId, createdAt(sort: Desc)])
  @@map("projects")
}

/// Tasks (RABSIC-enabled)
model Task {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @map("organization_id") @db.Uuid
  projectId       String?   @map("project_id") @db.Uuid
  name            String    @db.VarChar(500)
  status          String    @db.VarChar(50) // 1_ToDo, 2_InProgress, 5_Done
  dueDate         DateTime? @map("due_date") @db.Date
  urgencyScore    Int?      @default(0) @map("urgency_score")
  importanceScore Int?      @default(0) @map("importance_score")
  eisenhowerQuad  String?   @map("eisenhower_quadrant") @db.VarChar(50)

  // RABSIC fields
  responsible String[] @db.Uuid
  accountable String[] @db.Uuid // Must be exactly 1
  backup      String[] @db.Uuid
  support     String[] @db.Uuid
  informed    String[] @db.Uuid
  consulted   String[] @db.Uuid

  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project?     @relation(fields: [projectId], references: [id])

  @@index([organizationId, id])
  @@index([organizationId, status])
  @@index([organizationId, dueDate])
  @@index([organizationId, projectId])
  @@map("tasks")
}

/// Goals (Hierarchical)
model Goal {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @map("organization_id") @db.Uuid
  title           String    @db.VarChar(500)
  status          String    @db.VarChar(50)
  ownerPositionId String?   @map("owner_position_id") @db.Uuid
  dueDate         DateTime? @map("due_date") @db.Date
  progress        Int       @default(0)
  parentGoalId    String?   @map("parent_goal_id") @db.Uuid
  description     String?   @db.Text
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parentGoal   Goal?        @relation("GoalHierarchy", fields: [parentGoalId], references: [id])
  subGoals     Goal[]       @relation("GoalHierarchy")

  @@index([organizationId, id])
  @@index([parentGoalId])
  @@map("goals")
}

/// Value Streams (Business processes)
model ValueStream {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String   @db.VarChar(500)
  functions      String   @db.VarChar(100) // MD, Fashion Design, Marketing, CS, Sales
  type           String   @db.VarChar(50)
  input          String?  @db.Text
  output         String?  @db.Text
  parentId       String?  @map("parent_id") @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parent       ValueStream?  @relation("ValueStreamHierarchy", fields: [parentId], references: [id])
  subStreams   ValueStream[] @relation("ValueStreamHierarchy")

  @@index([organizationId, id])
  @@index([parentId])
  @@map("value_streams")
}

/// KPIs (Key Performance Indicators)
model KPI {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @map("organization_id") @db.Uuid
  name            String    @db.VarChar(255)
  status          String    @db.VarChar(50)
  ownerRoleId     String?   @map("owner_role_id") @db.Uuid
  target          String?   @db.VarChar(255)
  currentValue    Decimal?  @map("current_value") @db.Decimal(15, 2)
  unit            String?   @db.VarChar(50)
  updateFrequency String?   @map("update_frequency") @db.VarChar(50)
  dataSource      String?   @map("data_source") @db.Text
  upToDate        Boolean   @default(true) @map("up_to_date")
  lastUpdated     DateTime? @map("last_updated") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, id])
  @@map("kpis")
}

// ============================================================================
// WORKFLOW AUTOMATION TABLES (Phase 2 Week 3-4)
// ============================================================================

/// Workflows (Automation definitions)
model Workflow {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String   @db.VarChar(255)
  description    String?  @db.Text
  config         Json     @default("{}") @db.JsonB
  enabled        Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // SOP (Standard Operating Procedure) fields
  sopEnabled Boolean @default(false) @map("sop_enabled")
  sopSteps   Json?   @map("sop_steps") @db.JsonB // Array of step definitions

  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  executions   WorkflowExecution[]

  @@index([organizationId])
  @@index([organizationId, enabled])
  @@map("workflows")
}

/// Workflow Executions (Execution history)
model WorkflowExecution {
  id           String    @id @default(uuid()) @db.Uuid
  workflowId   String    @map("workflow_id") @db.Uuid
  status       String    @db.VarChar(50)
  inputData    Json?     @map("input_data") @db.JsonB
  outputData   Json?     @map("output_data") @db.JsonB
  errorMessage String?   @map("error_message") @db.Text
  startedAt    DateTime? @map("started_at") @db.Timestamptz(6)
  completedAt  DateTime? @map("completed_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("workflow_executions")
}

/// Orchestrator Executions (Conversation / delegation history)
/// Separate from WorkflowExecution to avoid mixing automation runs with orchestration.
model OrchestratorExecution {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  userId         String @map("user_id") @db.Uuid
  sessionId      String @map("session_id") @db.VarChar(255)

  category String   @db.VarChar(100)
  skills   String[] @default([]) @db.VarChar(100)
  status   String   @db.VarChar(50)
  duration Int      @default(0)

  inputData    Json?   @map("input_data") @db.JsonB
  outputData   Json?   @map("output_data") @db.JsonB
  errorMessage String? @map("error_message") @db.Text
  metadata     Json?   @default("{}") @db.JsonB

  // SOP execution tracking
  currentStep Int?  @map("current_step")
  stepResults Json? @map("step_results") @db.JsonB

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([organizationId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@index([sessionId])
  @@index([status])
  @@map("orchestrator_executions")
}

// ============================================================================
// MCP INTEGRATION TABLES (Phase 2 Week 9-12)
// ============================================================================

/// Generic MCP Connections (Organization-level integrations)
/// Supports: Notion, Linear, Jira, Asana, Airtable, etc.
model MCPConnection {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  provider       String    @db.VarChar(100) // notion, linear, jira, asana, airtable, etc.
  namespace      String    @db.VarChar(100) // MCP namespace/scope identifier
  name           String    @db.VarChar(255) // User-friendly name
  config         Json      @db.JsonB // Provider-specific config (API keys, tokens, etc.)
  refreshToken   String?   @map("refresh_token") @db.Text // OAuth refresh token (encrypted)
  expiresAt      DateTime? @map("expires_at") @db.Timestamptz(6) // Token expiration timestamp
  enabled        Boolean   @default(true)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, enabled])
  @@index([provider])
  @@index([namespace])
  @@map("mcp_connections")
}

/// Claude Accounts (Per-account circuit breaker state)
/// Tracks API health and circuit breaker status for individual Claude accounts
model ClaudeAccount {
  id                  String    @id @default(uuid()) @db.Uuid
  organizationId      String    @map("organization_id") @db.Uuid
  name                String    @db.VarChar(255)
  status              String    @default("active") @db.VarChar(50)
  consecutiveFailures Int       @default(0) @map("consecutive_failures")
  halfOpenSuccesses   Int       @default(0) @map("half_open_successes")
  circuitOpensAt      DateTime? @map("circuit_opens_at") @db.Timestamptz(6)
  lastFailureAt       DateTime? @map("last_failure_at") @db.Timestamptz(6)
  lastFailureReason   String?   @map("last_failure_reason") @db.Text
  lastSuccessAt       DateTime? @map("last_success_at") @db.Timestamptz(6)
  metadata            Json      @default("{}") @db.JsonB
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  quotaAlerts  QuotaAlert[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([status])
  @@index([circuitOpensAt])
  @@map("claude_accounts")
}

model QuotaAlert {
  id           String    @id @default(uuid()) @db.Uuid
  accountId    String    @map("account_id") @db.Uuid
  type         String    @db.VarChar(50)
  severity     String    @db.VarChar(20)
  message      String    @db.Text
  currentValue Int       @map("current_value")
  limit        Int
  percentage   Float
  quotaType    String    @map("quota_type") @db.VarChar(50)
  resolvedAt   DateTime? @map("resolved_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  account ClaudeAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([type])
  @@index([severity])
  @@index([resolvedAt])
  @@index([createdAt(sort: Desc)])
  @@map("quota_alerts")
}

/// Legacy Notion Connections (Backward compatibility)
model NotionConnection {
  id                String   @id @default(uuid()) @db.Uuid
  organizationId    String   @map("organization_id") @db.Uuid
  apiKey            String   @map("api_key") @db.VarChar(255)
  defaultDatabaseId String?  @map("default_database_id") @db.VarChar(255)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId])
  @@index([organizationId])
  @@map("notion_connections")
}

// ============================================================================
// SLACK INTEGRATION TABLES (Phase 2 Week 9-12 - Multi-Tenant)
// ============================================================================

/// Slack Integrations (Per-organization Slack workspaces)
/// Supports BYOA (Bring Your Own App) - organizations provide their own Slack App credentials
model SlackIntegration {
  id             String  @id @default(uuid()) @db.Uuid
  organizationId String  @unique @map("organization_id") @db.Uuid
  workspaceId    String? @unique @map("workspace_id") @db.VarChar(50) // Slack Team ID (T01234ABCD) - filled after OAuth
  workspaceName  String? @map("workspace_name") @db.VarChar(255) // Friendly name - filled after OAuth

  // Slack App credentials (BYOA - encrypted)
  clientId     String? @map("client_id") @db.Text // Slack App Client ID (encrypted)
  clientSecret String? @map("client_secret") @db.Text // Slack App Client Secret (encrypted)

  // OAuth tokens (encrypted in application layer before storage) - filled after OAuth
  botToken String? @map("bot_token") @db.Text // xoxb-... (encrypted)
  appToken String? @map("app_token") @db.Text // xapp-... (encrypted, for Socket Mode)

  // Security
  signingSecret String? @map("signing_secret") @db.Text // Webhook verification (encrypted)

  // OAuth metadata
  botUserId String?  @map("bot_user_id") @db.VarChar(50) // U01234ABCD
  scopes    String[] @default([]) @db.VarChar(100) // [app_mentions:read, chat:write, ...]

  // Installation metadata
  installedBy String?  @map("installed_by") @db.Uuid // Which user authorized
  installedAt DateTime @default(now()) @map("installed_at") @db.Timestamptz(6)

  // Status
  enabled         Boolean   @default(true)
  lastHealthCheck DateTime? @map("last_health_check") @db.Timestamptz(6)
  healthStatus    String    @default("unknown") @map("health_status") @db.VarChar(50) // healthy, degraded, offline, unknown

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([workspaceId])
  @@index([enabled])
  @@map("slack_integrations")
}

// ==========================================================================
// FEATURE FLAGS (Safe release / rollout)
// ==========================================================================

model FeatureFlag {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique @db.VarChar(100) // e.g. "new_dashboard"
  name        String   @db.VarChar(255)
  description String?  @db.Text
  enabled     Boolean  @default(false) // Global kill switch
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  rules     FeatureFlagRule[]
  overrides FeatureFlagOverride[]
  auditLogs FeatureFlagAuditLog[]

  @@index([key])
  @@map("feature_flags")
}

model FeatureFlagRule {
  id            String @id @default(uuid()) @db.Uuid
  featureFlagId String @map("feature_flag_id") @db.Uuid

  type            String   @db.VarChar(50) // ALLOWLIST | BLOCKLIST | PERCENTAGE
  organizationIds String[] @default([]) @map("organization_ids") @db.Uuid
  percentage      Int      @default(0)
  priority        Int      @default(100)
  enabled         Boolean  @default(true)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  featureFlag FeatureFlag @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)

  @@index([featureFlagId, priority])
  @@index([enabled, priority])
  @@index([type])
  @@map("feature_flag_rules")
}

model FeatureFlagOverride {
  id             String @id @default(uuid()) @db.Uuid
  featureFlagId  String @map("feature_flag_id") @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  enabled   Boolean
  reason    String?   @db.Text
  expiresAt DateTime? @map("expires_at") @db.Timestamptz(6)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  featureFlag  FeatureFlag  @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([featureFlagId, organizationId])
  @@index([organizationId])
  @@index([expiresAt])
  @@map("feature_flag_overrides")
}

model FeatureFlagAuditLog {
  id            String @id @default(uuid()) @db.Uuid
  featureFlagId String @map("feature_flag_id") @db.Uuid

  action String @db.VarChar(50) // CREATED | UPDATED | RULE_SET | OVERRIDE_SET | EVALUATED

  organizationId String? @map("organization_id") @db.Uuid
  userId         String? @map("user_id") @db.Uuid
  metadata       Json?   @db.JsonB

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  featureFlag  FeatureFlag   @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([featureFlagId, createdAt(sort: Desc)])
  @@index([organizationId, createdAt(sort: Desc)])
  @@index([action, createdAt(sort: Desc)])
  @@map("feature_flag_audit_logs")
}

// ============================================================================
// AUDIT LOG TABLE (System-wide action tracking)
// ============================================================================

/// AuditLog (Tracks all user/system actions)
model AuditLog {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  action       String  @db.VarChar(100) // user.login, workflow.execute, etc.
  userId       String? @map("user_id") @db.Uuid
  resourceType String? @map("resource_type") @db.VarChar(100)
  resourceId   String? @map("resource_id") @db.VarChar(255)
  details      Json?   @db.JsonB
  ipAddress    String? @map("ip_address") @db.VarChar(45)
  userAgent    String? @map("user_agent") @db.Text
  success      Boolean @default(true)
  errorMessage String? @map("error_message") @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([action, createdAt(sort: Desc)])
  @@index([resourceType, resourceId])
  @@map("audit_logs")
}

// ============================================================================
// APPROVAL WORKFLOW TABLES
// ============================================================================

/// Approvals (Budget, deployment, content approvals)
model Approval {
  id                 String    @id @default(uuid()) @db.Uuid
  organizationId     String    @map("organization_id") @db.Uuid
  requesterId        String    @map("requester_id") @db.Uuid
  approverId         String    @map("approver_id") @db.Uuid
  fallbackApproverId String?   @map("fallback_approver_id") @db.Uuid
  type               String    @db.VarChar(50) // budget, deployment, content
  title              String    @db.VarChar(500)
  description        String    @db.Text
  context            Json?     @db.JsonB
  status             String    @default("pending") @db.VarChar(50) // pending, approved, rejected, expired
  responseNote       String?   @map("response_note") @db.Text
  slackMessageTs     String?   @map("slack_message_ts") @db.VarChar(50)
  slackChannelId     String?   @map("slack_channel_id") @db.VarChar(50)
  expiresAt          DateTime  @map("expires_at") @db.Timestamptz(6)
  respondedAt        DateTime? @map("responded_at") @db.Timestamptz(6)
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId, status])
  @@index([approverId, status])
  @@index([fallbackApproverId])
  @@index([requesterId])
  @@index([expiresAt])
  @@map("approvals")
}

// ============================================================================
// PERMISSION DELEGATION TABLES
// ============================================================================

/// Delegations (Permission transfers between users)
model Delegation {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  delegatorId    String    @map("delegator_id") @db.Uuid
  delegateeId    String    @map("delegatee_id") @db.Uuid
  permissions    String[]  @db.VarChar(100)
  scope          Json?     @db.JsonB
  validFrom      DateTime  @map("valid_from") @db.Timestamptz(6)
  validUntil     DateTime  @map("valid_until") @db.Timestamptz(6)
  reason         String    @db.Text
  revokedAt      DateTime? @map("revoked_at") @db.Timestamptz(6)
  revokedBy      String?   @map("revoked_by") @db.Uuid
  revokedReason  String?   @map("revoked_reason") @db.Text
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId, delegateeId])
  @@index([organizationId, delegatorId])
  @@index([delegateeId, validUntil])
  @@index([validUntil])
  @@map("delegations")
}

/// Agent Permission Overrides (Custom permissions for specific agents)
model AgentPermissionOverride {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  agentId        String   @map("agent_id") @db.Uuid
  readPatterns   String[] @default([]) @map("read_patterns") @db.VarChar(255)
  writePatterns  String[] @default([]) @map("write_patterns") @db.VarChar(255)
  tools          String[] @default([]) @db.VarChar(255)
  restricted     String[] @default([]) @db.VarChar(255)
  approvalRules  Json?    @map("approval_rules") @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([organizationId, agentId])
  @@index([organizationId])
  @@index([agentId])
  @@map("agent_permission_overrides")
}

// ============================================================================
// OKR (OBJECTIVES AND KEY RESULTS) TABLES
// ============================================================================

/// Objectives (OKR Objectives)
model Objective {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  title          String   @db.VarChar(500)
  description    String?  @db.Text
  quarter        String   @db.VarChar(10) // e.g., "2026-Q1"
  ownerId        String   @map("owner_id") @db.Uuid
  status         String   @default("on_track") @db.VarChar(50) // on_track, at_risk, behind
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  keyResults KeyResult[]

  @@index([organizationId, quarter])
  @@index([ownerId])
  @@map("objectives")
}

/// Key Results (OKR Key Results)
model KeyResult {
  id          String   @id @default(uuid()) @db.Uuid
  objectiveId String   @map("objective_id") @db.Uuid
  title       String   @db.VarChar(500)
  target      Float
  current     Float    @default(0)
  unit        String   @db.VarChar(50) // percentage, count, currency, etc.
  ownerId     String?  @map("owner_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  objective Objective @relation(fields: [objectiveId], references: [id], onDelete: Cascade)

  @@index([objectiveId])
  @@index([ownerId])
  @@map("key_results")
}

// ============================================================================
// ORGANIZATION CHANGE MANAGEMENT TABLES
// ============================================================================

/// Organization Changes (Track organizational changes and responses)
model OrganizationChange {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  title          String   @db.VarChar(500)
  description    String   @db.Text
  type           String   @db.VarChar(50) // new_agent, process_modification, integration_update, role_change
  status         String   @default("pending") @db.VarChar(50) // pending, in_progress, completed, cancelled
  impactLevel    String   @default("low") @map("impact_level") @db.VarChar(20) // low, medium, high
  requestedBy    String   @map("requested_by") @db.Uuid
  impactAnalysis String?  @map("impact_analysis") @db.Text
  prUrl          String?  @map("pr_url") @db.Text
  metadata       Json?    @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId, status])
  @@index([requestedBy])
  @@index([type])
  @@index([impactLevel])
  @@map("organization_changes")
}

// ============================================================================
// GOOGLE DRIVE INTEGRATION TABLES
// ============================================================================

/// Drive Connections (Google Drive OAuth connections)
model DriveConnection {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @unique @map("organization_id") @db.Uuid
  accessToken     String    @map("access_token") @db.Text // Encrypted
  refreshToken    String?   @map("refresh_token") @db.Text // Encrypted
  expiresAt       DateTime? @map("expires_at") @db.Timestamptz(6)
  defaultFolderId String?   @map("default_folder_id") @db.VarChar(255)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId])
  @@map("drive_connections")
}

/// Google Calendar Connections (Google Calendar OAuth connections)
model GoogleCalendarConnection {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @unique @map("organization_id") @db.Uuid
  accessToken    String    @map("access_token") @db.Text // Encrypted
  refreshToken   String?   @map("refresh_token") @db.Text // Encrypted
  expiresAt      DateTime? @map("expires_at") @db.Timestamptz(6)
  calendarId     String?   @map("calendar_id") @db.VarChar(255) // Primary calendar ID (usually email)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId])
  @@map("google_calendar_connections")
}

// ============================================================================
// SECURITY TABLES
// ============================================================================

/// Session Hijacking Attempts (Security monitoring)
model SessionHijackingAttempt {
  id             String   @id @default(uuid()) @db.Uuid
  sessionId      String   @map("session_id") @db.VarChar(255)
  userId         String   @map("user_id") @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  type           String   @db.VarChar(50) // ip_change, user_agent_change, suspicious_activity
  mismatchType   String?  @map("mismatch_type") @db.VarChar(50) // ip_mismatch, user_agent_mismatch, both
  originalIp     String?  @map("original_ip") @db.VarChar(45)
  attemptedIp    String?  @map("attempted_ip") @db.VarChar(45)
  originalAgent  String?  @map("original_agent") @db.Text
  attemptedAgent String?  @map("attempted_agent") @db.Text
  blocked        Boolean  @default(true)
  metadata       Json?    @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([sessionId])
  @@index([userId, createdAt(sort: Desc)])
  @@index([organizationId, createdAt(sort: Desc)])
  @@map("session_hijacking_attempts")
}

// ============================================================================
// SKILL & MCP ECOSYSTEM TABLES
// ============================================================================

/// MarketplaceExtension - Unified marketplace item for extensions/skills/MCP servers
model MarketplaceExtension {
  id             String  @id @default(uuid()) @db.Uuid
  organizationId String? @map("organization_id") @db.Uuid

  slug        String @db.VarChar(100)
  name        String @db.VarChar(255)
  description String @db.Text
  version     String @db.VarChar(20)

  extensionType ExtensionType @default(extension) @map("extension_type")
  category      String        @db.VarChar(50)
  tags          String[]      @default([]) @db.VarChar(50)

  source     String? @db.VarChar(50)
  format     String? @db.VarChar(20)
  manifest   Json    @default("{}") @db.JsonB
  definition Json?   @db.JsonB

  runtimeType   String?  @map("runtime_type") @db.VarChar(30)
  runtimeConfig Json?    @map("runtime_config") @db.JsonB
  triggers      String[] @default([]) @db.VarChar(100)
  parameters    Json     @default("[]") @db.JsonB
  outputs       Json     @default("[]") @db.JsonB
  dependencies  String[] @default([]) @db.VarChar(100)
  toolsRequired String[] @default([]) @map("tools_required") @db.VarChar(100)
  mcpProviders  String[] @default([]) @map("mcp_providers") @db.VarChar(50)

  publisherId String? @map("publisher_id") @db.Uuid
  isPublic    Boolean @default(false) @map("is_public")
  verified    Boolean @default(false)
  downloads   Int     @default(0)
  rating      Float?  @db.Real
  ratingCount Int     @default(0) @map("rating_count")

  status  String  @default("active") @db.VarChar(20)
  enabled Boolean @default(true)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy String?  @map("created_by") @db.Uuid

  organization     Organization?           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  publisher        ExtensionPublisher?     @relation(fields: [publisherId], references: [id])
  versions         ExtensionVersion[]
  installations    ExtensionInstallation[]
  usageLogs        ExtensionUsageLog[]
  permissions      ExtensionPermission[]
  agentAssignments AgentSkillAssignment[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([extensionType])
  @@index([category])
  @@index([isPublic, status])
  @@map("marketplace_extensions")
}

/// ExtensionVersion - Version history
model ExtensionVersion {
  id          String  @id @default(uuid()) @db.Uuid
  extensionId String  @map("extension_id") @db.Uuid
  version     String  @db.VarChar(20)
  manifest    Json    @db.JsonB
  definition  Json?   @db.JsonB
  changelog   String? @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy String?  @map("created_by") @db.Uuid

  extension MarketplaceExtension @relation(fields: [extensionId], references: [id], onDelete: Cascade)

  @@unique([extensionId, version])
  @@index([extensionId])
  @@map("extension_versions")
}

/// ExtensionInstallation - Org-level installations
model ExtensionInstallation {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  extensionId    String @map("extension_id") @db.Uuid
  version        String @db.VarChar(20)

  configOverrides Json? @map("config_overrides") @db.JsonB
  credentials     Json? @db.JsonB

  status     String  @default("active") @db.VarChar(20)
  autoUpdate Boolean @default(true) @map("auto_update")

  installedAt DateTime @default(now()) @map("installed_at") @db.Timestamptz(6)
  installedBy String   @map("installed_by") @db.Uuid
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  extension    MarketplaceExtension @relation(fields: [extensionId], references: [id], onDelete: Cascade)

  @@unique([organizationId, extensionId])
  @@index([organizationId])
  @@index([extensionId])
  @@map("extension_installations")
}

/// ExtensionPublisher - Publisher accounts
model ExtensionPublisher {
  id             String  @id @default(uuid()) @db.Uuid
  organizationId String? @map("organization_id") @db.Uuid

  name        String  @db.VarChar(255)
  slug        String  @unique @db.VarChar(100)
  description String? @db.Text
  website     String? @db.Text
  verified    Boolean @default(false)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  extensions MarketplaceExtension[]

  @@index([organizationId])
  @@map("extension_publishers")
}

/// ExtensionPermission - Access control
model ExtensionPermission {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  extensionId String? @map("extension_id") @db.Uuid
  category    String? @db.VarChar(50)

  agentId String? @map("agent_id") @db.Uuid
  roleId  String? @map("role_id") @db.VarChar(50)

  canExecute   Boolean @default(true) @map("can_execute")
  canConfigure Boolean @default(false) @map("can_configure")
  canInstall   Boolean @default(false) @map("can_install")

  allowedTools String[] @default([]) @map("allowed_tools") @db.VarChar(100)
  deniedTools  String[] @default([]) @map("denied_tools") @db.VarChar(100)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  extension    MarketplaceExtension? @relation(fields: [extensionId], references: [id], onDelete: Cascade)
  organization Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([extensionId])
  @@index([agentId])
  @@map("extension_permissions")
}

/// ExtensionUsageLog - Execution history
model ExtensionUsageLog {
  id             String  @id @default(uuid()) @db.Uuid
  organizationId String  @map("organization_id") @db.Uuid
  extensionId    String  @map("extension_id") @db.Uuid
  agentId        String? @map("agent_id") @db.Uuid
  sessionId      String? @map("session_id") @db.VarChar(255)

  executionId String @map("execution_id") @db.Uuid
  status      String @db.VarChar(20)
  durationMs  Int    @map("duration_ms")

  errorCode    String? @map("error_code") @db.VarChar(50)
  errorMessage String? @map("error_message") @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  extension    MarketplaceExtension @relation(fields: [extensionId], references: [id], onDelete: Cascade)
  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([extensionId])
  @@map("extension_usage_logs")
}

/// SkillLearningPattern - Pattern detection for skill generation
model SkillLearningPattern {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  patternHash String @map("pattern_hash") @db.VarChar(64)
  patternType String @map("pattern_type") @db.VarChar(30)
  steps       Json   @db.JsonB
  frequency   Int    @default(1)

  triggerPhrases String[] @default([]) @map("trigger_phrases") @db.Text
  contextTags    String[] @default([]) @map("context_tags") @db.VarChar(50)

  status String @default("detected") @db.VarChar(20)

  firstSeenAt DateTime @default(now()) @map("first_seen_at") @db.Timestamptz(6)
  lastSeenAt  DateTime @default(now()) @map("last_seen_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, patternHash])
  @@index([organizationId])
  @@index([status])
  @@map("skill_learning_patterns")
}

/// AgentSkillAssignment - Agent-specific skill configurations
model AgentSkillAssignment {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  agentId        String @map("agent_id") @db.Uuid
  extensionId    String @map("extension_id") @db.Uuid

  assignmentType  String  @map("assignment_type") @db.VarChar(20)
  enabled         Boolean @default(true)
  priority        Int     @default(100)
  configOverrides Json?   @map("config_overrides") @db.JsonB

  successCount Int @default(0) @map("success_count")
  failureCount Int @default(0) @map("failure_count")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  agent        Agent                @relation(fields: [agentId], references: [id], onDelete: Cascade)
  extension    MarketplaceExtension @relation(fields: [extensionId], references: [id], onDelete: Cascade)
  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([agentId, extensionId])
  @@index([organizationId])
  @@index([agentId])
  @@map("agent_skill_assignments")
}

// ============================================================================
// BILLING & SUBSCRIPTION TABLES
// ============================================================================

/// Subscription (Organization billing subscription)
model Subscription {
  id                   String    @id @default(uuid()) @db.Uuid
  organizationId       String    @unique @map("organization_id") @db.Uuid
  stripeCustomerId     String?   @map("stripe_customer_id") @db.VarChar(255)
  stripeSubscriptionId String?   @map("stripe_subscription_id") @db.VarChar(255)
  plan                 String    @default("free") @db.VarChar(50) // free, starter, pro, enterprise
  status               String    @default("active") @db.VarChar(50) // active, past_due, canceled, trialing
  currentPeriodStart   DateTime? @map("current_period_start") @db.Timestamptz(6)
  currentPeriodEnd     DateTime? @map("current_period_end") @db.Timestamptz(6)
  cancelAtPeriodEnd    Boolean   @default(false) @map("cancel_at_period_end")
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  invoices Invoice[]

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@map("subscriptions")
}

/// Invoice (Billing invoices)
model Invoice {
  id              String    @id @default(uuid()) @db.Uuid
  subscriptionId  String    @map("subscription_id") @db.Uuid
  stripeInvoiceId String?   @unique @map("stripe_invoice_id") @db.VarChar(255)
  amountDue       Int       @map("amount_due") // in cents
  amountPaid      Int       @default(0) @map("amount_paid")
  currency        String    @default("usd") @db.VarChar(10)
  status          String    @default("draft") @db.VarChar(50) // draft, open, paid, void, uncollectible
  invoiceUrl      String?   @map("invoice_url") @db.Text
  pdfUrl          String?   @map("pdf_url") @db.Text
  periodStart     DateTime? @map("period_start") @db.Timestamptz(6)
  periodEnd       DateTime? @map("period_end") @db.Timestamptz(6)
  dueDate         DateTime? @map("due_date") @db.Timestamptz(6)
  paidAt          DateTime? @map("paid_at") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([status])
  @@map("invoices")
}

/// UsageRecord (Track usage for billing)
model UsageRecord {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  sessionId      String?  @map("session_id") @db.VarChar(255)
  model          String   @db.VarChar(100)
  inputTokens    Int      @map("input_tokens")
  outputTokens   Int      @map("output_tokens")
  costCents      Int      @map("cost_cents")
  category       String?  @db.VarChar(50)
  agentId        String?  @map("agent_id") @db.Uuid
  metadata       Json?    @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([organizationId, model])
  @@index([agentId])
  @@map("usage_records")
}

// ============================================================================
// ONBOARDING TABLES
// ============================================================================

/// OnboardingState (Track user onboarding progress)
model OnboardingState {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @unique @map("organization_id") @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  currentStep    String    @default("welcome") @map("current_step") @db.VarChar(50)
  completedSteps String[]  @default([]) @map("completed_steps") @db.VarChar(50)
  skippedSteps   String[]  @default([]) @map("skipped_steps") @db.VarChar(50)
  metadata       Json?     @db.JsonB
  startedAt      DateTime  @default(now()) @map("started_at") @db.Timestamptz(6)
  completedAt    DateTime? @map("completed_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  checklistItems OnboardingChecklistItem[]

  @@index([userId])
  @@map("onboarding_states")
}

/// OnboardingChecklistItem (Individual onboarding tasks)
model OnboardingChecklistItem {
  id                String    @id @default(uuid()) @db.Uuid
  onboardingStateId String    @map("onboarding_state_id") @db.Uuid
  key               String    @db.VarChar(100)
  title             String    @db.VarChar(255)
  description       String?   @db.Text
  category          String?   @db.VarChar(50)
  required          Boolean   @default(false)
  completed         Boolean   @default(false)
  completedAt       DateTime? @map("completed_at") @db.Timestamptz(6)
  metadata          Json?     @db.JsonB
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  onboardingState OnboardingState @relation(fields: [onboardingStateId], references: [id], onDelete: Cascade)

  @@unique([onboardingStateId, key])
  @@index([onboardingStateId])
  @@map("onboarding_checklist_items")
}

// ============================================================================
// PUBLIC API & WEBHOOKS TABLES
// ============================================================================

/// APIKey (Public API keys for external integrations)
model APIKey {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  name           String    @db.VarChar(255)
  keyHash        String    @unique @map("key_hash") @db.VarChar(64) // SHA-256 hash of the key
  keyPrefix      String    @map("key_prefix") @db.VarChar(10) // First 8 chars for identification
  scopes         String[]  @default([]) @db.VarChar(100)
  rateLimit      Int       @default(1000) @map("rate_limit") // requests per hour
  expiresAt      DateTime? @map("expires_at") @db.Timestamptz(6)
  lastUsedAt     DateTime? @map("last_used_at") @db.Timestamptz(6)
  enabled        Boolean   @default(true)
  createdBy      String    @map("created_by") @db.Uuid
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId])
  @@index([keyPrefix])
  @@map("api_keys")
}

/// PublicWebhook (Outbound webhooks for external systems)
model PublicWebhook {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String   @db.VarChar(255)
  url            String   @db.Text
  secret         String   @db.VarChar(255) // For HMAC signature verification
  events         String[] @default([]) @db.VarChar(100) // event types to send
  enabled        Boolean  @default(true)
  retryCount     Int      @default(3) @map("retry_count")
  timeoutMs      Int      @default(30000) @map("timeout_ms")
  metadata       Json?    @db.JsonB
  createdBy      String   @map("created_by") @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  deliveries WebhookDelivery[]

  @@index([organizationId])
  @@index([enabled])
  @@map("public_webhooks")
}

/// WebhookDelivery (Track webhook delivery attempts)
model WebhookDelivery {
  id            String    @id @default(uuid()) @db.Uuid
  webhookId     String    @map("webhook_id") @db.Uuid
  eventType     String    @map("event_type") @db.VarChar(100)
  payload       Json      @db.JsonB
  status        String    @default("pending") @db.VarChar(50) // pending, success, failed
  statusCode    Int?      @map("status_code")
  responseBody  String?   @map("response_body") @db.Text
  attempts      Int       @default(0)
  lastAttemptAt DateTime? @map("last_attempt_at") @db.Timestamptz(6)
  nextRetryAt   DateTime? @map("next_retry_at") @db.Timestamptz(6)
  errorMessage  String?   @map("error_message") @db.Text
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  webhook PublicWebhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([status])
  @@index([nextRetryAt])
  @@map("webhook_deliveries")
}

// ============================================================================
// AI PROVIDER PREFERENCES
// ============================================================================

/// OrganizationAIProvider (Organization-level AI provider preferences)
model OrganizationAIProvider {
  id               String   @id @default(uuid()) @db.Uuid
  organizationId   String   @unique @map("organization_id") @db.Uuid
  defaultProvider  String   @default("anthropic") @map("default_provider") @db.VarChar(50)
  providers        Json     @default("{}") @db.JsonB // provider-specific settings
  modelPreferences Json     @default("{}") @map("model_preferences") @db.JsonB // category -> model mapping
  rateLimits       Json?    @map("rate_limits") @db.JsonB
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("organization_ai_providers")
}

// ============================================================================
// AGENT ACTIVITY TRACKING (Real-time monitoring)
// ============================================================================

model AgentActivity {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  sessionId      String    @map("session_id") @db.VarChar(255)
  agentType      String    @map("agent_type") @db.VarChar(100)
  agentName      String?   @map("agent_name") @db.VarChar(255)
  category       String?   @db.VarChar(100)
  status         String    @default("running") @db.VarChar(50)
  startedAt      DateTime  @default(now()) @map("started_at") @db.Timestamptz(6)
  completedAt    DateTime? @map("completed_at") @db.Timestamptz(6)
  durationMs     Int?      @map("duration_ms")
  inputData      Json?     @map("input_data") @db.JsonB
  outputData     Json?     @map("output_data") @db.JsonB
  errorMessage   String?   @map("error_message") @db.Text
  metadata       Json      @default("{}") @db.JsonB
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId])
  @@index([sessionId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([organizationId, createdAt(sort: Desc)])
  @@map("agent_activities")
}
