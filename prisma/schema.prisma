// Prisma Schema for Kyndof Corp System
// Multi-tenant SaaS with Google Workspace integration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// SKILL & MCP ECOSYSTEM ENUMS
// ============================================================================

enum ExtensionType {
  extension
  skill
  mcp_server
}

// ============================================================================
// CORE MULTI-TENANT TABLES
// ============================================================================

/// Organizations (Tenants)
/// Each organization represents a separate company/workspace
model Organization {
  id                     String    @id @default(uuid()) @db.Uuid
  slug                   String    @unique @db.VarChar(50) // Subdomain: kyndof, clientco
  name                   String    @db.VarChar(255)
  logoUrl                String?   @map("logo_url") @db.Text
  settings               Json      @default("{}") @db.JsonB
  monthlyBudgetCents     Int?      @map("monthly_budget_cents")
  currentMonthSpendCents Int       @default(0) @map("current_month_spend_cents")
  budgetResetAt          DateTime? @map("budget_reset_at") @db.Timestamptz(6)
  createdAt              DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Marketplace Hub settings
  installationMode String @default("recommend") @map("installation_mode") @db.VarChar(20) // recommend, auto, manual

  // Relations
  workspaceDomains       WorkspaceDomain[]
  memberships            Membership[]
  agents                 Agent[]
  teams                  Team[]
  projects               Project[]
  tasks                  Task[]
  goals                  Goal[]
  valueStreams           ValueStream[]
  kpis                   KPI[]
  workflows              Workflow[]
  notionConnections      NotionConnection[]
  mcpConnections         MCPConnection[]
  claudeAccounts         ClaudeAccount[]
  claudeMaxAccounts      ClaudeMaxAccount[]
  slackIntegrations      SlackIntegration[]
  orchestratorExecutions OrchestratorExecution[]
  agentActivities        AgentActivity[]
  featureFlagOverrides   FeatureFlagOverride[]
  featureFlagAuditLogs   FeatureFlagAuditLog[]
  marketplaceExtensions  MarketplaceExtension[]
  extensionInstallations ExtensionInstallation[]
  extensionPermissions   ExtensionPermission[]
  skillLearningPatterns  SkillLearningPattern[]
  agentSkillAssignments  AgentSkillAssignment[]
  extensionUsageLogs     ExtensionUsageLog[]
  slackWorkspaces        SlackWorkspace[]
  externalCredentials    ExternalMarketplaceCredential[]
  installationQueue      InstallationQueue[]
  n8nInstances           N8nInstance[]
  n8nWorkflows           N8nWorkflow[]
  n8nCredentials         N8nCredential[]
  knowledgeNodes         KnowledgeNode[]
  knowledgeEdges         KnowledgeEdge[]
  knowledgeClusters      KnowledgeCluster[]
  entityMemories         EntityMemory[]
  memories               Memory[]

  @@map("organizations")
}

/// Users (Global identity)
/// One user can belong to multiple organizations
model User {
  id            String   @id @default(uuid()) @db.Uuid
  email         String   @unique @db.VarChar(255)
  passwordHash  String?  @map("password_hash") @db.VarChar(255) // NULL for Google-only users
  googleId      String?  @unique @map("google_id") @db.VarChar(255) // Google OAuth sub
  displayName   String?  @map("display_name") @db.VarChar(255)
  avatarUrl     String?  @map("avatar_url") @db.Text
  emailVerified Boolean  @default(false) @map("email_verified")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  memberships            Membership[]
  sessions               Session[]
  orchestratorExecutions OrchestratorExecution[]
  featureFlagAuditLogs   FeatureFlagAuditLog[]
  slackUsers             SlackUser[]

  @@index([email])
  @@index([googleId])
  @@map("users")
}

/// Memberships (User ↔ Organization relationship)
/// Defines user's role and permissions within an organization
model Membership {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  role           String    @db.VarChar(50) // owner, admin, member
  permissions    Json      @default("{}") @db.JsonB
  invitedBy      String?   @map("invited_by") @db.Uuid
  invitedAt      DateTime  @default(now()) @map("invited_at") @db.Timestamptz(6)
  joinedAt       DateTime? @map("joined_at") @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Daily briefing preferences
  dailyBriefingEnabled  Boolean @default(false) @map("daily_briefing_enabled")
  dailyBriefingTime     String  @default("09:00") @map("daily_briefing_time") @db.VarChar(5)
  dailyBriefingTimezone String  @default("UTC") @map("daily_briefing_timezone") @db.VarChar(50)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("memberships")
}

/// Workspace Domains (Google Workspace domains)
/// Links Google Workspace domains to organizations
model WorkspaceDomain {
  id                String    @id @default(uuid()) @db.Uuid
  organizationId    String    @map("organization_id") @db.Uuid
  domain            String    @unique @db.VarChar(255) // nubabel.com, client-company.com
  verified          Boolean   @default(false)
  verificationToken String?   @map("verification_token") @db.VarChar(255)
  verifiedAt        DateTime? @map("verified_at") @db.Timestamptz(6)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, domain])
  @@index([organizationId])
  @@index([domain])
  @@map("workspace_domains")
}

/// Sessions (Enhanced for Orchestrator + JWT)
/// Tracks both authentication sessions AND orchestrator conversation sessions
model Session {
  id             String   @id @db.VarChar(255) // Can be UUID or ses_xxx format
  userId         String   @map("user_id") @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  tokenHash      String?  @unique @map("token_hash") @db.VarChar(255) // NULL for orchestrator sessions
  source         String?  @db.VarChar(50) // slack, web, terminal, api (for orchestrator)
  state          Json     @default("{}") @db.JsonB // Orchestrator state
  history        Json     @default("[]") @db.JsonB // Conversation history
  metadata       Json     @default("{}") @db.JsonB // Additional data
  expiresAt      DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  lastUsedAt     DateTime @default(now()) @map("last_used_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Session hijacking prevention
  ipAddress String? @map("ip_address") @db.VarChar(45)
  userAgent String? @map("user_agent") @db.Text

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([organizationId, expiresAt])
  @@index([tokenHash])
  @@index([expiresAt])
  @@index([source])
  @@map("sessions")
}

// ============================================================================
// AGENT HIERARCHY TABLES (Dynamic Team Management)
// ============================================================================

/// Agents (AI Agents - both permanent and temporary)
model Agent {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  name           String    @db.VarChar(100) // designer-bokyung, pm-killin-it-girl
  type           String    @db.VarChar(50) // permanent, temporary, contractor
  role           String    @db.Text // "K-POP 무대 의상 디자이너"
  managerId      String?   @map("manager_id") @db.Uuid // Reports to which agent
  teamId         String?   @map("team_id") @db.Uuid
  skills         String[]  @db.VarChar(100) // [fashion-design, clo3d, adobe-suite]
  sessionId      String?   @map("session_id") @db.VarChar(255) // Persistent session for continuity
  hiredAt        DateTime  @default(now()) @map("hired_at") @db.Timestamptz(6)
  contractEnd    DateTime? @map("contract_end") @db.Timestamptz(6) // NULL for permanent
  projectId      String?   @map("project_id") @db.Uuid // For project-based agents
  status         String    @default("active") @db.VarChar(50) // active, inactive, archived
  metadata       Json      @default("{}") @db.JsonB
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  manager      Agent?       @relation("AgentHierarchy", fields: [managerId], references: [id])
  subordinates Agent[]      @relation("AgentHierarchy")
  team         Team?        @relation(fields: [teamId], references: [id])

  skillAssignments AgentSkillAssignment[]

  @@index([organizationId])
  @@index([managerId])
  @@index([teamId])
  @@index([type])
  @@index([status])
  @@map("agents")
}

/// Teams (Groups of agents)
model Team {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String   @db.VarChar(255)
  leaderId       String?  @map("leader_id") @db.Uuid // Team leader
  type           String   @db.VarChar(50) // permanent, temporary, taskforce
  maxMembers     Int?     @map("max_members")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agents       Agent[]

  @@index([organizationId])
  @@map("teams")
}

// ============================================================================
// BUSINESS DATA TABLES (Tenant-scoped)
// ============================================================================

/// Projects
model Project {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  name           String    @db.VarChar(255)
  status         String    @db.VarChar(50)
  ownerId        String?   @map("owner_id") @db.Uuid
  startDate      DateTime? @map("start_date") @db.Date
  dueDate        DateTime? @map("due_date") @db.Date
  progress       Int       @default(0)
  budget         Decimal?  @db.Decimal(15, 2)
  description    String?   @db.Text
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tasks        Task[]

  @@index([organizationId, id])
  @@index([organizationId, createdAt(sort: Desc)])
  @@map("projects")
}

/// Tasks (RABSIC-enabled)
model Task {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @map("organization_id") @db.Uuid
  projectId       String?   @map("project_id") @db.Uuid
  name            String    @db.VarChar(500)
  status          String    @db.VarChar(50) // 1_ToDo, 2_InProgress, 5_Done
  dueDate         DateTime? @map("due_date") @db.Date
  urgencyScore    Int?      @default(0) @map("urgency_score")
  importanceScore Int?      @default(0) @map("importance_score")
  eisenhowerQuad  String?   @map("eisenhower_quadrant") @db.VarChar(50)

  // RABSIC fields
  responsible String[] @db.Uuid
  accountable String[] @db.Uuid // Must be exactly 1
  backup      String[] @db.Uuid
  support     String[] @db.Uuid
  informed    String[] @db.Uuid
  consulted   String[] @db.Uuid

  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project?     @relation(fields: [projectId], references: [id])

  @@index([organizationId, id])
  @@index([organizationId, status])
  @@index([organizationId, dueDate])
  @@index([organizationId, projectId])
  @@map("tasks")
}

/// Goals (Hierarchical)
model Goal {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @map("organization_id") @db.Uuid
  title           String    @db.VarChar(500)
  status          String    @db.VarChar(50)
  ownerPositionId String?   @map("owner_position_id") @db.Uuid
  dueDate         DateTime? @map("due_date") @db.Date
  progress        Int       @default(0)
  parentGoalId    String?   @map("parent_goal_id") @db.Uuid
  description     String?   @db.Text
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parentGoal   Goal?        @relation("GoalHierarchy", fields: [parentGoalId], references: [id])
  subGoals     Goal[]       @relation("GoalHierarchy")

  @@index([organizationId, id])
  @@index([parentGoalId])
  @@map("goals")
}

/// Value Streams (Business processes)
model ValueStream {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String   @db.VarChar(500)
  functions      String   @db.VarChar(100) // MD, Fashion Design, Marketing, CS, Sales
  type           String   @db.VarChar(50)
  input          String?  @db.Text
  output         String?  @db.Text
  parentId       String?  @map("parent_id") @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parent       ValueStream?  @relation("ValueStreamHierarchy", fields: [parentId], references: [id])
  subStreams   ValueStream[] @relation("ValueStreamHierarchy")

  @@index([organizationId, id])
  @@index([parentId])
  @@map("value_streams")
}

/// KPIs (Key Performance Indicators)
model KPI {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @map("organization_id") @db.Uuid
  name            String    @db.VarChar(255)
  status          String    @db.VarChar(50)
  ownerRoleId     String?   @map("owner_role_id") @db.Uuid
  target          String?   @db.VarChar(255)
  currentValue    Decimal?  @map("current_value") @db.Decimal(15, 2)
  unit            String?   @db.VarChar(50)
  updateFrequency String?   @map("update_frequency") @db.VarChar(50)
  dataSource      String?   @map("data_source") @db.Text
  upToDate        Boolean   @default(true) @map("up_to_date")
  lastUpdated     DateTime? @map("last_updated") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, id])
  @@map("kpis")
}

// ============================================================================
// WORKFLOW AUTOMATION TABLES (Phase 2 Week 3-4)
// ============================================================================

/// Workflows (Automation definitions)
model Workflow {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String   @db.VarChar(255)
  description    String?  @db.Text
  config         Json     @default("{}") @db.JsonB
  enabled        Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // SOP (Standard Operating Procedure) fields
  sopEnabled Boolean @default(false) @map("sop_enabled")
  sopSteps   Json?   @map("sop_steps") @db.JsonB // Array of step definitions

  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  executions   WorkflowExecution[]

  @@index([organizationId])
  @@index([organizationId, enabled])
  @@map("workflows")
}

/// Workflow Executions (Execution history)
model WorkflowExecution {
  id           String    @id @default(uuid()) @db.Uuid
  workflowId   String    @map("workflow_id") @db.Uuid
  status       String    @db.VarChar(50)
  inputData    Json?     @map("input_data") @db.JsonB
  outputData   Json?     @map("output_data") @db.JsonB
  errorMessage String?   @map("error_message") @db.Text
  startedAt    DateTime? @map("started_at") @db.Timestamptz(6)
  completedAt  DateTime? @map("completed_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("workflow_executions")
}

/// Orchestrator Executions (Conversation / delegation history)
/// Separate from WorkflowExecution to avoid mixing automation runs with orchestration.
model OrchestratorExecution {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  userId         String @map("user_id") @db.Uuid
  sessionId      String @map("session_id") @db.VarChar(255)

  category String   @db.VarChar(100)
  skills   String[] @default([]) @db.VarChar(100)
  status   String   @db.VarChar(50)
  duration Int      @default(0)

  inputData    Json?   @map("input_data") @db.JsonB
  outputData   Json?   @map("output_data") @db.JsonB
  errorMessage String? @map("error_message") @db.Text
  metadata     Json?   @default("{}") @db.JsonB

  // SOP execution tracking
  currentStep Int?  @map("current_step")
  stepResults Json? @map("step_results") @db.JsonB

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([organizationId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@index([sessionId])
  @@index([status])
  @@map("orchestrator_executions")
}

/// Agent Activity (Real-time agent execution tracking for visibility)
/// Tracks OMC agent activity for display in Slack and Web UI
model AgentActivity {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  // Agent identification
  agentType        String  @map("agent_type") @db.VarChar(100) // sisyphus, oracle, explore, librarian, executor, etc.
  agentName        String? @map("agent_name") @db.VarChar(255) // Human-readable name
  sessionId        String? @map("session_id") @db.VarChar(255) // OMC session ID
  parentActivityId String? @map("parent_activity_id") @db.Uuid // For nested delegations

  // Task details
  taskDescription String?  @map("task_description") @db.Text
  category        String?  @db.VarChar(100) // quick, ultrabrain, visual-engineering, etc.
  skills          String[] @default([]) @db.VarChar(100) // Skills loaded for this task

  // Status tracking
  status      String  @default("pending") @db.VarChar(50) // pending, running, completed, failed, cancelled
  progress    Int     @default(0) // 0-100 percent
  currentStep String? @map("current_step") @db.Text // What the agent is currently doing

  // Timing
  startedAt   DateTime? @map("started_at") @db.Timestamptz(6)
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)
  durationMs  Int?      @map("duration_ms")

  // Input/Output data
  inputData  Json? @map("input_data") @db.JsonB
  outputData Json? @map("output_data") @db.JsonB

  // Results
  result       Json?   @db.JsonB // Final result/output
  errorMessage String? @map("error_message") @db.Text

  // Slack visibility
  slackChannelId String? @map("slack_channel_id") @db.VarChar(50)
  slackThreadTs  String? @map("slack_thread_ts") @db.VarChar(50)
  slackMessageTs String? @map("slack_message_ts") @db.VarChar(50) // For updating messages

  // Claude Max account used (for quota tracking)
  claudeMaxAccountId String? @map("claude_max_account_id") @db.Uuid

  metadata  Json     @default("{}") @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parentActivity  AgentActivity?  @relation("AgentActivityHierarchy", fields: [parentActivityId], references: [id])
  childActivities AgentActivity[] @relation("AgentActivityHierarchy")

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([organizationId, status])
  @@index([sessionId])
  @@index([agentType])
  @@index([status])
  @@index([parentActivityId])
  @@index([slackChannelId, slackThreadTs])
  @@map("agent_activities")
}

// ============================================================================
// MCP INTEGRATION TABLES (Phase 2 Week 9-12)
// ============================================================================

/// Generic MCP Connections (Organization-level integrations)
/// Supports: Notion, Linear, Jira, Asana, Airtable, etc.
model MCPConnection {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  provider       String    @db.VarChar(100) // notion, linear, jira, asana, airtable, etc.
  namespace      String    @db.VarChar(100) // MCP namespace/scope identifier
  name           String    @db.VarChar(255) // User-friendly name
  config         Json      @db.JsonB // Provider-specific config (API keys, tokens, etc.)
  refreshToken   String?   @map("refresh_token") @db.Text // OAuth refresh token (encrypted)
  expiresAt      DateTime? @map("expires_at") @db.Timestamptz(6) // Token expiration timestamp
  enabled        Boolean   @default(true)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, enabled])
  @@index([provider])
  @@index([namespace])
  @@map("mcp_connections")
}

/// Claude Accounts (Per-account circuit breaker state)
/// Tracks API health and circuit breaker status for individual Claude accounts
model ClaudeAccount {
  id                  String    @id @default(uuid()) @db.Uuid
  organizationId      String    @map("organization_id") @db.Uuid
  name                String    @db.VarChar(255)
  status              String    @default("active") @db.VarChar(50)
  consecutiveFailures Int       @default(0) @map("consecutive_failures")
  halfOpenSuccesses   Int       @default(0) @map("half_open_successes")
  circuitOpensAt      DateTime? @map("circuit_opens_at") @db.Timestamptz(6)
  lastFailureAt       DateTime? @map("last_failure_at") @db.Timestamptz(6)
  lastFailureReason   String?   @map("last_failure_reason") @db.Text
  lastSuccessAt       DateTime? @map("last_success_at") @db.Timestamptz(6)
  metadata            Json      @default("{}") @db.JsonB
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  quotaAlerts  QuotaAlert[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([status])
  @@index([circuitOpensAt])
  @@map("claude_accounts")
}

model QuotaAlert {
  id           String    @id @default(uuid()) @db.Uuid
  accountId    String    @map("account_id") @db.Uuid
  type         String    @db.VarChar(50)
  severity     String    @db.VarChar(20)
  message      String    @db.Text
  currentValue Int       @map("current_value")
  limit        Int
  percentage   Float
  quotaType    String    @map("quota_type") @db.VarChar(50)
  resolvedAt   DateTime? @map("resolved_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  account ClaudeAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([type])
  @@index([severity])
  @@index([resolvedAt])
  @@index([createdAt(sort: Desc)])
  @@map("quota_alerts")
}

/// Claude Max Subscription Accounts (Consumer accounts running via CLI)
/// These are NOT API accounts - they use Claude CLI with subscription limits
model ClaudeMaxAccount {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  // Account identification
  nickname String @db.VarChar(100) // e.g., "work", "personal", "backup-1"
  email    String @db.VarChar(255) // Claude account email

  // Status tracking (no direct API - inferred from CLI behavior)
  status String @default("active") @db.VarChar(50) // active, rate_limited, exhausted, cooldown

  // Usage estimation (tracked from CLI output/errors)
  estimatedUsagePercent Float     @default(0) @map("estimated_usage_percent") // 0-100
  lastUsageUpdateAt     DateTime? @map("last_usage_update_at") @db.Timestamptz(6)
  estimatedResetAt      DateTime? @map("estimated_reset_at") @db.Timestamptz(6) // When quota resets

  // Session tracking for c2switcher-style rotation
  currentSessionId String?   @map("current_session_id") @db.VarChar(255)
  lastActiveAt     DateTime? @map("last_active_at") @db.Timestamptz(6)

  // Rate limit detection
  consecutiveRateLimits Int       @default(0) @map("consecutive_rate_limits")
  lastRateLimitAt       DateTime? @map("last_rate_limit_at") @db.Timestamptz(6)
  cooldownUntil         DateTime? @map("cooldown_until") @db.Timestamptz(6)

  // Priority for selection algorithm (higher = prefer)
  priority Int @default(100)

  // Encrypted credentials storage reference (stored separately)
  credentialRef String? @map("credential_ref") @db.VarChar(255)

  metadata  Json     @default("{}") @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, nickname])
  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([status])
  @@index([priority])
  @@index([cooldownUntil])
  @@map("claude_max_accounts")
}

/// Notion Connections (supports OAuth and legacy API key)
model NotionConnection {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  apiKey         String @default("") @map("api_key") @db.VarChar(255) // Legacy API key (empty when using OAuth)

  // OAuth fields (filled after OAuth flow)
  accessToken   String?   @map("access_token") @db.Text // OAuth access token (encrypted)
  botId         String?   @map("bot_id") @db.VarChar(100)
  workspaceId   String?   @map("workspace_id") @db.VarChar(100)
  workspaceName String?   @map("workspace_name") @db.VarChar(255)
  workspaceIcon String?   @map("workspace_icon") @db.Text
  connectedAt   DateTime? @map("connected_at") @db.Timestamptz(6)

  defaultDatabaseId String?  @map("default_database_id") @db.VarChar(255)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId])
  @@index([organizationId])
  @@map("notion_connections")
}

// ============================================================================
// SLACK INTEGRATION TABLES (Phase 2 Week 9-12 - Multi-Tenant)
// ============================================================================

/// Slack Integrations (Per-organization Slack workspaces)
/// Supports BYOA (Bring Your Own App) - organizations provide their own Slack App credentials
model SlackIntegration {
  id             String  @id @default(uuid()) @db.Uuid
  organizationId String  @unique @map("organization_id") @db.Uuid
  workspaceId    String? @unique @map("workspace_id") @db.VarChar(50) // Slack Team ID (T01234ABCD) - filled after OAuth
  workspaceName  String? @map("workspace_name") @db.VarChar(255) // Friendly name - filled after OAuth

  // Slack App credentials (BYOA - encrypted)
  clientId     String? @map("client_id") @db.Text // Slack App Client ID (encrypted)
  clientSecret String? @map("client_secret") @db.Text // Slack App Client Secret (encrypted)

  // OAuth tokens (encrypted in application layer before storage) - filled after OAuth
  botToken String? @map("bot_token") @db.Text // xoxb-... (encrypted)
  appToken String? @map("app_token") @db.Text // xapp-... (encrypted, for Socket Mode)

  // Security
  signingSecret String? @map("signing_secret") @db.Text // Webhook verification (encrypted)

  // OAuth metadata
  botUserId String?  @map("bot_user_id") @db.VarChar(50) // U01234ABCD
  scopes    String[] @default([]) @db.VarChar(100) // [app_mentions:read, chat:write, ...]

  // Installation metadata
  installedBy String?  @map("installed_by") @db.Uuid // Which user authorized
  installedAt DateTime @default(now()) @map("installed_at") @db.Timestamptz(6)

  // Status
  enabled         Boolean   @default(true)
  lastHealthCheck DateTime? @map("last_health_check") @db.Timestamptz(6)
  healthStatus    String    @default("unknown") @map("health_status") @db.VarChar(50) // healthy, degraded, offline, unknown

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([workspaceId])
  @@index([enabled])
  @@map("slack_integrations")
}

// ==========================================================================
// FEATURE FLAGS (Safe release / rollout)
// ==========================================================================

model FeatureFlag {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique @db.VarChar(100) // e.g. "new_dashboard"
  name        String   @db.VarChar(255)
  description String?  @db.Text
  enabled     Boolean  @default(false) // Global kill switch
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  rules     FeatureFlagRule[]
  overrides FeatureFlagOverride[]
  auditLogs FeatureFlagAuditLog[]

  @@index([key])
  @@map("feature_flags")
}

model FeatureFlagRule {
  id            String @id @default(uuid()) @db.Uuid
  featureFlagId String @map("feature_flag_id") @db.Uuid

  type            String   @db.VarChar(50) // ALLOWLIST | BLOCKLIST | PERCENTAGE
  organizationIds String[] @default([]) @map("organization_ids") @db.Uuid
  percentage      Int      @default(0)
  priority        Int      @default(100)
  enabled         Boolean  @default(true)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  featureFlag FeatureFlag @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)

  @@index([featureFlagId, priority])
  @@index([enabled, priority])
  @@index([type])
  @@map("feature_flag_rules")
}

model FeatureFlagOverride {
  id             String @id @default(uuid()) @db.Uuid
  featureFlagId  String @map("feature_flag_id") @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  enabled   Boolean
  reason    String?   @db.Text
  expiresAt DateTime? @map("expires_at") @db.Timestamptz(6)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  featureFlag  FeatureFlag  @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([featureFlagId, organizationId])
  @@index([organizationId])
  @@index([expiresAt])
  @@map("feature_flag_overrides")
}

model FeatureFlagAuditLog {
  id            String @id @default(uuid()) @db.Uuid
  featureFlagId String @map("feature_flag_id") @db.Uuid

  action String @db.VarChar(50) // CREATED | UPDATED | RULE_SET | OVERRIDE_SET | EVALUATED

  organizationId String? @map("organization_id") @db.Uuid
  userId         String? @map("user_id") @db.Uuid
  metadata       Json?   @db.JsonB

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  featureFlag  FeatureFlag   @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([featureFlagId, createdAt(sort: Desc)])
  @@index([organizationId, createdAt(sort: Desc)])
  @@index([action, createdAt(sort: Desc)])
  @@map("feature_flag_audit_logs")
}

// ============================================================================
// AUDIT LOG TABLE (System-wide action tracking)
// ============================================================================

/// AuditLog (Tracks all user/system actions)
model AuditLog {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  action       String  @db.VarChar(100) // user.login, workflow.execute, etc.
  userId       String? @map("user_id") @db.Uuid
  resourceType String? @map("resource_type") @db.VarChar(100)
  resourceId   String? @map("resource_id") @db.VarChar(255)
  details      Json?   @db.JsonB
  ipAddress    String? @map("ip_address") @db.VarChar(45)
  userAgent    String? @map("user_agent") @db.Text
  success      Boolean @default(true)
  errorMessage String? @map("error_message") @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([action, createdAt(sort: Desc)])
  @@index([resourceType, resourceId])
  @@map("audit_logs")
}

// ============================================================================
// APPROVAL WORKFLOW TABLES
// ============================================================================

/// Approvals (Budget, deployment, content approvals)
model Approval {
  id                 String    @id @default(uuid()) @db.Uuid
  organizationId     String    @map("organization_id") @db.Uuid
  requesterId        String    @map("requester_id") @db.Uuid
  approverId         String    @map("approver_id") @db.Uuid
  fallbackApproverId String?   @map("fallback_approver_id") @db.Uuid
  type               String    @db.VarChar(50) // budget, deployment, content
  title              String    @db.VarChar(500)
  description        String    @db.Text
  context            Json?     @db.JsonB
  status             String    @default("pending") @db.VarChar(50) // pending, approved, rejected, expired
  responseNote       String?   @map("response_note") @db.Text
  slackMessageTs     String?   @map("slack_message_ts") @db.VarChar(50)
  slackChannelId     String?   @map("slack_channel_id") @db.VarChar(50)
  expiresAt          DateTime  @map("expires_at") @db.Timestamptz(6)
  respondedAt        DateTime? @map("responded_at") @db.Timestamptz(6)
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId, status])
  @@index([approverId, status])
  @@index([fallbackApproverId])
  @@index([requesterId])
  @@index([expiresAt])
  @@map("approvals")
}

// ============================================================================
// PERMISSION DELEGATION TABLES
// ============================================================================

/// Delegations (Permission transfers between users)
model Delegation {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  delegatorId    String    @map("delegator_id") @db.Uuid
  delegateeId    String    @map("delegatee_id") @db.Uuid
  permissions    String[]  @db.VarChar(100)
  scope          Json?     @db.JsonB
  validFrom      DateTime  @map("valid_from") @db.Timestamptz(6)
  validUntil     DateTime  @map("valid_until") @db.Timestamptz(6)
  reason         String    @db.Text
  revokedAt      DateTime? @map("revoked_at") @db.Timestamptz(6)
  revokedBy      String?   @map("revoked_by") @db.Uuid
  revokedReason  String?   @map("revoked_reason") @db.Text
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId, delegateeId])
  @@index([organizationId, delegatorId])
  @@index([delegateeId, validUntil])
  @@index([validUntil])
  @@map("delegations")
}

/// Agent Permission Overrides (Custom permissions for specific agents)
model AgentPermissionOverride {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  agentId        String   @map("agent_id") @db.Uuid
  readPatterns   String[] @default([]) @map("read_patterns") @db.VarChar(255)
  writePatterns  String[] @default([]) @map("write_patterns") @db.VarChar(255)
  tools          String[] @default([]) @db.VarChar(255)
  restricted     String[] @default([]) @db.VarChar(255)
  approvalRules  Json?    @map("approval_rules") @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([organizationId, agentId])
  @@index([organizationId])
  @@index([agentId])
  @@map("agent_permission_overrides")
}

// ============================================================================
// OKR (OBJECTIVES AND KEY RESULTS) TABLES
// ============================================================================

/// Objectives (OKR Objectives)
model Objective {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  title          String   @db.VarChar(500)
  description    String?  @db.Text
  quarter        String   @db.VarChar(10) // e.g., "2026-Q1"
  ownerId        String   @map("owner_id") @db.Uuid
  status         String   @default("on_track") @db.VarChar(50) // on_track, at_risk, behind
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  keyResults KeyResult[]

  @@index([organizationId, quarter])
  @@index([ownerId])
  @@map("objectives")
}

/// Key Results (OKR Key Results)
model KeyResult {
  id          String   @id @default(uuid()) @db.Uuid
  objectiveId String   @map("objective_id") @db.Uuid
  title       String   @db.VarChar(500)
  target      Float
  current     Float    @default(0)
  unit        String   @db.VarChar(50) // percentage, count, currency, etc.
  ownerId     String?  @map("owner_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  objective Objective @relation(fields: [objectiveId], references: [id], onDelete: Cascade)

  @@index([objectiveId])
  @@index([ownerId])
  @@map("key_results")
}

// ============================================================================
// ORGANIZATION CHANGE MANAGEMENT TABLES
// ============================================================================

/// Organization Changes (Track organizational changes and responses)
model OrganizationChange {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  title          String   @db.VarChar(500)
  description    String   @db.Text
  type           String   @db.VarChar(50) // new_agent, process_modification, integration_update, role_change
  status         String   @default("pending") @db.VarChar(50) // pending, in_progress, completed, cancelled
  impactLevel    String   @default("low") @map("impact_level") @db.VarChar(20) // low, medium, high
  requestedBy    String   @map("requested_by") @db.Uuid
  impactAnalysis String?  @map("impact_analysis") @db.Text
  prUrl          String?  @map("pr_url") @db.Text
  metadata       Json?    @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId, status])
  @@index([requestedBy])
  @@index([type])
  @@index([impactLevel])
  @@map("organization_changes")
}

// ============================================================================
// GOOGLE DRIVE INTEGRATION TABLES
// ============================================================================

/// Drive Connections (Google Drive OAuth connections)
model DriveConnection {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @unique @map("organization_id") @db.Uuid
  accessToken     String    @map("access_token") @db.Text // Encrypted
  refreshToken    String?   @map("refresh_token") @db.Text // Encrypted
  expiresAt       DateTime? @map("expires_at") @db.Timestamptz(6)
  defaultFolderId String?   @map("default_folder_id") @db.VarChar(255)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId])
  @@map("drive_connections")
}

/// Google Calendar Connections (Google Calendar OAuth connections)
model GoogleCalendarConnection {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @unique @map("organization_id") @db.Uuid
  accessToken    String    @map("access_token") @db.Text // Encrypted
  refreshToken   String?   @map("refresh_token") @db.Text // Encrypted
  expiresAt      DateTime? @map("expires_at") @db.Timestamptz(6)
  calendarId     String?   @map("calendar_id") @db.VarChar(255) // Primary calendar ID (usually email)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId])
  @@map("google_calendar_connections")
}

// ============================================================================
// SECURITY TABLES
// ============================================================================

/// Session Hijacking Attempts (Security monitoring)
model SessionHijackingAttempt {
  id             String   @id @default(uuid()) @db.Uuid
  sessionId      String   @map("session_id") @db.VarChar(255)
  userId         String   @map("user_id") @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  type           String   @db.VarChar(50) // ip_change, user_agent_change, suspicious_activity
  mismatchType   String?  @map("mismatch_type") @db.VarChar(50) // ip_mismatch, user_agent_mismatch, both
  originalIp     String?  @map("original_ip") @db.VarChar(45)
  attemptedIp    String?  @map("attempted_ip") @db.VarChar(45)
  originalAgent  String?  @map("original_agent") @db.Text
  attemptedAgent String?  @map("attempted_agent") @db.Text
  blocked        Boolean  @default(true)
  metadata       Json?    @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([sessionId])
  @@index([userId, createdAt(sort: Desc)])
  @@index([organizationId, createdAt(sort: Desc)])
  @@map("session_hijacking_attempts")
}

// ============================================================================
// SKILL & MCP ECOSYSTEM TABLES
// ============================================================================

/// MarketplaceExtension - Unified marketplace item for extensions/skills/MCP servers
model MarketplaceExtension {
  id             String  @id @default(uuid()) @db.Uuid
  organizationId String? @map("organization_id") @db.Uuid

  slug        String @db.VarChar(100)
  name        String @db.VarChar(255)
  description String @db.Text
  version     String @db.VarChar(20)

  extensionType ExtensionType @default(extension) @map("extension_type")
  category      String        @db.VarChar(50)
  tags          String[]      @default([]) @db.VarChar(50)

  source     String? @db.VarChar(50)
  format     String? @db.VarChar(20)
  manifest   Json    @default("{}") @db.JsonB
  definition Json?   @db.JsonB

  runtimeType   String?  @map("runtime_type") @db.VarChar(30)
  runtimeConfig Json?    @map("runtime_config") @db.JsonB
  triggers      String[] @default([]) @db.VarChar(100)
  parameters    Json     @default("[]") @db.JsonB
  outputs       Json     @default("[]") @db.JsonB
  dependencies  String[] @default([]) @db.VarChar(100)
  toolsRequired String[] @default([]) @map("tools_required") @db.VarChar(100)
  mcpProviders  String[] @default([]) @map("mcp_providers") @db.VarChar(50)

  publisherId String? @map("publisher_id") @db.Uuid
  isPublic    Boolean @default(false) @map("is_public")
  verified    Boolean @default(false)
  downloads   Int     @default(0)
  rating      Float?  @db.Real
  ratingCount Int     @default(0) @map("rating_count")

  status  String  @default("active") @db.VarChar(20)
  enabled Boolean @default(true)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy String?  @map("created_by") @db.Uuid

  organization     Organization?           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  publisher        ExtensionPublisher?     @relation(fields: [publisherId], references: [id])
  versions         ExtensionVersion[]
  installations    ExtensionInstallation[]
  usageLogs        ExtensionUsageLog[]
  permissions      ExtensionPermission[]
  agentAssignments AgentSkillAssignment[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([extensionType])
  @@index([category])
  @@index([isPublic, status])
  @@map("marketplace_extensions")
}

/// ExtensionVersion - Version history
model ExtensionVersion {
  id          String  @id @default(uuid()) @db.Uuid
  extensionId String  @map("extension_id") @db.Uuid
  version     String  @db.VarChar(20)
  manifest    Json    @db.JsonB
  definition  Json?   @db.JsonB
  changelog   String? @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy String?  @map("created_by") @db.Uuid

  extension MarketplaceExtension @relation(fields: [extensionId], references: [id], onDelete: Cascade)

  @@unique([extensionId, version])
  @@index([extensionId])
  @@map("extension_versions")
}

/// ExtensionInstallation - Org-level installations
model ExtensionInstallation {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  extensionId    String @map("extension_id") @db.Uuid
  version        String @db.VarChar(20)

  configOverrides Json? @map("config_overrides") @db.JsonB
  credentials     Json? @db.JsonB

  status     String  @default("active") @db.VarChar(20)
  autoUpdate Boolean @default(true) @map("auto_update")

  installedAt DateTime @default(now()) @map("installed_at") @db.Timestamptz(6)
  installedBy String   @map("installed_by") @db.Uuid
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  extension    MarketplaceExtension @relation(fields: [extensionId], references: [id], onDelete: Cascade)

  @@unique([organizationId, extensionId])
  @@index([organizationId])
  @@index([extensionId])
  @@map("extension_installations")
}

/// ExtensionPublisher - Publisher accounts
model ExtensionPublisher {
  id             String  @id @default(uuid()) @db.Uuid
  organizationId String? @map("organization_id") @db.Uuid

  name        String  @db.VarChar(255)
  slug        String  @unique @db.VarChar(100)
  description String? @db.Text
  website     String? @db.Text
  verified    Boolean @default(false)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  extensions MarketplaceExtension[]
  payouts    PublisherPayout[]

  @@index([organizationId])
  @@map("extension_publishers")
}

/// ExtensionPermission - Access control
model ExtensionPermission {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  extensionId String? @map("extension_id") @db.Uuid
  category    String? @db.VarChar(50)

  agentId String? @map("agent_id") @db.Uuid
  roleId  String? @map("role_id") @db.VarChar(50)

  canExecute   Boolean @default(true) @map("can_execute")
  canConfigure Boolean @default(false) @map("can_configure")
  canInstall   Boolean @default(false) @map("can_install")

  allowedTools String[] @default([]) @map("allowed_tools") @db.VarChar(100)
  deniedTools  String[] @default([]) @map("denied_tools") @db.VarChar(100)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  extension    MarketplaceExtension? @relation(fields: [extensionId], references: [id], onDelete: Cascade)
  organization Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([extensionId])
  @@index([agentId])
  @@map("extension_permissions")
}

/// ExtensionUsageLog - Execution history
model ExtensionUsageLog {
  id             String  @id @default(uuid()) @db.Uuid
  organizationId String  @map("organization_id") @db.Uuid
  extensionId    String  @map("extension_id") @db.Uuid
  agentId        String? @map("agent_id") @db.Uuid
  sessionId      String? @map("session_id") @db.VarChar(255)

  executionId String @map("execution_id") @db.Uuid
  status      String @db.VarChar(20)
  durationMs  Int    @map("duration_ms")

  errorCode    String? @map("error_code") @db.VarChar(50)
  errorMessage String? @map("error_message") @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  extension    MarketplaceExtension @relation(fields: [extensionId], references: [id], onDelete: Cascade)
  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([extensionId])
  @@map("extension_usage_logs")
}

/// SkillLearningPattern - Pattern detection for skill generation
model SkillLearningPattern {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  patternHash String @map("pattern_hash") @db.VarChar(64)
  patternType String @map("pattern_type") @db.VarChar(30)
  steps       Json   @db.JsonB
  frequency   Int    @default(1)

  triggerPhrases String[] @default([]) @map("trigger_phrases") @db.Text
  contextTags    String[] @default([]) @map("context_tags") @db.VarChar(50)

  status String @default("detected") @db.VarChar(20)

  firstSeenAt DateTime @default(now()) @map("first_seen_at") @db.Timestamptz(6)
  lastSeenAt  DateTime @default(now()) @map("last_seen_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, patternHash])
  @@index([organizationId])
  @@index([status])
  @@map("skill_learning_patterns")
}

/// AgentSkillAssignment - Agent-specific skill configurations
model AgentSkillAssignment {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  agentId        String @map("agent_id") @db.Uuid
  extensionId    String @map("extension_id") @db.Uuid

  assignmentType  String  @map("assignment_type") @db.VarChar(20)
  enabled         Boolean @default(true)
  priority        Int     @default(100)
  configOverrides Json?   @map("config_overrides") @db.JsonB

  successCount Int @default(0) @map("success_count")
  failureCount Int @default(0) @map("failure_count")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  agent        Agent                @relation(fields: [agentId], references: [id], onDelete: Cascade)
  extension    MarketplaceExtension @relation(fields: [extensionId], references: [id], onDelete: Cascade)
  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([agentId, extensionId])
  @@index([organizationId])
  @@index([agentId])
  @@map("agent_skill_assignments")
}

/// MarketplaceCategory - Extension categories and subcategories
model MarketplaceCategory {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @db.VarChar(100)
  slug        String  @unique @db.VarChar(100)
  description String? @db.Text
  icon        String? @db.VarChar(100) // Icon name or emoji
  parentId    String? @map("parent_id") @db.Uuid // Self-reference for subcategories
  sortOrder   Int     @default(0) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  parent        MarketplaceCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  subcategories MarketplaceCategory[] @relation("CategoryHierarchy")

  @@index([parentId])
  @@index([sortOrder])
  @@map("marketplace_categories")
}

/// ExtensionReview - User reviews for marketplace extensions
model ExtensionReview {
  id          String  @id @default(uuid()) @db.Uuid
  extensionId String  @map("extension_id") @db.Uuid
  userId      String  @map("user_id") @db.Uuid
  rating      Int // 1-5 stars
  title       String? @db.VarChar(255)
  content     String? @db.Text
  isVerified  Boolean @default(false) @map("is_verified") // Verified purchase

  helpfulCount   Int @default(0) @map("helpful_count")
  unhelpfulCount Int @default(0) @map("unhelpful_count")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  helpfulVotes ReviewHelpfulVote[]

  @@unique([extensionId, userId]) // One review per user per extension
  @@index([extensionId])
  @@index([userId])
  @@index([rating])
  @@map("extension_reviews")
}

/// ReviewHelpfulVote - Votes on extension reviews
model ReviewHelpfulVote {
  id        String  @id @default(uuid()) @db.Uuid
  reviewId  String  @map("review_id") @db.Uuid
  userId    String  @map("user_id") @db.Uuid
  isHelpful Boolean @map("is_helpful") // true = helpful, false = not helpful

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  review ExtensionReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId]) // One vote per user per review
  @@index([reviewId])
  @@map("review_helpful_votes")
}

/// PublisherPayout - Payment records for extension publishers
model PublisherPayout {
  id            String    @id @default(uuid()) @db.Uuid
  publisherId   String    @map("publisher_id") @db.Uuid
  amount        Int // Amount in cents
  currency      String    @default("usd") @db.VarChar(10)
  status        String    @default("pending") @db.VarChar(50) // pending, processing, completed, failed, cancelled
  paymentMethod String?   @map("payment_method") @db.VarChar(50) // stripe, paypal, bank_transfer
  transactionId String?   @map("transaction_id") @db.VarChar(255) // External payment reference
  periodStart   DateTime? @map("period_start") @db.Timestamptz(6) // Payout period
  periodEnd     DateTime? @map("period_end") @db.Timestamptz(6)
  processedAt   DateTime? @map("processed_at") @db.Timestamptz(6)
  failureReason String?   @map("failure_reason") @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  publisher ExtensionPublisher @relation(fields: [publisherId], references: [id], onDelete: Cascade)

  @@index([publisherId])
  @@index([status])
  @@index([processedAt])
  @@map("publisher_payouts")
}

// ============================================================================
// BILLING & SUBSCRIPTION TABLES
// ============================================================================

/// Subscription (Organization billing subscription)
model Subscription {
  id                   String    @id @default(uuid()) @db.Uuid
  organizationId       String    @unique @map("organization_id") @db.Uuid
  stripeCustomerId     String?   @map("stripe_customer_id") @db.VarChar(255)
  stripeSubscriptionId String?   @map("stripe_subscription_id") @db.VarChar(255)
  plan                 String    @default("free") @db.VarChar(50) // free, starter, pro, enterprise
  status               String    @default("active") @db.VarChar(50) // active, past_due, canceled, trialing
  currentPeriodStart   DateTime? @map("current_period_start") @db.Timestamptz(6)
  currentPeriodEnd     DateTime? @map("current_period_end") @db.Timestamptz(6)
  cancelAtPeriodEnd    Boolean   @default(false) @map("cancel_at_period_end")
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  invoices Invoice[]

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@map("subscriptions")
}

/// Invoice (Billing invoices)
model Invoice {
  id              String    @id @default(uuid()) @db.Uuid
  subscriptionId  String    @map("subscription_id") @db.Uuid
  stripeInvoiceId String?   @unique @map("stripe_invoice_id") @db.VarChar(255)
  amountDue       Int       @map("amount_due") // in cents
  amountPaid      Int       @default(0) @map("amount_paid")
  currency        String    @default("usd") @db.VarChar(10)
  status          String    @default("draft") @db.VarChar(50) // draft, open, paid, void, uncollectible
  invoiceUrl      String?   @map("invoice_url") @db.Text
  pdfUrl          String?   @map("pdf_url") @db.Text
  periodStart     DateTime? @map("period_start") @db.Timestamptz(6)
  periodEnd       DateTime? @map("period_end") @db.Timestamptz(6)
  dueDate         DateTime? @map("due_date") @db.Timestamptz(6)
  paidAt          DateTime? @map("paid_at") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([status])
  @@map("invoices")
}

/// UsageRecord (Track usage for billing)
model UsageRecord {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  sessionId      String?  @map("session_id") @db.VarChar(255)
  model          String   @db.VarChar(100)
  inputTokens    Int      @map("input_tokens")
  outputTokens   Int      @map("output_tokens")
  costCents      Int      @map("cost_cents")
  category       String?  @db.VarChar(50)
  agentId        String?  @map("agent_id") @db.Uuid
  metadata       Json?    @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([organizationId, model])
  @@index([agentId])
  @@map("usage_records")
}

// ============================================================================
// ONBOARDING TABLES
// ============================================================================

/// OnboardingState (Track user onboarding progress)
model OnboardingState {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @unique @map("organization_id") @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  currentStep    String    @default("welcome") @map("current_step") @db.VarChar(50)
  completedSteps String[]  @default([]) @map("completed_steps") @db.VarChar(50)
  skippedSteps   String[]  @default([]) @map("skipped_steps") @db.VarChar(50)
  metadata       Json?     @db.JsonB
  startedAt      DateTime  @default(now()) @map("started_at") @db.Timestamptz(6)
  completedAt    DateTime? @map("completed_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  checklistItems OnboardingChecklistItem[]

  @@index([userId])
  @@map("onboarding_states")
}

/// OnboardingChecklistItem (Individual onboarding tasks)
model OnboardingChecklistItem {
  id                String    @id @default(uuid()) @db.Uuid
  onboardingStateId String    @map("onboarding_state_id") @db.Uuid
  key               String    @db.VarChar(100)
  title             String    @db.VarChar(255)
  description       String?   @db.Text
  category          String?   @db.VarChar(50)
  required          Boolean   @default(false)
  completed         Boolean   @default(false)
  completedAt       DateTime? @map("completed_at") @db.Timestamptz(6)
  metadata          Json?     @db.JsonB
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  onboardingState OnboardingState @relation(fields: [onboardingStateId], references: [id], onDelete: Cascade)

  @@unique([onboardingStateId, key])
  @@index([onboardingStateId])
  @@map("onboarding_checklist_items")
}

// ============================================================================
// PUBLIC API & WEBHOOKS TABLES
// ============================================================================

/// APIKey (Public API keys for external integrations)
model APIKey {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  userId         String    @map("user_id") @db.Uuid // Owner of this API key
  name           String    @db.VarChar(255)
  keyHash        String    @unique @map("key_hash") @db.VarChar(64) // SHA-256 hash of the key
  keyPrefix      String    @map("key_prefix") @db.VarChar(10) // First 8 chars for identification
  scopes         String[]  @default([]) @db.VarChar(100)
  rateLimitTier  String    @default("standard") @map("rate_limit_tier") @db.VarChar(50) // free, standard, premium, unlimited
  isActive       Boolean   @default(true) @map("is_active")
  expiresAt      DateTime? @map("expires_at") @db.Timestamptz(6)
  lastUsedAt     DateTime? @map("last_used_at") @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId])
  @@index([keyPrefix])
  @@map("api_keys")
}

/// PublicWebhook (Outbound webhooks for external systems)
model PublicWebhook {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String   @db.VarChar(255)
  url            String   @db.Text
  secret         String   @db.VarChar(255) // For HMAC signature verification
  events         String[] @default([]) @db.VarChar(100) // event types to send
  enabled        Boolean  @default(true)
  retryCount     Int      @default(3) @map("retry_count")
  timeoutMs      Int      @default(30000) @map("timeout_ms")
  metadata       Json?    @db.JsonB
  createdBy      String   @map("created_by") @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  deliveries WebhookDelivery[]

  @@index([organizationId])
  @@index([enabled])
  @@map("public_webhooks")
}

/// WebhookDelivery (Track webhook delivery attempts)
model WebhookDelivery {
  id            String    @id @default(uuid()) @db.Uuid
  webhookId     String    @map("webhook_id") @db.Uuid
  eventType     String    @map("event_type") @db.VarChar(100)
  payload       Json      @db.JsonB
  status        String    @default("pending") @db.VarChar(50) // pending, success, failed
  statusCode    Int?      @map("status_code")
  responseBody  String?   @map("response_body") @db.Text
  attempts      Int       @default(0)
  lastAttemptAt DateTime? @map("last_attempt_at") @db.Timestamptz(6)
  nextRetryAt   DateTime? @map("next_retry_at") @db.Timestamptz(6)
  errorMessage  String?   @map("error_message") @db.Text
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  webhook PublicWebhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([status])
  @@index([nextRetryAt])
  @@map("webhook_deliveries")
}

// ============================================================================
// AI PROVIDER PREFERENCES
// ============================================================================

/// OrganizationAIProvider (Organization-level AI provider preferences)
model OrganizationAIProvider {
  id               String   @id @default(uuid()) @db.Uuid
  organizationId   String   @unique @map("organization_id") @db.Uuid
  defaultProvider  String   @default("anthropic") @map("default_provider") @db.VarChar(50)
  providers        Json     @default("{}") @db.JsonB // provider-specific settings
  modelPreferences Json     @default("{}") @map("model_preferences") @db.JsonB // category -> model mapping
  rateLimits       Json?    @map("rate_limits") @db.JsonB
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("organization_ai_providers")
}

// ============================================================================
// WORK QUEUE & JOB EXECUTION (PostgreSQL Queue Pattern)
// ============================================================================

/// WorkQueue - PostgreSQL-backed queue for reliable task processing
/// Used as a durable fallback when Redis/BullMQ is unavailable
model WorkQueue {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  queueName      String    @map("queue_name") @db.VarChar(100) // slack-events, orchestration, notifications, etc.
  priority       Int       @default(0) // Higher = more important
  status         String    @default("pending") @db.VarChar(50) // pending, processing, completed, failed, dead_letter
  payload        Json      @db.JsonB
  result         Json?     @db.JsonB
  errorMessage   String?   @map("error_message") @db.Text
  attempts       Int       @default(0)
  maxAttempts    Int       @default(3) @map("max_attempts")
  lockedBy       String?   @map("locked_by") @db.VarChar(255) // Worker ID that locked this job
  lockedAt       DateTime? @map("locked_at") @db.Timestamptz(6)
  scheduledFor   DateTime? @map("scheduled_for") @db.Timestamptz(6) // For delayed jobs
  completedAt    DateTime? @map("completed_at") @db.Timestamptz(6)
  metadata       Json      @default("{}") @db.JsonB
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  jobExecutions JobExecution[]

  @@index([queueName, status, priority(sort: Desc), createdAt])
  @@index([organizationId, queueName])
  @@index([status, scheduledFor])
  @@index([lockedBy, lockedAt])
  @@index([status, attempts])
  @@map("work_queue")
}

/// JobExecution - Tracks individual execution attempts of work queue items
model JobExecution {
  id           String    @id @default(uuid()) @db.Uuid
  workQueueId  String    @map("work_queue_id") @db.Uuid
  workerId     String    @map("worker_id") @db.VarChar(255) // Which worker processed this
  attempt      Int // Attempt number (1, 2, 3...)
  status       String    @db.VarChar(50) // started, completed, failed, timeout
  result       Json?     @db.JsonB
  errorMessage String?   @map("error_message") @db.Text
  startedAt    DateTime  @default(now()) @map("started_at") @db.Timestamptz(6)
  completedAt  DateTime? @map("completed_at") @db.Timestamptz(6)
  durationMs   Int?      @map("duration_ms")

  workQueue WorkQueue @relation(fields: [workQueueId], references: [id], onDelete: Cascade)

  @@index([workQueueId, attempt])
  @@index([workerId, startedAt(sort: Desc)])
  @@index([status])
  @@map("job_executions")
}

// ============================================================================
// SLACK USER PROVISIONING TABLES
// ============================================================================

/// SlackUser (Maps Slack workspace users to internal Users)
/// Enables automatic user provisioning from Slack interactions
model SlackUser {
  id             String    @id @default(cuid())
  slackUserId    String    @unique @map("slack_user_id")
  slackTeamId    String    @map("slack_team_id")
  userId         String    @map("user_id") @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  displayName    String?   @map("display_name") @db.VarChar(255)
  realName       String?   @map("real_name") @db.VarChar(255)
  email          String?   @db.VarChar(255)
  avatarUrl      String?   @map("avatar_url") @db.Text
  isBot          Boolean   @default(false) @map("is_bot")
  isAdmin        Boolean   @default(false) @map("is_admin")
  lastSyncedAt   DateTime? @map("last_synced_at") @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([slackTeamId])
  @@index([userId])
  @@index([organizationId])
  @@map("slack_users")
}

/// SlackWorkspace - Maps Slack workspaces to internal Organizations
model SlackWorkspace {
  id                  String    @id @default(cuid())
  slackTeamId         String    @unique @map("slack_team_id")
  slackTeamName       String    @map("slack_team_name") @db.VarChar(255)
  organizationId      String    @map("organization_id") @db.Uuid
  accessToken         String?   @map("access_token") @db.Text
  botUserId           String?   @map("bot_user_id") @db.VarChar(100)
  botAccessToken      String?   @map("bot_access_token") @db.Text
  installerUserId     String?   @map("installer_user_id") @db.VarChar(100)
  appId               String?   @map("app_id") @db.VarChar(100)
  enterpriseId        String?   @map("enterprise_id") @db.VarChar(100)
  enterpriseName      String?   @map("enterprise_name") @db.VarChar(255)
  isEnterpriseInstall Boolean   @default(false) @map("is_enterprise_install")
  scopes              String[]  @default([])
  status              String    @default("active") @db.VarChar(50)
  lastSyncedAt        DateTime? @map("last_synced_at") @db.Timestamptz(6)
  installedAt         DateTime  @default(now()) @map("installed_at") @db.Timestamptz(6)
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([status])
  @@map("slack_workspaces")
}

// ============================================================================
// MARKETPLACE HUB TABLES (External marketplace integrations)
// ============================================================================

/// ExternalMarketplaceCredential - Store API keys for external marketplaces
/// Supports: Smithery, LangChain Hub, Civitai, ComfyUI, etc.
model ExternalMarketplaceCredential {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  source       String    @db.VarChar(50) // smithery, langchain-hub, civitai, comfyui, etc.
  apiKey       String?   @map("api_key") @db.Text // Encrypted
  accessToken  String?   @map("access_token") @db.Text // Encrypted
  refreshToken String?   @map("refresh_token") @db.Text // Encrypted
  expiresAt    DateTime? @map("expires_at") @db.Timestamptz(6)

  enabled  Boolean @default(true)
  metadata Json    @default("{}") @db.JsonB

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, source])
  @@index([organizationId])
  @@index([source])
  @@map("external_marketplace_credentials")
}

/// InstallationQueue - Track installation requests from external marketplaces
/// Supports: Smithery, ComfyUI, LangChain Hub, etc.
model InstallationQueue {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  source   String @db.VarChar(50) // smithery, comfyui, langchain-hub, etc.
  itemId   String @map("item_id") @db.VarChar(255)
  itemName String @map("item_name") @db.VarChar(255)
  itemType String @map("item_type") @db.VarChar(50) // mcp_server, workflow, prompt, node, etc.

  status String  @default("pending") @db.VarChar(50) // pending, installing, completed, failed, cancelled
  config Json?   @db.JsonB
  error  String? @db.Text
  result Json?   @db.JsonB // Installation result data

  // Who requested
  requestedBy String   @map("requested_by") @db.Uuid // User or Agent ID
  requestedAt DateTime @default(now()) @map("requested_at") @db.Timestamptz(6)

  // Approval workflow (for recommend mode)
  requiresApproval Boolean   @default(false) @map("requires_approval")
  approvedBy       String?   @map("approved_by") @db.Uuid
  approvedAt       DateTime? @map("approved_at") @db.Timestamptz(6)
  rejectedBy       String?   @map("rejected_by") @db.Uuid
  rejectedAt       DateTime? @map("rejected_at") @db.Timestamptz(6)
  rejectionReason  String?   @map("rejection_reason") @db.Text

  // Completion
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)
  extensionId String?   @map("extension_id") @db.Uuid // Created extension ID

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, status])
  @@index([organizationId, createdAt(sort: Desc)])
  @@index([status])
  @@index([requestedBy])
  @@map("installation_queue")
}

// ============================================================================
// N8N WORKFLOW AUTOMATION INTEGRATION TABLES
// ============================================================================

/// N8nInstance - Per-tenant n8n container
/// Each organization gets its own isolated n8n instance
model N8nInstance {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  containerUrl   String @map("container_url") @db.Text // e.g., https://org-slug.workflows.nubabel.com
  apiKey         String @map("api_key") @db.Text // Encrypted n8n API key
  encryptionKey  String @map("encryption_key") @db.Text // N8N_ENCRYPTION_KEY (unique per tenant)
  webhookBaseUrl String @map("webhook_base_url") @db.Text // Webhook URL base

  status String @default("provisioning") @map("status") @db.VarChar(50) // provisioning, active, stopped, failed
  config Json   @default("{}") @map("config") @db.JsonB // Additional config

  lastHealthCheck DateTime? @map("last_health_check") @db.Timestamptz(6)
  errorMessage    String?   @map("error_message") @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  workflows    N8nWorkflow[]
  credentials  N8nCredential[]

  @@unique([organizationId])
  @@index([status])
  @@map("n8n_instances")
}

/// N8nWorkflow - Workflow references with categorization
/// Synced from n8n instance, can be registered as orchestrator skills
model N8nWorkflow {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  instanceId     String @map("instance_id") @db.Uuid

  n8nWorkflowId String   @map("n8n_workflow_id") @db.VarChar(255) // ID in n8n's database
  name          String   @db.VarChar(255)
  description   String?  @db.Text
  category      String   @default("uncategorized") @map("category") @db.VarChar(50) // automation, notification, data-sync, etc.
  tags          String[] @default([]) @db.VarChar(100)

  workflowJson Json    @map("workflow_json") @db.JsonB // Full n8n workflow JSON (synced)
  isActive     Boolean @default(false) @map("is_active")
  isSkill      Boolean @default(false) @map("is_skill") // Registered as orchestrator skill

  sopId String? @map("sop_id") @db.Uuid // Link to source SOP if converted

  syncedAt  DateTime @default(now()) @map("synced_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  instance     N8nInstance             @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  executions   N8nExecution[]
  permissions  N8nWorkflowPermission[]

  @@unique([instanceId, n8nWorkflowId])
  @@index([organizationId, category])
  @@index([isSkill])
  @@map("n8n_workflows")
}

/// N8nExecution - Execution tracking
/// Records each workflow execution with status and results
model N8nExecution {
  id         String @id @default(uuid()) @db.Uuid
  workflowId String @map("workflow_id") @db.Uuid

  n8nExecutionId String @map("n8n_execution_id") @db.VarChar(255) // ID in n8n's database
  status         String @db.VarChar(50) // waiting, running, success, error, canceled
  mode           String @db.VarChar(50) // manual, trigger, webhook, retry

  startedAt   DateTime  @map("started_at") @db.Timestamptz(6)
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)

  inputData    Json?   @map("input_data") @db.JsonB // Summary only
  outputData   Json?   @map("output_data") @db.JsonB // Summary only
  errorMessage String? @map("error_message") @db.Text

  retryOf    String? @map("retry_of") @db.Uuid // If this is a retry, link to original
  retryCount Int     @default(0) @map("retry_count")

  triggeredBy String? @map("triggered_by") @db.VarChar(255) // userId or "system" or "webhook"

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  workflow N8nWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId, status])
  @@index([startedAt])
  @@map("n8n_executions")
}

/// N8nCredential - Credential mapping
/// Maps n8n credentials to MCP connections for unified access control
model N8nCredential {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  instanceId     String @map("instance_id") @db.Uuid

  n8nCredentialId String  @map("n8n_credential_id") @db.VarChar(255) // ID in n8n's database
  mcpConnectionId String? @map("mcp_connection_id") @db.Uuid // Link to MCPConnection if mapped

  credentialType String @map("credential_type") @db.VarChar(100) // e.g., "slackApi", "notionApi", "httpHeaderAuth"
  name           String @db.VarChar(255) // Display name

  syncedAt  DateTime @default(now()) @map("synced_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  instance     N8nInstance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@unique([instanceId, n8nCredentialId])
  @@index([organizationId])
  @@map("n8n_credentials")
}

/// N8nWorkflowPermission - Agent-based access control
/// Controls which agents can view/execute/edit workflows
model N8nWorkflowPermission {
  id         String @id @default(uuid()) @db.Uuid
  workflowId String @map("workflow_id") @db.Uuid

  agentId String? @map("agent_id") @db.Uuid // If assigned to specific agent
  roleId  String? @map("role_id") @db.VarChar(50) // If assigned to role (admin, member, viewer)

  canView    Boolean @default(true) @map("can_view")
  canExecute Boolean @default(false) @map("can_execute")
  canEdit    Boolean @default(false) @map("can_edit")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  workflow N8nWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([workflowId, agentId])
  @@unique([workflowId, roleId])
  @@map("n8n_workflow_permissions")
}

// ============================================================================
// KNOWLEDGE GRAPH & MEMORY SYSTEM
// ============================================================================

/// KnowledgeNode - Nodes in the knowledge graph
/// Represents entities, concepts, documents, or any knowledge unit
model KnowledgeNode {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  type        String  @db.VarChar(100) // entity, concept, document, task, person, etc.
  name        String  @db.VarChar(500)
  description String? @db.Text
  metadata    Json    @default("{}") @db.JsonB // Flexible additional data

  // Vector embedding for semantic search (stored as JSON array of floats)
  embedding Json? @db.JsonB // [0.1, 0.2, ...] float vector

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization  Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  outgoingEdges KnowledgeEdge[] @relation("SourceNode")
  incomingEdges KnowledgeEdge[] @relation("TargetNode")

  @@index([organizationId, type])
  @@index([organizationId, name])
  @@map("knowledge_nodes")
}

/// KnowledgeEdge - Relationships between nodes
/// Weighted, typed edges connecting knowledge nodes
model KnowledgeEdge {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  sourceNodeId String @map("source_node_id") @db.Uuid
  targetNodeId String @map("target_node_id") @db.Uuid

  relationshipType String @map("relationship_type") @db.VarChar(100) // related_to, parent_of, depends_on, mentions, etc.
  weight           Float  @default(1.0) @db.Real // Strength of relationship (0.0-1.0)
  metadata         Json   @default("{}") @db.JsonB

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sourceNode   KnowledgeNode @relation("SourceNode", fields: [sourceNodeId], references: [id], onDelete: Cascade)
  targetNode   KnowledgeNode @relation("TargetNode", fields: [targetNodeId], references: [id], onDelete: Cascade)

  @@unique([sourceNodeId, targetNodeId, relationshipType])
  @@index([organizationId])
  @@index([sourceNodeId])
  @@index([targetNodeId])
  @@index([relationshipType])
  @@map("knowledge_edges")
}

/// KnowledgeCluster - Groups of related nodes
/// For organizing and navigating the knowledge graph
model KnowledgeCluster {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  name        String   @db.VarChar(255)
  description String?  @db.Text
  nodeIds     String[] @map("node_ids") @db.Uuid // Array of node IDs in this cluster

  // Centroid vector for the cluster (averaged embeddings)
  centroid Json? @db.JsonB // [0.1, 0.2, ...] float vector

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("knowledge_clusters")
}

/// EntityMemory - Memory about specific entities
/// Short-term, context-specific memory for entities
model EntityMemory {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  entityType String @map("entity_type") @db.VarChar(100) // agent, user, project, task, etc.
  entityId   String @map("entity_id") @db.Uuid

  memoryType String @map("memory_type") @db.VarChar(100) // preference, context, state, note, etc.
  content    String @db.Text
  metadata   Json   @default("{}") @db.JsonB

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  expiresAt DateTime? @map("expires_at") @db.Timestamptz(6) // Optional expiration

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, entityType, entityId])
  @@index([expiresAt]) // For cleanup of expired memories
  @@map("entity_memories")
}

/// Memory - Long-term memory storage
/// Episodic, semantic, and procedural memory for the system
model Memory {
  id             String  @id @default(uuid()) @db.Uuid
  organizationId String  @map("organization_id") @db.Uuid
  userId         String? @map("user_id") @db.Uuid // Optional: memory specific to a user

  type String @db.VarChar(50) // episodic (events), semantic (facts), procedural (how-tos)

  content   String @db.Text
  embedding Json?  @db.JsonB // [0.1, 0.2, ...] float vector for semantic search

  // Memory strength metrics
  importance     Float    @default(0.5) @db.Real // 0.0-1.0
  accessCount    Int      @default(0) @map("access_count")
  lastAccessedAt DateTime @default(now()) @map("last_accessed_at") @db.Timestamptz(6)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, type])
  @@index([organizationId, userId])
  @@index([importance])
  @@index([lastAccessedAt])
  @@map("memories")
}
