# OMC Approval Matrix for Nubabel
# Defines approval thresholds, approvers, and escalation rules

version: "1.0"
description: "Unified approval matrix merging Nubabel SOP with OMC tier-based authority"

# Tier Authority (from OMC pattern)
tier_authority:
  HIGH:
    model: opus
    budget_authority: "> 10,000,000 KRW"
    approval_rights: final
    escalation_target: "C-Level / Board"

  MEDIUM:
    model: sonnet
    budget_authority: "1,000,000 - 10,000,000 KRW"
    approval_rights: conditional
    escalation_target: HIGH

  LOW:
    model: haiku
    budget_authority: "< 1,000,000 KRW"
    approval_rights: none
    escalation_target: MEDIUM

# Approval Thresholds
thresholds:
  # Expense Approvals
  expense:
    - type: self_approve
      max_amount: 1000000
      approver: self
      timeout_hours: 0
      test_command: 'echo "auto-approved"'

    - type: team_lead
      min_amount: 1000000
      max_amount: 5000000
      approver: team_lead
      timeout_hours: 24
      escalation: director
      test_command: 'cat .omc/state/approvals.json | jq ".pending"'

    - type: director
      min_amount: 5000000
      max_amount: 10000000
      approver: director
      timeout_hours: 48
      escalation: c_level
      test_command: 'cat .omc/state/approvals.json | jq ".pending"'

    - type: c_level
      min_amount: 10000000
      approver: c_level
      timeout_hours: 72
      escalation: board
      test_command: 'cat .omc/state/approvals.json | jq ".pending"'

  # Content Publishing
  content_publish:
    - type: internal
      audience: internal
      approver: team_lead
      timeout_hours: 12
      test_command: 'npm run test:content'

    - type: external
      audience: external
      approver: [director, legal]
      timeout_hours: 48
      requires_legal: true
      test_command: 'npm run test:content'

  # Process Changes
  process_change:
    - type: minor
      impact: low
      approver: owner
      timeout_hours: 24
      test_command: 'git diff --stat'

    - type: major
      impact: high
      approver: architect_tier
      timeout_hours: 72
      requires_review: true
      test_command: 'npm run test && npm run typecheck'

  # Code Changes
  code_change:
    - type: hotfix
      urgency: critical
      approver: tech_lead
      timeout_hours: 1
      bypass_review: false

    - type: feature
      urgency: normal
      approver: tech_lead
      timeout_hours: 24
      requires_review: true

    - type: architecture
      urgency: normal
      approver: architect
      timeout_hours: 72
      requires_review: true
      requires_design_doc: true

# Escalation Rules (from Nubabel SOP pattern)
escalation:
  timeout_behavior: escalate
  max_escalation_levels: 3
  notification_channels:
    - slack: "#approvals"
    - email: true

  fallback_approvers:
    team_lead: director
    director: c_level
    c_level: board
    architect: c_level

# Slack Integration (for Nubabel)
slack_integration:
  enabled: true
  approval_channel: "#approvals"
  test_channel: "#it-test"
  mention_format: "@{approver}"

  message_templates:
    request: |
      :memo: *Approval Request*
      Type: {type}
      Amount: {amount}
      Requester: {requester}
      Deadline: {deadline}

    reminder: |
      :alarm_clock: *Approval Reminder*
      Request: {request_id}
      Time remaining: {time_remaining}

    escalation: |
      :rotating_light: *Escalated Approval*
      Original approver: {original_approver}
      Escalated to: {escalated_to}
      Reason: Timeout after {timeout_hours}h
