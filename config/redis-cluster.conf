# =============================================================================
# Redis Cluster Configuration for Nubabel
# =============================================================================
# Deploy a 6-node Redis Cluster: 3 masters + 3 replicas.
# Each master handles a subset of the 16384 hash slots.
#
# Usage:
#   redis-server /path/to/redis-cluster.conf
#
# Cluster creation (one-time):
#   redis-cli --cluster create \
#     node1:6380 node2:6380 node3:6380 \
#     node4:6380 node5:6380 node6:6380 \
#     --cluster-replicas 1
#
# Typical deployment:
#   - 3 master nodes on separate hosts
#   - 3 replica nodes (1 per master) on separate hosts
#   - Automatic slot migration on node failure
# =============================================================================

# Network
port 6380
bind 0.0.0.0
protected-mode no

# =============================================================================
# Cluster Settings
# =============================================================================

cluster-enabled yes
cluster-config-file nodes-6380.conf
cluster-node-timeout 15000

# Allow reads from replicas (for read scaling)
cluster-allow-reads-when-down no
cluster-allow-pubsubshard-when-down no

# Minimum replicas required for a master to accept writes
cluster-migration-barrier 1

# =============================================================================
# Persistence (RDB + AOF)
# =============================================================================

# RDB snapshots
save 900 1
save 300 10
save 60 10000
rdbcompression yes
rdbchecksum yes
dbfilename dump-6380.rdb

# AOF (Append Only File)
appendonly yes
appendfilename "appendonly-6380.aof"
appendfsync everysec
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# =============================================================================
# Memory
# =============================================================================

maxmemory 2gb
maxmemory-policy allkeys-lru
maxmemory-samples 10

# Active defrag (Redis 4+)
activedefrag yes
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 1
active-defrag-cycle-max 25

# =============================================================================
# Performance
# =============================================================================

# TCP backlog
tcp-backlog 511
tcp-keepalive 300

# Event handling
timeout 0

# I/O threads (Redis 6+)
io-threads 4
io-threads-do-reads yes

# Lazy free (async deletion for large keys)
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
lazyfree-lazy-user-del yes
lazyfree-lazy-user-flush yes

# =============================================================================
# Logging
# =============================================================================

loglevel notice
logfile "/var/log/redis/redis-cluster-6380.log"

# =============================================================================
# Security
# =============================================================================

# Authentication (uncomment for production)
# requirepass YOUR_CLUSTER_PASSWORD
# masterauth YOUR_CLUSTER_PASSWORD

# Disable dangerous commands in production
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command DEBUG ""

# =============================================================================
# Slow Log
# =============================================================================

slowlog-log-slower-than 10000
slowlog-max-len 128

# =============================================================================
# Client Output Buffer Limits
# =============================================================================

client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# =============================================================================
# Data Directory
# =============================================================================

dir /var/lib/redis/cluster-6380

# =============================================================================
# Environment-specific overrides
# =============================================================================
# Override via environment variables or include files:
#
# Railway/Docker deployment:
#   REDIS_CLUSTER_NODES=node1:6380,node2:6380,node3:6380
#   REDIS_CLUSTER_PASSWORD=secret
#
# Connection from Node.js (ioredis):
#   const cluster = new Redis.Cluster([
#     { host: "node1", port: 6380 },
#     { host: "node2", port: 6380 },
#     { host: "node3", port: 6380 },
#   ], {
#     redisOptions: { password: "secret" },
#     scaleReads: "slave",
#   });
